<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>ä¸€æ–‡ææ‡‚ VictoriaMetrics çš„ä½¿ç”¨-é˜³æ˜çš„åšå®¢|Kubernetes|Istio|Prometheus|Python|Golang|äº‘åŸç”Ÿ</title>
  <meta property="og:title" content="ä¸€æ–‡ææ‡‚ VictoriaMetrics çš„ä½¿ç”¨" />
  <meta name="twitter:title" content="ä¸€æ–‡ææ‡‚ VictoriaMetrics çš„ä½¿ç”¨" />

  <meta name="description" content="æˆ‘ä»¬äº†è§£äº† Prometheus çš„ä½¿ç”¨ï¼Œäº†è§£äº†åŸºæœ¬çš„ PromQL è¯­å¥ä»¥åŠç»“åˆ Grafana æ¥è¿›è¡Œç›‘æ§å›¾è¡¨å±•ç¤ºï¼Œé€šè¿‡ Alertmanager æ¥è¿›è¡ŒæŠ¥è­¦ï¼Œè¿™äº›å·¥å…·ç»“åˆèµ·æ¥å·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ­å»ºä¸€å¥—æ¯”è¾ƒå®Œæ•´çš„ç›‘æ§æŠ¥è­¦ç³»ç»Ÿäº†ï¼Œä½¿ç”¨ Kube Prometheus è¿˜å¯ä»¥æ­å»ºä¸€ç«™å¼çš„ Kubernetes é›†ç¾¤ç›‘æ§ä½“ç³»ï¼Œä½†æ˜¯å¯¹äºç”Ÿäº§ç¯å¢ƒæ¥è¯´åˆ™è¿˜æœ‰è®¸å¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚
å•å°çš„ Prometheus å­˜åœ¨å•ç‚¹æ•…éšœçš„é£é™©ï¼Œéšç€ç›‘æ§è§„æ¨¡çš„æ‰©å¤§ï¼ŒPrometheus äº§ç”Ÿçš„æ•°æ®é‡ä¹Ÿä¼šéå¸¸å¤§ï¼Œæ€§èƒ½å’Œå­˜å‚¨éƒ½ä¼šé¢ä¸´é—®é¢˜ã€‚æ¯‹åº¸ç½®ç–‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¥—é«˜å¯ç”¨çš„é«˜æ€§èƒ½çš„ Prometheus é›†ç¾¤ã€‚">
  <meta property="og:description" content="æˆ‘ä»¬äº†è§£äº† Prometheus çš„ä½¿ç”¨ï¼Œäº†è§£äº†åŸºæœ¬çš„ PromQL è¯­å¥ä»¥åŠç»“åˆ Grafana æ¥è¿›è¡Œç›‘æ§å›¾è¡¨å±•ç¤ºï¼Œé€šè¿‡ Alertmanager æ¥è¿›è¡ŒæŠ¥è­¦ï¼Œè¿™äº›å·¥å…·ç»“åˆèµ·æ¥å·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ­å»ºä¸€å¥—æ¯”è¾ƒå®Œæ•´çš„ç›‘æ§æŠ¥è­¦ç³»ç»Ÿäº†ï¼Œä½¿ç”¨ Kube Prometheus è¿˜å¯ä»¥æ­å»ºä¸€ç«™å¼çš„ Kubernetes é›†ç¾¤ç›‘æ§ä½“ç³»ï¼Œä½†æ˜¯å¯¹äºç”Ÿäº§ç¯å¢ƒæ¥è¯´åˆ™è¿˜æœ‰è®¸å¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚
å•å°çš„ Prometheus å­˜åœ¨å•ç‚¹æ•…éšœçš„é£é™©ï¼Œéšç€ç›‘æ§è§„æ¨¡çš„æ‰©å¤§ï¼ŒPrometheus äº§ç”Ÿçš„æ•°æ®é‡ä¹Ÿä¼šéå¸¸å¤§ï¼Œæ€§èƒ½å’Œå­˜å‚¨éƒ½ä¼šé¢ä¸´é—®é¢˜ã€‚æ¯‹åº¸ç½®ç–‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¥—é«˜å¯ç”¨çš„é«˜æ€§èƒ½çš„ Prometheus é›†ç¾¤ã€‚">
  <meta name="twitter:description" content="æˆ‘ä»¬äº†è§£äº† Prometheus çš„ä½¿ç”¨ï¼Œäº†è§£äº†åŸºæœ¬çš„ PromQL è¯­å¥ä»¥åŠç»“åˆ Grafana æ¥è¿›è¡Œç›‘æ§å›¾è¡¨å±•ç¤ºï¼Œé€šè¿‡ Alertmanager æ¥è¿›è¡ŒæŠ¥è­¦ï¼Œè¿™äº›å·¥å…·ç»“åˆèµ·æ¥å·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ­å»ºä¸€å¥—æ¯”è¾ƒå®Œæ•´çš„ç›‘æ§æŠ¥è­¦ç³»ç»Ÿäº†ï¼Œä½¿ç”¨ Kube Prometheus è¿˜å¯ä»¥æ­å»ºä¸€ç«™å¼çš„ Kubernetes é›†ç¾¤ç›‘æ§ä½“ç³»ï¼Œä½†æ˜¯å¯¹äºç”Ÿäº§ç¯å¢ƒæ¥è¯´åˆ™è¿˜æœ‰è®¸å¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚
å•å°çš„ Prometheus â€¦">
  <meta name="author" content=""/>
  <link href="https://picdn.youdianzhishi.com/images/blog-favicon.png" rel="icon" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://picdn.youdianzhishi.com/images/blog-favicon.png"/>
  <meta property="og:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://www.qikqiak.com/post/victoriametrics-usage/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="é˜³æ˜çš„åšå®¢" />

  <link rel="canonical" href="https://www.qikqiak.com/post/victoriametrics-usage/" />
  <link rel="alternate" href="https://www.qikqiak.com/index.xml" type="application/rss+xml" title="é˜³æ˜çš„åšå®¢">

  
  
  <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700%7COpen+Sans:400,700" rel="stylesheet">
  

  <link rel="stylesheet" href='https://www.qikqiak.com/css/bundle.min.a6b62363fe57848ad01efa2a5d1bbb1047c2ffb71b53d8aeb42bc5ed5c77ea7c.css' integrity='sha256-prYjY/5XhIrQHvoqXRu7EEfC/7cbU9iutCvF7Vx36nw='>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
  
  
    
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <![endif]-->
<meta name="google-site-verification" content="oKxX4fOvB2yYmU02txZFChM93XQbESU4JaG3tNH9Hm8" />
<meta name="baidu-site-verification" content="F5ojAyqaKU" />
<meta name="keywords" content="prometheus, é«˜å¯ç”¨, kubernetes, VictoriaMetrics, ç”Ÿäº§ç¯å¢ƒ">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d611849735f187dd788dc054908f7d7a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69668147-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">åˆ‡æ¢å¯¼èˆª</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.qikqiak.com/" title="é˜³æ˜çš„åšå®¢">
        <img src="https://picdn.youdianzhishi.com/images/blog-logo-new.png" style="margin-top: -5px;height: 32px;" alt="é˜³æ˜çš„åšå®¢">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="é¦–é¡µ" href="https://www.qikqiak.com/">é¦–é¡µ</a>
            </li>
          
        
          
            <li>
              <a title="è¯¾ç¨‹" href="https://youdianzhishi.com/?utm_source=blog&amp;utm_campaign=referral&amp;utm_medium=topmenu">è¯¾ç¨‹</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">æ–‡ç« åˆ†ç±»</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/archives">Archive</a>
                
                  <a href="https://www.qikqiak.com/tags">tags</a>
                
                  <a href="https://www.qikqiak.com/tags/kubernetes">kubernetes</a>
                
                  <a href="https://www.qikqiak.com/tags/python">python</a>
                
                  <a href="https://www.qikqiak.com/tags/django">django</a>
                
                  <a href="https://www.qikqiak.com/tags/devops">devops</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">ä¹¦ç±</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/k8s-book/">k8sè¿›é˜¶æ‰‹å†Œ</a>
                
                  <a href="https://www.qikqiak.com/istio-book/">ä¸€èµ·å­¦istio</a>
                
                  <a href="https://www.qikqiak.com/tdd-book/">Pythonå¾®æœåŠ¡</a>
                
                  <a href="https://md.qikqiak.com/">Markdownå¾®ä¿¡</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="å…³äº" href="https://www.qikqiak.com/page/about/">å…³äº</a>
            </li>
          
        
          
            <li>
              <a title="RSS" href="https://www.qikqiak.com/index.xml">RSS</a>
            </li>
          
        

        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          

      </ul>
    </div>

  </div>
</nav>


  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">æœç´¢</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script src="https://www.qikqiak.com/js/algoliasearch.min.js"></script>
<script src="https://www.qikqiak.com/js/autocomplete.min.js"></script>

<script>
var client = algoliasearch("1JDRAS0AZR", "8804ac109158bb3bb60d74ce98fa332f");
var index = client.initIndex('prod_blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            return '<span>' + '<a href="https://www.qikqiak.com/post/' + suggestion.slug + '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>

    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://picdn.youdianzhishi.com/images/1690111931596.jpg" data-img-desc-1="victorialmetrics"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>ä¸€æ–‡ææ‡‚ VictoriaMetrics çš„ä½¿ç”¨</h1>
                  
                  
                    <span class="post-meta">
  å‘è¡¨äº July 23, 2023  
</span>

                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>ä¸€æ–‡ææ‡‚ VictoriaMetrics çš„ä½¿ç”¨</h1>
                
                
                  <span class="post-meta">
  å‘è¡¨äº July 23, 2023  
</span>

                
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </header>


    



<div class="container" role="main">
  <div class="row">

    
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div>
            
            
            <h5 id="tags" style="margin-top: 30px;">æ ‡ç­¾:
              
                  <a href="https://www.qikqiak.com/tags/prometheus/">prometheus</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/kubernetes/">kubernetes</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/victoriametrics/">VictoriaMetrics</a> &nbsp;
              
            </h5>
            
        </div>
  
        <article role="main" class="blog-post" itemprop="articleBody" id="content">
          
            
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#é«˜å¯ç”¨æ€§">é«˜å¯ç”¨æ€§</a></li>
    <li><a href="#victoriametrics-ç®€ä»‹">VictoriaMetrics ç®€ä»‹</a></li>
    <li><a href="#æ¶æ„">æ¶æ„</a></li>
    <li><a href="#å•èŠ‚ç‚¹">å•èŠ‚ç‚¹</a>
      <ul>
        <li><a href="#è¿œç¨‹å­˜å‚¨-victoriametrics">è¿œç¨‹å­˜å‚¨ VictoriaMetrics</a></li>
        <li><a href="#æ›¿æ¢-prometheus">æ›¿æ¢ Prometheus</a></li>
        <li><a href="#ui-ç•Œé¢">UI ç•Œé¢</a></li>
      </ul>
    </li>
    <li><a href="#é›†ç¾¤ç‰ˆ">é›†ç¾¤ç‰ˆ</a></li>
    <li><a href="#vmagent">vmagent</a></li>
    <li><a href="#vmalert">vmalert</a>
      <ul>
        <li><a href="#ç‰¹æ€§">ç‰¹æ€§</a></li>
        <li><a href="#å®‰è£…">å®‰è£…</a></li>
      </ul>
    </li>
    <li><a href="#victoriametrics-operator">VictoriaMetrics Operator</a>
      <ul>
        <li><a href="#å®‰è£…-1">å®‰è£…</a></li>
        <li><a href="#å®‰è£…-vm-é›†ç¾¤">å®‰è£… VM é›†ç¾¤</a></li>
        <li><a href="#éªŒè¯-vm-é›†ç¾¤">éªŒè¯ VM é›†ç¾¤</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>

          
  
          
          
          
  
          
          
          
  
          
          
          

          <p>æˆ‘ä»¬äº†è§£äº† Prometheus çš„ä½¿ç”¨ï¼Œäº†è§£äº†åŸºæœ¬çš„ PromQL è¯­å¥ä»¥åŠç»“åˆ Grafana æ¥è¿›è¡Œç›‘æ§å›¾è¡¨å±•ç¤ºï¼Œé€šè¿‡ Alertmanager æ¥è¿›è¡ŒæŠ¥è­¦ï¼Œè¿™äº›å·¥å…·ç»“åˆèµ·æ¥å·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ­å»ºä¸€å¥—æ¯”è¾ƒå®Œæ•´çš„ç›‘æ§æŠ¥è­¦ç³»ç»Ÿäº†ï¼Œä½¿ç”¨ Kube Prometheus è¿˜å¯ä»¥æ­å»ºä¸€ç«™å¼çš„ Kubernetes é›†ç¾¤ç›‘æ§ä½“ç³»ï¼Œä½†æ˜¯å¯¹äºç”Ÿäº§ç¯å¢ƒæ¥è¯´åˆ™è¿˜æœ‰è®¸å¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚</p>
<p>å•å°çš„ Prometheus å­˜åœ¨å•ç‚¹æ•…éšœçš„é£é™©ï¼Œéšç€ç›‘æ§è§„æ¨¡çš„æ‰©å¤§ï¼ŒPrometheus äº§ç”Ÿçš„æ•°æ®é‡ä¹Ÿä¼šéå¸¸å¤§ï¼Œæ€§èƒ½å’Œå­˜å‚¨éƒ½ä¼šé¢ä¸´é—®é¢˜ã€‚æ¯‹åº¸ç½®ç–‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¥—é«˜å¯ç”¨çš„é«˜æ€§èƒ½çš„ Prometheus é›†ç¾¤ã€‚</p>
<h2 id="é«˜å¯ç”¨æ€§">é«˜å¯ç”¨æ€§</h2>
<p>æˆ‘ä»¬çŸ¥é“ Prometheus æ˜¯é‡‡ç”¨çš„ Pull æœºåˆ¶è·å–ç›‘æ§æ•°æ®ï¼Œå³ä½¿ä½¿ç”¨ <code>Push Gateway</code> å¯¹äº Prometheus ä¹Ÿæ˜¯ Pullï¼Œä¸ºäº†ç¡®ä¿ Prometheus æœåŠ¡çš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬åªéœ€è¦éƒ¨ç½²å¤šä¸ª Prometheus å®ä¾‹ï¼Œç„¶åé‡‡é›†ç›¸åŒçš„ metrics æ•°æ®å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha1.png" alt="prometheus ha1"></p>
<p>è¿™ä¸ªæ–¹å¼æ¥æ»¡è¶³æœåŠ¡çš„å¯ç”¨æ€§åº”è¯¥æ˜¯å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨å¾—æœ€å¤šçš„ä¸€ç§æ–¹å¼ï¼Œå½“ä¸€ä¸ªå®ä¾‹æŒ‚æ‰åä» LB é‡Œé¢è‡ªåŠ¨å‰”é™¤æ‰ï¼Œè€Œä¸”è¿˜æœ‰è´Ÿè½½å‡è¡¡çš„ä½œç”¨ï¼Œå¯ä»¥é™ä½ä¸€ä¸ª Prometheus çš„å‹åŠ›ï¼Œä½†è¿™ç§æ¨¡å¼ç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾çš„ï¼Œå°±æ˜¯ä¸æ»¡è¶³æ•°æ®ä¸€è‡´æ€§ä»¥åŠæŒä¹…åŒ–é—®é¢˜ï¼Œå› ä¸º Prometheus æ˜¯ Pull çš„æ–¹å¼ï¼Œå³ä½¿å¤šä¸ªå®ä¾‹æŠ“å–çš„æ˜¯ç›¸åŒçš„ç›‘æ§æŒ‡æ ‡ï¼Œä¹Ÿä¸èƒ½ä¿è¯æŠ“å–è¿‡æ¥çš„å€¼å°±æ˜¯ä¸€è‡´çš„ï¼Œæ›´ä½•å†µåœ¨å®é™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­è¿˜ä¼šé‡åˆ°ä¸€äº›ç½‘ç»œå»¶è¿Ÿé—®é¢˜ï¼Œæ‰€ä»¥ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä¸è¿‡å¯¹äºç›‘æ§æŠ¥è­¦è¿™ä¸ªåœºæ™¯æ¥è¯´ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šè¦æ±‚æ•°æ®å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼ä»ä¸šåŠ¡ä¸Šæ¥è¯´æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºè¿™ç§æ•°æ®ä¸ä¸€è‡´æ€§å½±å“åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆå½±å“ã€‚è¿™ç§åœºæ™¯é€‚åˆç›‘æ§è§„æ¨¡ä¸å¤§ï¼Œåªéœ€è¦ä¿å­˜çŸ­å‘¨æœŸç›‘æ§æ•°æ®çš„åœºæ™¯ã€‚</p>
<p><strong>æ•°æ®æŒä¹…åŒ–</strong></p>
<p>ä½¿ç”¨ä¸Šé¢çš„åŸºæœ¬ HA çš„æ¨¡å¼åŸºæœ¬ä¸Šæ˜¯å¯ä»¥æ»¡è¶³ç›‘æ§è¿™ä¸ªåœºæ™¯ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªæ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªå®ä¾‹æ•°æ®ä¸¢äº†å°±æ²¡åŠæ³•å‘¢æ¢å¤å›æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä¸º Prometheus æ·»åŠ è¿œç¨‹å­˜å‚¨æ¥ä¿è¯æ•°æ®æŒä¹…åŒ–ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha2.png" alt="prometheus ha2"></p>
<p>åœ¨ç»™ Prometheus é…ç½®ä¸Šè¿œç¨‹å­˜å‚¨è¿‡åï¼Œæˆ‘ä»¬å°±ä¸ç”¨æ‹…å¿ƒæ•°æ®ä¸¢å¤±çš„é—®é¢˜äº†ï¼Œå³ä½¿å½“ä¸€ä¸ª Prometheus å®ä¾‹å®•æœºæˆ–è€…æ•°æ®ä¸¢å¤±è¿‡åï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿œç¨‹å­˜å‚¨çš„æ•°æ®è¿›è¡Œæ¢å¤ã€‚</p>
<p><strong>é€šè¿‡é”è·å– Leader</strong></p>
<p>å…¶å®ä¸Šé¢çš„åŸºæœ¬ HA åŠ ä¸Šè¿œç¨‹å­˜å‚¨çš„æ–¹å¼åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ Prometheus çš„é«˜å¯ç”¨äº†ï¼Œè¿™ç§æ–¹å¼çš„å¤šä¸ª Prometheus å®ä¾‹éƒ½ä¼šå»å®šæ—¶æ‹‰å–ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œç„¶åå°†çƒ­æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç„¶åå†·æ•°æ®åŒæ­¥åˆ°è¿œç¨‹å­˜å‚¨ä¸­å»ï¼Œå¯¹äºå¤§å‹é›†ç¾¤æ¥è¯´é¢‘ç¹çš„å»æ‹‰å–æŒ‡æ ‡æ•°æ®åŠ¿å¿…ä¼šå¯¹ç½‘ç»œé€ æˆæ›´å¤§çš„å‹åŠ›ã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿé€šè¿‡æœåŠ¡æ³¨å†Œçš„æ–¹å¼æ¥å®ç° Prometheus çš„é«˜å¯ç”¨æ€§ï¼Œé›†ç¾¤å¯åŠ¨çš„æ—¶å€™æ¯ä¸ªèŠ‚ç‚¹éƒ½å°è¯•å»è·å–é”ï¼Œè·å–æˆåŠŸçš„èŠ‚ç‚¹æˆä¸º Leader æ‰§è¡Œä»»åŠ¡ï¼Œè‹¥ä¸»èŠ‚ç‚¹å®•æœºï¼Œä»èŠ‚ç‚¹è·å–é”æˆä¸º Leader å¹¶æ¥ç®¡æœåŠ¡ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha3.png" alt="prometheus ha3"></p>
<p>ä¸è¿‡è¿™ç§æ–¹æ¡ˆéœ€è¦æˆ‘ä»¬é€šè¿‡å»å†™ä»£ç è¿›è¡Œæ”¹é€ ï¼Œå¦‚æœåœ¨ Kubernetes ä¸­æˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨è‡ªå¸¦çš„ Lease å¯¹è±¡æ¥è·å–åˆ†å¸ƒå¼é” ğŸ”’ï¼Œè¿™ä¸æ˜¯å¾ˆå›°éš¾ï¼Œåªæ˜¯ä»¥åè¦æ›´æ–°ç‰ˆæœ¬ç¨å¾®éº»çƒ¦ç‚¹ã€‚</p>
<p>ä¸Šé¢çš„å‡ ç§æ–¹æ¡ˆåŸºæœ¬ä¸Šéƒ½å¯ä»¥æ»¡è¶³åŸºæœ¬çš„ Prometheus é«˜å¯ç”¨ï¼Œä½†æ˜¯å¯¹äºå¤§å‹é›†ç¾¤æ¥è¯´ï¼Œä¸€ä¸ª Prometheus å®ä¾‹çš„å‹åŠ›å§‹ç»ˆéå¸¸å¤§ã€‚</p>
<p><strong>è”é‚¦é›†ç¾¤</strong></p>
<p>å½“å•ä¸ª Prometheus å®ä¾‹æ— æ³•å¤„ç†å¤§é‡çš„é‡‡é›†ä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åŸºäº Prometheus è”é‚¦é›†ç¾¤çš„æ–¹å¼æ¥å°†ç›‘æ§ä»»åŠ¡åˆ’åˆ†åˆ°ä¸åŒçš„ Prometheus å®ä¾‹ä¸­å»ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/prometheus-ha4.png" alt="prometheus ha4"></p>
<p>æˆ‘ä»¬å¯ä»¥å°†ä¸åŒç±»å‹çš„é‡‡é›†ä»»åŠ¡åˆ’åˆ†åˆ°ä¸åŒçš„ Prometheus å®ä¾‹ä¸­å»æ‰§è¡Œï¼Œè¿›è¡ŒåŠŸèƒ½åˆ†ç‰‡ï¼Œæ¯”å¦‚ä¸€ä¸ª Prometheus è´Ÿè´£é‡‡é›†èŠ‚ç‚¹çš„æŒ‡æ ‡æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ª Prometheus è´Ÿè´£é‡‡é›†åº”ç”¨ä¸šåŠ¡ç›¸å…³çš„ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œæœ€ååœ¨ä¸Šå±‚é€šè¿‡ä¸€ä¸ª Prometheus å¯¹æ•°æ®è¿›è¡Œæ±‡æ€»ã€‚</p>
<p>å…·ä½“çš„é‡‡é›†ä»»åŠ¡å¦‚ä½•å»è¿›è¡Œåˆ†åŒºä¹Ÿæ²¡æœ‰å›ºå®šçš„æ ‡å‡†ï¼Œéœ€è¦ç»“åˆå®é™…çš„ä¸šåŠ¡è¿›è¡Œè€ƒè™‘ï¼Œé™¤äº†ä¸Šé¢çš„æ–¹å¼ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å•ä¸ªçš„é‡‡é›†æ•°æ®é‡å°±éå¸¸éå¸¸å¤§ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦é‡‡é›†ä¸Šä¸‡ä¸ªèŠ‚ç‚¹çš„ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œè¿™ç§æƒ…å†µå³ä½¿æˆ‘ä»¬å·²ç»è¿›è¡Œäº†åˆ†åŒºï¼Œä½†æ˜¯å¯¹äºå•ä¸ª Prometheus æ¥è¯´å‹åŠ›ä¹Ÿæ˜¯éå¸¸å¤§çš„ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦æŒ‰ç…§ä»»åŠ¡çš„ä¸åŒå®ä¾‹è¿›è¡Œåˆ’åˆ†ï¼Œæˆ‘ä»¬é€šè¿‡ Prometheus çš„ <code>relabel</code> åŠŸèƒ½ï¼Œé€šè¿‡ hash å–æ¨¡çš„æ–¹å¼å¯ä»¥ç¡®ä¿å½“å‰ Prometheus åªé‡‡é›†å½“å‰ä»»åŠ¡çš„ä¸€éƒ¨åˆ†å®ä¾‹çš„ç›‘æ§æŒ‡æ ‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># çœç•¥å…¶ä»–é…ç½®......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">relabel_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">source_labels</span>: [__address__]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">modulus</span>: <span style="color:#bd93f9">4</span> <span style="color:#6272a4"># å°†èŠ‚ç‚¹åˆ†ç‰‡æˆ 4 ä¸ªç»„</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">target_label</span>: __tmp_hash
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">action</span>: hashmod
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">source_labels</span>: [__tmp_hash]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">regex</span>: ^1$ <span style="color:#6272a4"># åªæŠ“ç¬¬2ä¸ªç»„ä¸­èŠ‚ç‚¹çš„æ•°æ®(åºå·0ä¸ºç¬¬1ä¸ªç»„)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">action</span>: keep
</span></span></code></pre></div><p>åˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬ä¸Šå°±å®Œæˆäº† Prometheus é«˜å¯ç”¨çš„æ”¹é€ ã€‚å¯¹äºå°è§„æ¨¡é›†ç¾¤å’Œå¤§è§„æ¨¡é›†ç¾¤å¯ä»¥é‡‡ç”¨ä¸åŒçš„æ–¹æ¡ˆï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„éƒ¨åˆ†å°±æ˜¯è¿œç¨‹å­˜å‚¨ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯æ•°æ®çš„æŒä¹…åŒ–å°±å¿…é¡»ä½¿ç”¨è¿œç¨‹å­˜å‚¨ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸‹è¿œç¨‹å­˜å‚¨çš„æ–¹æ¡ˆï¼Œç›®å‰æ¯”è¾ƒæµè¡Œçš„æ–¹æ¡ˆåŒ…æ‹¬ <code>Thanos</code>ã€<code>VictoriaMetrics</code> ç­‰ã€‚</p>
<ul>
<li><a href="https://thanos.io/">Thanos</a>ï¼Œå®ƒå®Œå…¨å…¼å®¹ Prometheus APIï¼Œæä¾›ç»Ÿä¸€æŸ¥è¯¢èšåˆåˆ†å¸ƒå¼éƒ¨ç½² Prometheus æ•°æ®çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒæ•°æ®é•¿æœŸå­˜å‚¨åˆ°å„ç§å¯¹è±¡å­˜å‚¨ï¼ˆæ¯”å¦‚ S3ã€é˜¿é‡Œäº‘ OSS ç­‰ï¼‰ä»¥åŠé™ä½é‡‡æ ·ç‡æ¥åŠ é€Ÿå¤§æ—¶é—´èŒƒå›´çš„æ•°æ®æŸ¥è¯¢ã€‚</li>
<li><a href="https://victoriametrics.com/">VictoriaMetrics(VM)</a> æ˜¯ä¸€ä¸ªæ”¯æŒé«˜å¯ç”¨ã€ç»æµé«˜æ•ˆä¸”å¯æ‰©å±•çš„ç›‘æ§è§£å†³æ–¹æ¡ˆå’Œæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œå¯ç”¨äº Prometheus ç›‘æ§æ•°æ®åšé•¿æœŸè¿œç¨‹å­˜å‚¨ã€‚</li>
</ul>
<p><code>Thanos</code> åœ¨å‰é¢å‡ æœŸæˆ‘ä»¬éƒ½è®²è§£è¿‡ï¼Œä½†æ˜¯ <code>Thanos</code> ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒçš„æ¶æ„éå¸¸å¤æ‚ï¼Œä½œä¸ºç”Ÿäº§ç¯å¢ƒæ¥è¯´è°ƒä¼˜æå…¶å›°éš¾ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±ä¸å†ä»‹ç»äº†ï¼Œä¸‹é¢æˆ‘ä»¬ä¸»è¦ä»‹ç»ä¸‹ <code>VictoriaMetrics</code>ã€‚</p>
<h2 id="victoriametrics-ç®€ä»‹">VictoriaMetrics ç®€ä»‹</h2>
<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨ VictoriaMetrics å‘¢ï¼Ÿç›¸å¯¹äº Thanosï¼ŒVictoriaMetrics ä¸»è¦æ˜¯ä¸€ä¸ªå¯æ°´å¹³æ‰©å®¹çš„<strong>æœ¬åœ°å…¨é‡æŒä¹…åŒ–å­˜å‚¨æ–¹æ¡ˆ</strong>ï¼ŒVictoriaMetrics ä¸ä»…ä»…æ˜¯æ—¶åºæ•°æ®åº“ï¼Œå®ƒçš„ä¼˜åŠ¿ä¸»è¦ä½“ç°åœ¨ä¸€ä¸‹å‡ ç‚¹ã€‚</p>
<ul>
<li>
<p>å¯¹å¤–æ”¯æŒ Prometheus ç›¸å…³çš„ APIï¼Œå¯ä»¥ç›´æ¥ç”¨äº Grafana ä½œä¸º Prometheus æ•°æ®æºä½¿ç”¨</p>
</li>
<li>
<p>æŒ‡æ ‡æ•°æ®æ‘„å–å’ŒæŸ¥è¯¢å…·å¤‡é«˜æ€§èƒ½å’Œè‰¯å¥½çš„å¯æ‰©å±•æ€§ï¼Œæ€§èƒ½æ¯” InfluxDB å’Œ TimescaleDB é«˜å‡º 20 å€</p>
</li>
<li>
<p>åœ¨å¤„ç†é«˜åŸºæ•°æ—¶é—´åºåˆ—æ—¶ï¼Œå†…å­˜æ–¹é¢ä¹Ÿåšäº†ä¼˜åŒ–ï¼Œæ¯” InfluxDB å°‘ 10x å€ï¼Œæ¯” Prometheusã€Thanos æˆ– Cortex å°‘ 7 å€</p>
</li>
<li>
<p>é«˜æ€§èƒ½çš„æ•°æ®å‹ç¼©æ–¹å¼ï¼Œä¸ TimescaleDB ç›¸æ¯”ï¼Œå¯ä»¥å°†å¤šè¾¾ 70 å€çš„æ•°æ®ç‚¹å­˜å…¥æœ‰é™çš„å­˜å‚¨ç©ºé—´ï¼Œä¸ Prometheusã€Thanos æˆ– Cortex ç›¸æ¯”ï¼Œæ‰€éœ€çš„å­˜å‚¨ç©ºé—´å‡å°‘ 7 å€</p>
</li>
<li>
<p>å®ƒé’ˆå¯¹å…·æœ‰é«˜å»¶è¿Ÿ IO å’Œä½ IOPS çš„å­˜å‚¨è¿›è¡Œäº†ä¼˜åŒ–</p>
</li>
<li>
<p>æä¾›å…¨å±€çš„æŸ¥è¯¢è§†å›¾ï¼Œå¤šä¸ª Prometheus å®ä¾‹æˆ–ä»»ä½•å…¶ä»–æ•°æ®æºå¯èƒ½ä¼šå°†æ•°æ®æ‘„å–åˆ° VictoriaMetrics</p>
</li>
<li>
<p>æ“ä½œç®€å•</p>
<ul>
<li>VictoriaMetrics ç”±ä¸€ä¸ªæ²¡æœ‰å¤–éƒ¨ä¾èµ–çš„å°å‹å¯æ‰§è¡Œæ–‡ä»¶ç»„æˆ</li>
<li>æ‰€æœ‰çš„é…ç½®éƒ½æ˜¯é€šè¿‡æ˜ç¡®çš„å‘½ä»¤è¡Œæ ‡å¿—å’Œåˆç†çš„é»˜è®¤å€¼å®Œæˆçš„</li>
<li>æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨ <code>--storageDataPath</code> å‘½ä»¤è¡Œå‚æ•°æŒ‡å‘çš„ç›®å½•ä¸­</li>
<li>å¯ä»¥ä½¿ç”¨ <code>vmbackup/vmrestore</code> å·¥å…·è½»æ¾å¿«é€Ÿåœ°ä»å®æ—¶å¿«ç…§å¤‡ä»½åˆ° S3 æˆ– GCS å¯¹è±¡å­˜å‚¨ä¸­</li>
</ul>
</li>
<li>
<p>æ”¯æŒä»ç¬¬ä¸‰æ–¹æ—¶åºæ•°æ®åº“è·å–æ•°æ®æº</p>
</li>
<li>
<p>ç”±äºå­˜å‚¨æ¶æ„ï¼Œå®ƒå¯ä»¥ä¿æŠ¤å­˜å‚¨åœ¨éæ­£å¸¸å…³æœºï¼ˆå³ OOMã€ç¡¬ä»¶é‡ç½®æˆ– kill -9ï¼‰æ—¶å…å—æ•°æ®æŸå</p>
</li>
<li>
<p>åŒæ ·æ”¯æŒæŒ‡æ ‡çš„ relabel æ“ä½œ</p>
</li>
</ul>
<h2 id="æ¶æ„">æ¶æ„</h2>
<p>VM åˆ†ä¸ºå•èŠ‚ç‚¹å’Œé›†ç¾¤ä¸¤ä¸ªæ–¹æ¡ˆï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©å³å¯ã€‚å•èŠ‚ç‚¹ç‰ˆç›´æ¥è¿è¡Œä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ—¢ï¼Œå®˜æ–¹å»ºè®®é‡‡é›†æ•°æ®ç‚¹(data points)ä½äº 100w/sï¼Œæ¨è VM å•èŠ‚ç‚¹ç‰ˆï¼Œç®€å•å¥½ç»´æŠ¤ï¼Œä½†ä¸æ”¯æŒå‘Šè­¦ã€‚é›†ç¾¤ç‰ˆæ”¯æŒæ•°æ®æ°´å¹³æ‹†åˆ†ã€‚ä¸‹å›¾æ˜¯ <code>VictoriaMetrics</code> é›†ç¾¤ç‰ˆå®˜æ–¹çš„æ¶æ„å›¾ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1650529246872.jpg" alt="VMå®˜æ–¹æ¶æ„"></p>
<p>ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li><code>vmstorage</code>ï¼šæ•°æ®å­˜å‚¨ä»¥åŠæŸ¥è¯¢ç»“æœè¿”å›ï¼Œé»˜è®¤ç«¯å£ä¸º 8482</li>
<li><code>vminsert</code>ï¼šæ•°æ®å½•å…¥ï¼Œå¯å®ç°ç±»ä¼¼åˆ†ç‰‡ã€å‰¯æœ¬åŠŸèƒ½ï¼Œé»˜è®¤ç«¯å£ 8480</li>
<li><code>vmselect</code>ï¼šæ•°æ®æŸ¥è¯¢ï¼Œæ±‡æ€»å’Œæ•°æ®å»é‡ï¼Œé»˜è®¤ç«¯å£ 8481</li>
<li><code>vmagent</code>ï¼šæ•°æ®æŒ‡æ ‡æŠ“å–ï¼Œæ”¯æŒå¤šç§åç«¯å­˜å‚¨ï¼Œä¼šå ç”¨æœ¬åœ°ç£ç›˜ç¼“å­˜ï¼Œé»˜è®¤ç«¯å£ 8429</li>
<li><code>vmalert</code>ï¼šæŠ¥è­¦ç›¸å…³ç»„ä»¶ï¼Œä¸å¦‚æœä¸éœ€è¦å‘Šè­¦åŠŸèƒ½å¯ä»¥ä¸ä½¿ç”¨è¯¥ç»„ä»¶ï¼Œé»˜è®¤ç«¯å£ä¸º 8880</li>
</ul>
<p>é›†ç¾¤æ–¹æ¡ˆæŠŠåŠŸèƒ½æ‹†åˆ†ä¸º <code>vmstorage</code>ã€<code>vminsert</code>ã€<code>vmselect</code> ç»„ä»¶ï¼Œå¦‚æœè¦æ›¿æ¢ Prometheusï¼Œè¿˜éœ€è¦ä½¿ç”¨ <code>vmagent</code>ã€<code>vmalert</code>ã€‚ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹å‡º <code>vminsert</code> ä»¥åŠ <code>vmselect</code> éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥æ‰©å±•å¾ˆç®€å•ï¼Œåªæœ‰ <code>vmstorage</code> æ˜¯æœ‰çŠ¶æ€çš„ã€‚</p>
<p><code>vmagent</code> çš„ä¸»è¦ç›®çš„æ˜¯ç”¨æ¥æ”¶é›†æŒ‡æ ‡æ•°æ®ç„¶åå­˜å‚¨åˆ° VM ä»¥åŠ Prometheus å…¼å®¹çš„å­˜å‚¨ç³»ç»Ÿä¸­ï¼ˆæ”¯æŒ remote_write åè®®å³å¯ï¼‰ã€‚</p>
<!-- raw HTML omitted -->
<p>ä¸‹å›¾æ˜¯ vmagent çš„ä¸€ä¸ªç®€å•æ¶æ„å›¾ï¼Œå¯ä»¥çœ‹å‡ºè¯¥ç»„ä»¶ä¹Ÿå®ç°äº† metrics çš„ push åŠŸèƒ½ï¼Œæ­¤å¤–è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç‰¹æ€§ï¼š</p>
<ul>
<li>æ›¿æ¢ prometheus çš„ scraping target</li>
<li>æ”¯æŒåŸºäº prometheus relabeling çš„æ¨¡å¼æ·»åŠ ã€ç§»é™¤ã€ä¿®æ”¹ labelsï¼Œå¯ä»¥æ–¹ä¾¿åœ¨æ•°æ®å‘é€åˆ°è¿œç«¯å­˜å‚¨ä¹‹å‰è¿›è¡Œæ•°æ®çš„è¿‡æ»¤</li>
<li>æ”¯æŒå¤šç§æ•°æ®åè®®ï¼Œinflux line åè®®ï¼Œgraphite æ–‡æœ¬åè®®ï¼Œopentsdb åè®®ï¼Œprometheus remote write åè®®ï¼Œjson lines åè®®ï¼Œcsv æ•°æ®</li>
<li>æ”¯æŒæ”¶é›†æ•°æ®çš„åŒæ—¶ï¼Œå¹¶å¤åˆ¶åˆ°å¤šç§è¿œç«¯å­˜å‚¨ç³»ç»Ÿ</li>
<li>æ”¯æŒä¸å¯é è¿œç«¯å­˜å‚¨ï¼ˆé€šè¿‡æœ¬åœ°å­˜å‚¨ <code>-remoteWrite.tmpDataPath</code> )ï¼ŒåŒæ—¶æ”¯æŒæœ€å¤§ç£ç›˜å ç”¨</li>
<li>ç›¸æ¯” prometheus ä½¿ç”¨è¾ƒå°‘çš„å†…å­˜ã€cpuã€ç£ç›˜ io ä»¥åŠç½‘ç»œå¸¦å®½</li>
</ul>
<p><img src="https://picdn.youdianzhishi.com/images/1650529595671.jpg" alt="vmagent"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±åˆ†åˆ«æ¥ä»‹ç»äº† VM çš„å•èŠ‚ç‚¹å’Œé›†ç¾¤ä¸¤ä¸ªæ–¹æ¡ˆçš„ä½¿ç”¨ã€‚</p>
<h2 id="å•èŠ‚ç‚¹">å•èŠ‚ç‚¹</h2>
<p>è¿™é‡Œæˆ‘ä»¬é‡‡é›† node-exporter ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œé¦–å…ˆä½¿ç”¨ Prometheus é‡‡é›†æ•°æ®ï¼Œç„¶åå°† Prometheus æ•°æ®è¿œç¨‹å†™å…¥ VM è¿œç¨‹å­˜å‚¨ï¼Œç”±äº VM æä¾›äº† <code>vmagent</code> ç»„ä»¶ï¼Œæœ€åæˆ‘ä»¬ä½¿ç”¨ VM æ¥å®Œå…¨æ›¿æ¢ Prometheusï¼Œå¯ä»¥ä½¿æ¶æ„æ›´ç®€å•ã€æ›´ä½çš„èµ„æºå ç”¨ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å°†æ‰€æœ‰èµ„æºè¿è¡Œåœ¨ <code>kube-vm</code> å‘½åç©ºé—´ä¹‹ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl create ns kube-vm
</span></span></code></pre></div><p>é¦–å…ˆæˆ‘ä»¬è¿™ <code>kube-vm</code> å‘½åç©ºé—´ä¸‹é¢ä½¿ç”¨ DaemonSet æ§åˆ¶å™¨è¿è¡Œ node-exporterï¼Œå¯¹åº”çš„èµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-node-exporter.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: DaemonSet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/component</span>: exporter
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/name</span>: node-exporter
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/part-of</span>: kube-vm
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app.kubernetes.io/version</span>: <span style="color:#bd93f9">1.6.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: node-exporter
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app.kubernetes.io/component</span>: exporter
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app.kubernetes.io/name</span>: node-exporter
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app.kubernetes.io/part-of</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app.kubernetes.io/component</span>: exporter
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app.kubernetes.io/name</span>: node-exporter
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app.kubernetes.io/part-of</span>: kube-vm
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - --web.listen-address=$(HOSTIP):9100
</span></span><span style="display:flex;"><span>            - --path.sysfs=/host/sys
</span></span><span style="display:flex;"><span>            - --path.rootfs=/host/root
</span></span><span style="display:flex;"><span>            - --path.udev.data=/host/root/run/udev/data
</span></span><span style="display:flex;"><span>            - --<span style="color:#ff79c6">no</span>-collector.wifi
</span></span><span style="display:flex;"><span>            - --<span style="color:#ff79c6">no</span>-collector.hwmon
</span></span><span style="display:flex;"><span>            - --<span style="color:#ff79c6">no</span>-collector.btrfs
</span></span><span style="display:flex;"><span>            - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|run/k3s/containerd/.+|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)
</span></span><span style="display:flex;"><span>            - --collector.netclass.ignored-devices=^(veth.*|[a-f0-9]{15})$
</span></span><span style="display:flex;"><span>            - --collector.netdev.device-exclude=^(veth.*|[a-f0-9]{15})$
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: quay.io/prometheus/node-exporter:v1.6.0
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: node-exporter
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: HOSTIP
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">valueFrom</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">fieldRef</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#ff79c6">fieldPath</span>: status.hostIP
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 250m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 180Mi
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 102m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 180Mi
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">allowPrivilegeEscalation</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">capabilities</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">add</span>:
</span></span><span style="display:flex;"><span>                - SYS_TIME
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">drop</span>:
</span></span><span style="display:flex;"><span>                - ALL
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">readOnlyRootFilesystem</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /host/sys
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPropagation</span>: HostToContainer
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: sys
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /host/root
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPropagation</span>: HostToContainer
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: root
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">hostNetwork</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">hostPID</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">kubernetes.io/os</span>: linux
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">priorityClassName</span>: system-cluster-critical
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">runAsNonRoot</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">runAsUser</span>: <span style="color:#bd93f9">65534</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">tolerations</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">operator</span>: Exists
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">hostPath</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">path</span>: /sys
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: sys
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">hostPath</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">path</span>: /
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: root
</span></span></code></pre></div><p>ç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•å³å¯:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-node-exporter.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -owide
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>node-exporter-6hch2           1/1     Running   <span style="color:#bd93f9">0</span>          84s     10.206.16.10   node2     &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>node-exporter-d2k6n           1/1     Running   <span style="color:#bd93f9">0</span>          86s     10.206.16.6    master1   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>node-exporter-k2tvj           1/1     Running   <span style="color:#bd93f9">0</span>          82s     10.206.16.5    node1     &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>ç„¶åé‡æ–°éƒ¨ç½²ä¸€å¥—ç‹¬ç«‹çš„ Prometheusï¼Œä¸ºäº†ç®€å•æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>static_configs</code> é™æ€é…ç½®æ–¹å¼æ¥æŠ“å– node-exporter çš„æŒ‡æ ‡ï¼Œé…ç½®æ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">prometheus.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: &#34;nodes&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - targets: [&#39;10.206.16.6:9100&#39;, &#39;10.206.16.5:9100&#39;, &#39;10.206.16.10:9100&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs: # é€šè¿‡ relabeling ä» __address__ ä¸­æå– IP ä¿¡æ¯ï¼Œä¸ºäº†åé¢éªŒè¯ VM æ˜¯å¦å…¼å®¹ relabeling
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):(.*)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: &#39;ip&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace</span>    
</span></span></code></pre></div><p>ä¸Šé¢é…ç½®ä¸­é€šè¿‡ <code>relabel</code> æ“ä½œä» <code>__address__</code> ä¸­å°† IP ä¿¡æ¯æå–å‡ºæ¥ï¼Œåé¢å¯ä»¥ç”¨æ¥éªŒè¯ VM æ˜¯å¦å…¼å®¹ <code>relabel</code> æ“ä½œã€‚</p>
<p>åŒæ ·è¦ç»™ Prometheus æ•°æ®åšæŒä¹…åŒ–ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ PVC èµ„æºå¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-pvc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># apiVersion: storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># kind: StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># metadata:</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#   name: local-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># provisioner: kubernetes.io/no-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># volumeBindingMode: WaitForFirstConsumer</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-data
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /data/k8s/prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">key</span>: kubernetes.io/hostname
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">operator</span>: In
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">values</span>:
</span></span><span style="display:flex;"><span>                - node2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span></code></pre></div><p>ç„¶åç›´æ¥åˆ›å»º Prometheus å³å¯ï¼Œå°†ä¸Šé¢çš„ PVC å’Œ ConfigMap æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œé€šè¿‡ <code>--config.file</code> å‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶æ–‡ä»¶è·¯å¾„ï¼ŒæŒ‡å®š TSDB æ•°æ®è·¯å¾„ç­‰ï¼Œèµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-deploy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: prometheus
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: data
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: prometheus-data
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: config-volume
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">image</span>: prom/prometheus:v2.44.0
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: prometheus
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--config.file=/etc/prometheus/prometheus.yaml&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--storage.tsdb.path=/prometheus&#34;</span> <span style="color:#6272a4"># æŒ‡å®štsdbæ•°æ®è·¯å¾„</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--storage.tsdb.retention.time=2d&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--web.enable-lifecycle&#34;</span> <span style="color:#6272a4"># æ”¯æŒçƒ­æ›´æ–°ï¼Œç›´æ¥æ‰§è¡Œlocalhost:9090/-/reloadç«‹å³ç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">runAsUser</span>: <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: config-volume
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: data
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: prometheus
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: web
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span></code></pre></div><p>ç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-prom-config.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-prom-pvc.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-prom-deploy.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>node-exporter-6hch2           1/1     Running   <span style="color:#bd93f9">0</span>          101s
</span></span><span style="display:flex;"><span>node-exporter-d2k6n           1/1     Running   <span style="color:#bd93f9">0</span>          103s
</span></span><span style="display:flex;"><span>node-exporter-k2tvj           1/1     Running   <span style="color:#bd93f9">0</span>          99s
</span></span><span style="display:flex;"><span>prometheus-84c5bcd9f9-zmtpf   1/1     Running   <span style="color:#bd93f9">0</span>          3m51s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc -n kube-vm
</span></span><span style="display:flex;"><span>NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>prometheus   NodePort   10.100.210.162   &lt;none&gt;        9090:31233/TCP   28s
</span></span></code></pre></div><p>éƒ¨ç½²å®Œæˆåå¯ä»¥é€šè¿‡ <code>http://&lt;node-ip&gt;:31233</code> è®¿é—® Prometheusï¼Œæ­£å¸¸å¯ä»¥çœ‹åˆ°é‡‡é›†çš„ 3 ä¸ª node èŠ‚ç‚¹çš„æŒ‡æ ‡ä»»åŠ¡ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689665071024.png" alt="nodes targets"></p>
<p>åŒæ ·çš„æ–¹å¼é‡æ–°éƒ¨ç½² Grafanaï¼Œèµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-grafana.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: grafana
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: grafana-data
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: grafana/grafana:10.0.1
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">runAsUser</span>: <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: GF_SECURITY_ADMIN_USER
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">value</span>: admin
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: GF_SECURITY_ADMIN_PASSWORD
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">value</span>: admin321
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /api/health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">scheme</span>: HTTP
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">successThreshold</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /api/health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">scheme</span>: HTTP
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">successThreshold</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 150m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 512Mi
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 150m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 512Mi
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /var/lib/grafana
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: grafana
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana-data
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>: 1Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /data/k8s/grafana
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">key</span>: kubernetes.io/hostname
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">operator</span>: In
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">values</span>:
</span></span><span style="display:flex;"><span>                - node2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: grafana-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 1Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span></code></pre></div><p>åŒæ ·ç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-grafana.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>grafana
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>grafana-7f7d7bd89c-ztcqn   1/1     Running   <span style="color:#bd93f9">0</span>          41s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc grafana -n kube-vm
</span></span><span style="display:flex;"><span>NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>grafana   NodePort   10.109.249.118   &lt;none&gt;        3000:32060/TCP   64s
</span></span></code></pre></div><p>åŒæ ·é€šè¿‡ <code>http://&lt;node-ip&gt;:32060</code> å°±å¯ä»¥è®¿é—® Grafana äº†ï¼Œè¿›å…¥ Grafana é…ç½® Prometheus æ•°æ®æºã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689665325762.png" alt="Grafana æ•°æ®æº"></p>
<p>ç„¶åå¯¼å…¥ <a href="https://grafana.com/grafana/dashboards/16098">16098</a> è¿™ä¸ª Dashboardï¼Œå¯¼å…¥åæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689665438827.jpg" alt="node exporter dashboard"></p>
<p>åˆ°è¿™é‡Œå°±å®Œæˆäº†ä½¿ç”¨ Prometheus æ”¶é›†èŠ‚ç‚¹ç›‘æ§æŒ‡æ ‡ï¼ˆå’Œå‰é¢å­¦ä¹ çš„çŸ¥è¯†ç‚¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä½¿ç”¨ VM æ¥æ”¹é€ ç°æœ‰æ–¹æ¡ˆã€‚</p>
<h3 id="è¿œç¨‹å­˜å‚¨-victoriametrics">è¿œç¨‹å­˜å‚¨ VictoriaMetrics</h3>
<p>é¦–å…ˆéœ€è¦ä¸€ä¸ªå•èŠ‚ç‚¹æ¨¡å¼çš„ VictoriaMetricsï¼Œè¿è¡Œ VictoriaMetrics å¾ˆç®€å•ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ docker é•œåƒä¸€é”®å¯åŠ¨ï¼Œæˆ‘ä»¬è¿™é‡ŒåŒæ ·éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚èµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-single.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vm
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/victoria-metrics:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -storageDataPath=/var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>            - -retentionPeriod=1w
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8428</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8428</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /data/k8s/vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">matchExpressions</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">key</span>: kubernetes.io/hostname
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">operator</span>: In
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">values</span>:
</span></span><span style="display:flex;"><span>                - node2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 20Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: local-storage
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>-storageDataPath</code> å‚æ•°æŒ‡å®šäº†æ•°æ®å­˜å‚¨ç›®å½•ï¼Œç„¶ååŒæ ·å°†è¯¥ç›®å½•è¿›è¡Œäº†æŒä¹…åŒ–ï¼Œ<code>-retentionPeriod</code> å‚æ•°å¯ä»¥ç”¨æ¥é…ç½®æ•°æ®çš„ä¿å­˜å‘¨æœŸã€‚ç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-single.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc victoria-metrics -n kube-vm
</span></span><span style="display:flex;"><span>NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>victoria-metrics   NodePort   10.110.151.187   &lt;none&gt;        8428:30147/TCP   8s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>victoria-metrics
</span></span><span style="display:flex;"><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>victoria-metrics-7c9bcd964c-szq9q   1/1     Running   <span style="color:#bd93f9">0</span>          19s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl logs -f victoria-metrics-7c9bcd964c-szq9q -n kube-vm
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:12   build version: victoria-metrics-20230630-132641-tags-v1.91.3-0-g7226242070
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:13   command-line flags
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:20     -retentionPeriod<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1w&#34;</span>
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/lib/logger/flag.go:20     -storageDataPath<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/var/lib/victoria-metrics-data&#34;</span>
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/app/victoria-metrics/main.go:70 starting VictoriaMetrics at <span style="color:#f1fa8c">&#34;:8428&#34;</span>...
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.697Z        info    VictoriaMetrics/app/vmstorage/main.go:108       opening storage at <span style="color:#f1fa8c">&#34;/var/lib/victoria-metrics-data&#34;</span> with -retentionPeriod<span style="color:#ff79c6">=</span>1w
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.699Z        info    VictoriaMetrics/lib/memory/memory.go:42 limiting caches to <span style="color:#bd93f9">4604539699</span> bytes, leaving <span style="color:#bd93f9">3069693133</span> bytes to the OS according to -memory.allowedPercent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">60</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.740Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:96 starting http server at http://127.0.0.1:8428/
</span></span><span style="display:flex;"><span>2023-07-18T07:32:55.740Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:97 pprof handlers are exposed at http://127.0.0.1:8428/debug/pprof/
</span></span></code></pre></div><p>åˆ°è¿™é‡Œæˆ‘ä»¬å•èŠ‚ç‚¹çš„ <code>VictoriaMetrics</code> å°±éƒ¨ç½²æˆåŠŸäº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦åœ¨ Prometheus ä¸­é…ç½®è¿œç¨‹å†™å…¥æˆ‘ä»¬çš„ VM å³å¯ï¼Œæ›´æ”¹ Prometheus é…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-config2.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">prometheus.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    remote_write:    # è¿œç¨‹å†™å…¥åˆ°è¿œç¨‹ VM å­˜å‚¨
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - url: http://victoria-metrics:8428/api/v1/write
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: &#34;nodes&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - targets: [&#39;10.206.16.6:9100&#39;, &#39;10.206.16.5:9100&#39;, &#39;10.206.16.10:9100&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs: # é€šè¿‡ relabeling ä» __address__ ä¸­æå– IP ä¿¡æ¯ï¼Œä¸ºäº†åé¢éªŒè¯ VM æ˜¯å¦å…¼å®¹ relabeling
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):(.*)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: &#39;ip&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace</span>    
</span></span></code></pre></div><p>é‡æ–°æ›´æ–° Prometheus çš„é…ç½®èµ„æºå¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-prom-config2.yaml
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># æ›´æ–°åéš”ä¸€ä¼šå„¿æ‰§è¡Œ reload æ“ä½œé‡æ–°åŠ è½½ prometheus é…ç½®</span>
</span></span><span style="display:flex;"><span>â˜¸ âœ curl -X POST <span style="color:#f1fa8c">&#34;http://&lt;node ip&gt;:31233/-/reload&#34;</span>
</span></span></code></pre></div><p>é…ç½®ç”Ÿæ•ˆå Prometheus å°±ä¼šå¼€å§‹å°†æ•°æ®è¿œç¨‹å†™å…¥ VM ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ VM çš„æŒä¹…åŒ–æ•°æ®ç›®å½•æ˜¯å¦æœ‰æ•°æ®äº§ç”Ÿæ¥éªŒè¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ ll /data/k8s/vm/data/
</span></span><span style="display:flex;"><span>total <span style="color:#bd93f9">16</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">4</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:32 ./
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">7</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:32 ../
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">4</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:37 big/
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#bd93f9">1</span> root root    <span style="color:#bd93f9">0</span> Jul <span style="color:#bd93f9">18</span> 15:32 flock.lock
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#bd93f9">4</span> root root <span style="color:#bd93f9">4096</span> Jul <span style="color:#bd93f9">18</span> 15:37 small/
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬å»ç›´æ¥å°† Grafana ä¸­çš„æ•°æ®æºåœ°å€ä¿®æ”¹æˆ VM çš„åœ°å€ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667605660.png" alt="ä¿®æ”¹æ•°æ®æº"></p>
<p>ä¿®æ”¹å®Œæˆåé‡æ–°è®¿é—® node-exporter çš„ dashboardï¼Œæ­£å¸¸å¯ä»¥æ˜¾ç¤ºï¼Œè¯æ˜ VM æ˜¯å…¼å®¹çš„ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667644354.jpg" alt="èŠ‚ç‚¹dashboard"></p>
<h3 id="æ›¿æ¢-prometheus">æ›¿æ¢ Prometheus</h3>
<p>ä¸Šé¢æˆ‘ä»¬å°† Prometheus æ•°æ®è¿œç¨‹å†™å…¥åˆ°äº† VMï¼Œä½†æ˜¯ Prometheus å¼€å¯ remote write åŠŸèƒ½åä¼šå¢åŠ å…¶æœ¬èº«çš„èµ„æºå ç”¨ï¼Œç†è®ºä¸Šå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥å®Œå…¨ç”¨ VM æ¥æ›¿æ¢æ‰ Prometheusï¼Œè¿™æ ·å°±ä¸éœ€è¦è¿œç¨‹å†™å…¥äº†ï¼Œè€Œä¸”æœ¬èº« VM å°±æ¯” Prometheus å ç”¨æ›´å°‘çš„èµ„æºã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å…ˆåœæ‰ Prometheus çš„æœåŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl scale deploy prometheus --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -n kube-vm
</span></span></code></pre></div><p>ç„¶åå°† Prometheus çš„é…ç½®æ–‡ä»¶æŒ‚è½½åˆ° VM å®¹å™¨ä¸­ï¼Œä½¿ç”¨å‚æ•° <code>-promscrape.config</code> æ¥æŒ‡å®š Prometheus çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-single2.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: victoria-metrics
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: victoria-metrics-data
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vm
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/victoria-metrics:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -storageDataPath=/var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>            - -retentionPeriod=1w
</span></span><span style="display:flex;"><span>            - -promscrape.config=/etc/prometheus/prometheus.yaml
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8428</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /var/lib/victoria-metrics-data
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /etc/prometheus
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: prometheus-config
</span></span></code></pre></div><p>è®°å¾—å…ˆå°† Prometheus é…ç½®æ–‡ä»¶ä¸­çš„ remote_write æ¨¡å—å»æ‰ï¼Œç„¶åé‡æ–°æ›´æ–° VM å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-prom-config.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-single2.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>victoria-metrics
</span></span><span style="display:flex;"><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>victoria-metrics-bf45c58cb-k4kdv   1/1     Running   <span style="color:#bd93f9">0</span>          53s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl logs -f victoria-metrics-bf45c58cb-k4kdv -n kube-vm
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.846Z        info    VictoriaMetrics/lib/logger/flag.go:12   build version: victoria-metrics-20230630-132641-tags-v1.91.3-0-g7226242070
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.928Z        info    VictoriaMetrics/app/victoria-metrics/main.go:80 started VictoriaMetrics in 0.082 seconds
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.928Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:96 starting http server at http://127.0.0.1:8428/
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.928Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:97 pprof handlers are exposed at http://127.0.0.1:8428/debug/pprof/
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.929Z        info    VictoriaMetrics/lib/promscrape/scraper.go:114   reading Prometheus configs from <span style="color:#f1fa8c">&#34;/etc/prometheus/prometheus.yaml&#34;</span>
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.930Z        info    VictoriaMetrics/lib/promscrape/config.go:122    starting service discovery routines...
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.930Z        info    VictoriaMetrics/lib/promscrape/config.go:128    started service discovery routines in 0.000 seconds
</span></span><span style="display:flex;"><span>2023-07-18T08:09:52.930Z        info    VictoriaMetrics/lib/promscrape/scraper.go:431   static_configs: added targets: 3, removed targets: 0; total targets: <span style="color:#bd93f9">3</span>
</span></span></code></pre></div><p>ä» VM æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºæˆåŠŸè¯»å–äº† Prometheus çš„é…ç½®ï¼Œå¹¶æŠ“å–äº† 3 ä¸ªæŒ‡æ ‡ï¼ˆnode-exporterï¼‰ã€‚
ç°åœ¨æˆ‘ä»¬å†å» Grafana æŸ¥çœ‹ node-exporter çš„ Dashboard æ˜¯å¦å¯ä»¥æ­£å¸¸æ˜¾ç¤ºã€‚å…ˆä¿è¯æ•°æ®æºæ˜¯ VM çš„åœ°å€ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667950120.png" alt="vmæ•°æ®æº"></p>
<p>è¿™æ ·æˆ‘ä»¬å°±ä½¿ç”¨ VM æ›¿æ¢æ‰äº† Prometheusï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™ Grafana çš„ Explore é¡µé¢å»æ¢ç´¢é‡‡é›†åˆ°çš„æŒ‡æ ‡ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689667976130.jpg" alt="node dashboard"></p>
<h3 id="ui-ç•Œé¢">UI ç•Œé¢</h3>
<p>VM å•èŠ‚ç‚¹ç‰ˆæœ¬æœ¬èº«è‡ªå¸¦äº†ä¸€ä¸ª Web UI ç•Œé¢ - <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/tree/master/app/vmui">vmui</a>ï¼Œä¸è¿‡ç›®å‰åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ VM çš„ NodePort ç«¯å£è¿›è¡Œè®¿é—®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl get svc victoria-metrics -n kube-vm
</span></span><span style="display:flex;"><span>NAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>victoria-metrics   NodePort   10.110.151.187   &lt;none&gt;        8428:30147/TCP   40m
</span></span></code></pre></div><p>æˆ‘ä»¬è¿™é‡Œå¯ä»¥é€šè¿‡ <code>http://&lt;node-ip&gt;:30147</code> è®¿é—®åˆ° vmuiï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668032720.png" alt="vmui"></p>
<p>å¯ä»¥é€šè¿‡ <code>/vmui</code> è¿™ä¸ª endpoint è®¿é—® UI ç•Œé¢ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668109076.jpg" alt="vmui web ui"></p>
<p>å¦‚æœä½ æƒ³æŸ¥çœ‹é‡‡é›†åˆ°çš„æŒ‡æ ‡ targetsï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ <code>/targets</code> è¿™ä¸ª endpoint æ¥è·å–ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668181142.png" alt="targets"></p>
<p>è¿™äº›åŠŸèƒ½åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„ä¸€äº›éœ€æ±‚ï¼Œä½†æ˜¯è¿˜æ˜¯å¤ªè¿‡ç®€å•ï¼Œå¦‚æœä½ ä¹ æƒ¯äº† Prometheus çš„ UI ç•Œé¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>promxy</code> æ¥ä»£æ›¿ <code>vmui</code>ï¼Œè€Œä¸” <code>promxy</code> è¿˜å¯ä»¥è¿›è¡Œå¤šä¸ª VM å•èŠ‚ç‚¹çš„æ•°æ®èšåˆï¼Œä»¥åŠ targets æŸ¥çœ‹ç­‰ï¼Œå¯¹åº”çš„èµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-promxy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">config.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    promxy:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      server_groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - targets: [victoria-metrics:8428]  # æŒ‡å®švmåœ°å€ï¼Œæœ‰å¤šä¸ªåˆ™å¾€åè¿½åŠ å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        path_prefix: /prometheus  # é…ç½®å‰ç¼€</span>    
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: promxy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: promxy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: promxy
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--config=/etc/promxy/config.yaml&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--web.enable-lifecycle&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--log-level=trace&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: ROLE
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">value</span>: <span style="color:#f1fa8c">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">command</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;/bin/promxy&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: quay.io/jacksontj/promxy
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: Always
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: promxy
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8082</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: web
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/promxy/&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">args</span>: <span style="color:#6272a4"># container to reload configs on configmap change</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--volume-dir=/etc/promxy&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--webhook-url=http://localhost:8082/-/reload&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: jimmidyson/configmap-reload:v0.1
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: promxy-server-configmap-reload
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/promxy/&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: promxy-config
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: promxy
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8082</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: promxy
</span></span></code></pre></div><p>ç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-promxy.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>promxy
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>promxy-5db957c48c-7tcjr   2/2     Running   <span style="color:#bd93f9">0</span>          110s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc promxy -n kube-vm
</span></span><span style="display:flex;"><span>NAME     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>promxy   NodePort   10.106.11.170   &lt;none&gt;        8082:31060/TCP   2m1s
</span></span></code></pre></div><p>è®¿é—® Promxy çš„é¡µé¢æ•ˆæœå’Œ Prometheus è‡ªå¸¦çš„ Web UI åŸºæœ¬ä¸€è‡´çš„ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689668402982.jpg" alt="promxy"></p>
<h2 id="é›†ç¾¤ç‰ˆ">é›†ç¾¤ç‰ˆ</h2>
<p>å¯¹äºä½äºæ¯ç§’ä¸€ç™¾ä¸‡ä¸ªæ•°æ®ç‚¹çš„æ‘„å–ç‡ï¼Œå»ºè®®ä½¿ç”¨å•èŠ‚ç‚¹ç‰ˆæœ¬è€Œä¸æ˜¯é›†ç¾¤ç‰ˆæœ¬ã€‚å•èŠ‚ç‚¹ç‰ˆæœ¬å¯æ ¹æ® CPUã€å†…å­˜å’Œå¯ç”¨å­˜å‚¨ç©ºé—´çš„æ•°é‡è¿›è¡Œæ‰©å±•ã€‚å•èŠ‚ç‚¹ç‰ˆæœ¬æ¯”é›†ç¾¤ç‰ˆæœ¬æ›´å®¹æ˜“é…ç½®å’Œæ“ä½œï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨é›†ç¾¤ç‰ˆæœ¬ä¹‹å‰è¦ä¸‰æ€è€Œåè¡Œã€‚ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº† VM çš„å•èŠ‚ç‚¹ç‰ˆæœ¬çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨é›†ç¾¤ç‰ˆã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689859339713.jpg" alt="VM Cluster"></p>
<p>é›†ç¾¤ç‰ˆä¸»è¦ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ”¯æŒå•èŠ‚ç‚¹ç‰ˆæœ¬çš„æ‰€æœ‰åŠŸèƒ½ã€‚</li>
<li>æ€§èƒ½å’Œå®¹é‡æ°´å¹³æ‰©å±•ã€‚</li>
<li>æ”¯æŒæ—¶é—´åºåˆ—æ•°æ®çš„å¤šä¸ªç‹¬ç«‹å‘½åç©ºé—´ï¼ˆå¤šç§Ÿæˆ·ï¼‰ã€‚</li>
<li>æ”¯æŒå¤šå‰¯æœ¬ã€‚</li>
</ul>
<p><strong>ç»„ä»¶æœåŠ¡</strong></p>
<p>å‰é¢æˆ‘ä»¬äº†è§£äº† VM çš„åŸºæœ¬æ¶æ„ï¼Œå¯¹äºé›†ç¾¤æ¨¡å¼ä¸‹ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæœåŠ¡ï¼š</p>
<ul>
<li><code>vmstorage</code>ï¼šå­˜å‚¨åŸå§‹æ•°æ®å¹¶è¿”å›æŒ‡å®šæ ‡ç­¾è¿‡æ»¤å™¨åœ¨ç»™å®šæ—¶é—´èŒƒå›´å†…çš„æŸ¥è¯¢æ•°æ®ï¼Œå½“ <code>-storageDataPath</code> æŒ‡å‘çš„ç›®å½•åŒ…å«çš„å¯ç”¨ç©ºé—´å°‘äº <code>-storage.minFreeDiskSpaceBytes</code> æ—¶ï¼Œ<code>vmstorage</code> èŠ‚ç‚¹ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°<strong>åªè¯»æ¨¡å¼</strong>ï¼Œ<code>vminsert</code> èŠ‚ç‚¹ä¹Ÿä¼šåœæ­¢å‘æ­¤ç±»èŠ‚ç‚¹å‘é€æ•°æ®å¹¶å¼€å§‹å°†æ•°æ®é‡æ–°è·¯ç”±åˆ°å‰©ä½™çš„ <code>vmstorage</code> èŠ‚ç‚¹ã€‚</li>
<li><code>vminsert</code>ï¼šæ¥å—æ‘„å–çš„æ•°æ®å¹¶æ ¹æ®æŒ‡æ ‡åç§°åŠå…¶æ‰€æœ‰æ ‡ç­¾çš„ä¸€è‡´æ€§å“ˆå¸Œå°†å…¶åˆ†æ•£å­˜å‚¨åˆ° <code>vmstorage</code> èŠ‚ç‚¹ã€‚</li>
<li><code>vmselect</code>ï¼šé€šè¿‡ä»æ‰€æœ‰é…ç½®çš„ <code>vmstorage</code> èŠ‚ç‚¹è·å–æ‰€éœ€æ•°æ®æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚</li>
</ul>
<p>æ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥è¿›è¡Œç‹¬ç«‹æ‰©å±•ï¼Œ<code>vmstorage</code> èŠ‚ç‚¹ä¹‹é—´äº’ä¸äº†è§£ã€äº’ä¸é€šä¿¡ï¼Œå¹¶ä¸”ä¸å…±äº«ä»»ä½•æ•°æ®ã€‚è¿™æ ·å¯ä»¥å¢åŠ é›†ç¾¤çš„å¯ç”¨æ€§ï¼Œå¹¶ä¸”ç®€åŒ–äº†é›†ç¾¤çš„ç»´æŠ¤å’Œæ‰©å±•ã€‚</p>
<p>æœ€å°é›†ç¾¤å¿…é¡»åŒ…å«ä»¥ä¸‹èŠ‚ç‚¹ï¼š</p>
<ul>
<li>å¸¦æœ‰ <code>-retentionPeriod</code> å’Œ <code>-storageDataPath</code> å‚æ•°çš„å• <code>vmstorage</code> èŠ‚ç‚¹</li>
<li>å¸¦æœ‰ <code>-storageNode=&lt;vmstorage_host&gt;</code> çš„å• <code>vminsert</code> èŠ‚ç‚¹</li>
<li>å¸¦æœ‰ <code>-storageNode=&lt;vmstorage_host&gt;</code> çš„å• <code>vmselect</code> èŠ‚ç‚¹</li>
</ul>
<p>ä½†æ˜¯æˆ‘ä»¬å»ºè®®ä¸ºæ¯ä¸ªæœåŠ¡ç»„ä»¶è¿è¡Œè‡³å°‘ä¸¤ä¸ªèŠ‚ç‚¹ä»¥å®ç°é«˜å¯ç”¨æ€§ï¼Œè¿™æ ·å½“å•ä¸ªèŠ‚ç‚¹æš‚æ—¶ä¸å¯ç”¨æ—¶ï¼Œé›†ç¾¤ä¼šç»§ç»­å·¥ä½œï¼Œè€Œä¸”å…¶ä½™èŠ‚ç‚¹è¿˜å¯ä»¥å¤„ç†å¢åŠ çš„å·¥ä½œè´Ÿè½½ã€‚å¦‚æœä½ çš„é›†ç¾¤è§„æ¨¡è¾ƒå¤§ï¼Œé‚£ä¹ˆå¯ä»¥è¿è¡Œå¤šä¸ª <code>vmstorage</code> èŠ‚ç‚¹ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥åœ¨æŸäº› <code>vmstorage</code> èŠ‚ç‚¹æš‚æ—¶ä¸å¯ç”¨æ—¶å‡å°‘å‰©ä½™ <code>vmstorage</code> èŠ‚ç‚¹ä¸Šçš„å·¥ä½œè´Ÿè½½å¢åŠ ã€‚</p>
<p>å„ä¸ªæœåŠ¡é™¤äº†å¯ä»¥é€šè¿‡å‚æ•°æ ‡å¿—è¿›è¡Œé…ç½®ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼š</p>
<ul>
<li><code>-envflag.enable</code> æ ‡å¿—å¿…é¡»è®¾ç½®</li>
<li>æ¯ä¸ªæ ‡å¿—ä¸­çš„ <code>.</code> å¿…é¡»æ›¿æ¢ä¸º <code>_</code>ï¼Œä¾‹å¦‚ <code>-insert.maxQueueDuration &lt;duration&gt;</code> å¯ä»¥è½¬æ¢ä¸º <code>insert_maxQueueDuration=&lt;duration&gt;</code></li>
<li>å¯¹äºé‡å¤çš„æ ‡å¿—ï¼Œå¯ä»¥ä½¿ç”¨å¦ä¸€ç§è¯­æ³•ï¼Œé€šè¿‡ä½¿ç”¨ <code>,</code> ä½œä¸ºåˆ†éš”ç¬¦å°†ä¸åŒçš„å€¼è¿æ¥æˆä¸€ä¸ªï¼Œä¾‹å¦‚ <code>-storageNode &lt;nodeA&gt; -storageNode &lt;nodeB&gt;</code> å°†è½¬æ¢ä¸º <code>-storageNode=&lt;nodeA&gt;,&lt;nodeB&gt;</code></li>
<li>å¯ä»¥ä½¿ç”¨ <code>-envflag.prefix</code> ä¸ºç¯å¢ƒå˜é‡è®¾ç½®å‰ç¼€ï¼Œä¾‹å¦‚è®¾ç½®äº† <code>-envflag.prefix=VM*</code>ï¼Œåˆ™ç¯å¢ƒå˜é‡å‚æ•°å¿…é¡»ä»¥ <code>VM*</code> å¼€å¤´</li>
</ul>
<p><strong>å¤šç§Ÿæˆ·</strong></p>
<p>æ­¤å¤– VM é›†ç¾¤ä¹Ÿæ”¯æŒå¤šä¸ªç‹¬ç«‹çš„ç§Ÿæˆ·ï¼ˆä¹Ÿå«å‘½åç©ºé—´ï¼‰ï¼Œç§Ÿæˆ·ç”± <code>accountID</code> æˆ– <code>accountID:projectID</code> æ¥æ ‡è¯†ï¼Œå®ƒä»¬è¢«æ”¾åœ¨è¯·æ±‚çš„ urls ä¸­ã€‚</p>
<ul>
<li>æ¯ä¸ª <code>accountID</code> å’Œ <code>projectID</code> éƒ½ç”±ä¸€ä¸ª <code>[0 .. 2^32]</code> èŒƒå›´å†…çš„ä»»æ„ 32 ä½æ•´æ•°æ ‡è¯†ï¼Œå¦‚æœç¼ºå°‘ <code>projectID</code>ï¼Œåˆ™è‡ªåŠ¨å°†å…¶åˆ†é…ä¸º 0ã€‚æœ‰å…³ç§Ÿæˆ·çš„å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚èº«ä»½éªŒè¯ä»¤ç‰Œã€ç§Ÿæˆ·åç§°ã€é™é¢ã€è®¡è´¹ç­‰ï¼Œå°†å­˜å‚¨åœ¨ä¸€ä¸ªå•ç‹¬çš„å…³ç³»å‹æ•°æ®åº“ä¸­ã€‚æ­¤æ•°æ®åº“å¿…é¡»ç”±ä½äº VictoriaMetrics é›†ç¾¤å‰é¢çš„å•ç‹¬æœåŠ¡ç®¡ç†ï¼Œä¾‹å¦‚ <code>vmauth</code> æˆ– <code>vmgateway</code>ã€‚</li>
<li>å½“ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹å†™å…¥æŒ‡å®šç§Ÿæˆ·æ—¶ï¼Œç§Ÿæˆ·è¢«è‡ªåŠ¨åˆ›å»ºã€‚</li>
<li>æ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨å¯ç”¨çš„ <code>vmstorage</code> èŠ‚ç‚¹ä¸­ï¼Œå½“ä¸åŒç§Ÿæˆ·æœ‰ä¸åŒçš„æ•°æ®é‡å’Œä¸åŒçš„æŸ¥è¯¢è´Ÿè½½æ—¶ï¼Œè¿™ä¿è¯äº† <code>vmstorage</code> èŠ‚ç‚¹ä¹‹é—´çš„å‡åŒ€è´Ÿè½½ã€‚</li>
<li>æ•°æ®åº“æ€§èƒ½å’Œèµ„æºä½¿ç”¨ä¸ä¾èµ–äºç§Ÿæˆ·çš„æ•°é‡ï¼Œå®ƒä¸»è¦å–å†³äºæ‰€æœ‰ç§Ÿæˆ·ä¸­æ´»è·ƒæ—¶é—´åºåˆ—çš„æ€»æ•°ã€‚å¦‚æœä¸€ä¸ªæ—¶é—´åºåˆ—åœ¨è¿‡å»ä¸€å°æ—¶å†…è‡³å°‘æ”¶åˆ°ä¸€ä¸ªæ ·æœ¬ï¼Œæˆ–è€…åœ¨è¿‡å»ä¸€å°æ—¶å†…è¢«æŸ¥è¯¢ï¼Œåˆ™è®¤ä¸ºæ—¶é—´åºåˆ—æ˜¯æ´»è·ƒçš„ã€‚</li>
<li>VictoriaMetrics ä¸æ”¯æŒåœ¨å•ä¸ªè¯·æ±‚ä¸­æŸ¥è¯¢å¤šä¸ªç§Ÿæˆ·ã€‚</li>
</ul>
<p><strong>é›†ç¾¤å¤§å°è°ƒæ•´å’Œå¯æ‰©å±•æ€§</strong></p>
<p>VM é›†ç¾¤çš„æ€§èƒ½å’Œå®¹é‡å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è¿›è¡Œæ‰©å±•ï¼š</p>
<ul>
<li>é€šè¿‡å‘é›†ç¾¤ä¸­çš„ç°æœ‰èŠ‚ç‚¹æ·»åŠ æ›´å¤šèµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ IOã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œå¸¦å®½ï¼‰ï¼Œä¹Ÿå«å‚ç›´å¯æ‰©å±•æ€§ã€‚</li>
<li>é€šè¿‡å‘é›†ç¾¤æ·»åŠ æ›´å¤šèŠ‚ç‚¹ï¼Œåˆå«æ°´å¹³æ‰©å±•æ€§ã€‚</li>
</ul>
<p>å¯¹äºé›†ç¾¤æ‰©å±•æœ‰ä¸€äº›é€šç”¨çš„å»ºè®®ï¼š</p>
<ul>
<li>å‘ç°æœ‰ <code>vmselect</code> èŠ‚ç‚¹æ·»åŠ æ›´å¤š CPU å’Œå†…å­˜ï¼Œå¯ä»¥æé«˜å¤æ‚æŸ¥è¯¢çš„æ€§èƒ½ï¼Œè¿™äº›æŸ¥è¯¢å¯ä»¥å¤„ç†å¤§é‡çš„æ—¶é—´åºåˆ—å’Œå¤§é‡çš„åŸå§‹æ ·æœ¬ã€‚</li>
<li>æ·»åŠ æ›´å¤š <code>vmstorage</code> èŠ‚ç‚¹å¯ä»¥å¢åŠ é›†ç¾¤å¯ä»¥å¤„ç†çš„æ´»è·ƒæ—¶é—´åºåˆ—çš„æ•°é‡ï¼Œè¿™ä¹Ÿæé«˜äº†å¯¹é«˜æµå¤±ç‡(<code>churn rate</code>)çš„æ—¶é—´åºåˆ—çš„æŸ¥è¯¢æ€§èƒ½ã€‚é›†ç¾¤ç¨³å®šæ€§ä¹Ÿä¼šéšç€ <code>vmstorage</code> èŠ‚ç‚¹æ•°é‡çš„å¢åŠ è€Œæé«˜ï¼Œå½“ä¸€äº› <code>vmstorage</code> èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œå­˜æ´»çš„ <code>vmstorage</code> èŠ‚ç‚¹éœ€è¦å¤„ç†è¾ƒä½çš„é¢å¤–å·¥ä½œè´Ÿè½½ã€‚</li>
<li>å‘ç°æœ‰ <code>vmstorage</code> èŠ‚ç‚¹æ·»åŠ æ›´å¤š CPU å’Œå†…å­˜ï¼Œå¯ä»¥å¢åŠ é›†ç¾¤å¯ä»¥å¤„ç†çš„æ´»è·ƒæ—¶é—´åºåˆ—çš„æ•°é‡ã€‚ä¸å‘ç°æœ‰ <code>vmstorage</code> èŠ‚ç‚¹æ·»åŠ æ›´å¤š CPU å’Œå†…å­˜ç›¸æ¯”ï¼Œæœ€å¥½æ·»åŠ æ›´å¤š <code>vmstorage</code> èŠ‚ç‚¹ï¼Œå› ä¸ºæ›´å¤šçš„ <code>vmstorage</code> èŠ‚ç‚¹å¯ä»¥æé«˜é›†ç¾¤ç¨³å®šæ€§ï¼Œå¹¶æé«˜å¯¹é«˜æµå¤±ç‡çš„æ—¶é—´åºåˆ—çš„æŸ¥è¯¢æ€§èƒ½ã€‚</li>
<li>æ·»åŠ æ›´å¤šçš„ <code>vminsert</code> èŠ‚ç‚¹ä¼šæé«˜æ•°æ®æ‘„å–çš„æœ€å¤§é€Ÿåº¦ï¼Œå› ä¸ºæ‘„å–çš„æ•°æ®å¯ä»¥åœ¨æ›´å¤šçš„ <code>vminsert</code> èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œæ‹†åˆ†ã€‚</li>
<li>æ·»åŠ æ›´å¤šçš„ <code>vmselect</code> èŠ‚ç‚¹å¯ä»¥æé«˜æŸ¥è¯¢çš„æœ€å¤§é€Ÿåº¦ï¼Œå› ä¸ºä¼ å…¥çš„å¹¶å‘è¯·æ±‚å¯èƒ½ä¼šåœ¨æ›´å¤šçš„ <code>vmselect</code> èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œæ‹†åˆ†ã€‚</li>
</ul>
<p><strong>é›†ç¾¤å¯ç”¨æ€§</strong></p>
<ul>
<li>HTTP è´Ÿè½½å‡è¡¡å™¨éœ€è¦åœæ­¢å°†è¯·æ±‚è·¯ç”±åˆ°ä¸å¯ç”¨çš„ <code>vminsert</code> å’Œ <code>vmselect</code> èŠ‚ç‚¹ã€‚</li>
<li>å¦‚æœè‡³å°‘å­˜åœ¨ä¸€ä¸ª <code>vmstorage</code> èŠ‚ç‚¹ï¼Œåˆ™é›†ç¾¤ä»ç„¶å¯ç”¨ï¼š
<ul>
<li><code>vminsert</code> å°†ä¼ å…¥æ•°æ®ä»ä¸å¯ç”¨çš„ <code>vmstorage</code> èŠ‚ç‚¹é‡æ–°è·¯ç”±åˆ°å¥åº·çš„ <code>vmstorage</code> èŠ‚ç‚¹</li>
<li>å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ª <code>vmstorage</code> èŠ‚ç‚¹å¯ç”¨ï¼Œåˆ™ <code>vmselect</code> ä¼šç»§ç»­æä¾›éƒ¨åˆ†å“åº”ã€‚å¦‚æœä¼˜å…ˆè€ƒè™‘å¯ç”¨æ€§çš„ä¸€è‡´æ€§ï¼Œåˆ™å°† <code>-search.denyPartialResponse</code> æ ‡å¿—ä¼ é€’ç»™ <code>vmselect</code> æˆ–å°†è¯·æ±‚ä¸­çš„ <code>deny_partial_response=1</code> æŸ¥è¯¢å‚æ•°ä¼ é€’ç»™ <code>vmselect</code>ã€‚</li>
</ul>
</li>
</ul>
<p><strong>é‡å¤æ•°æ®åˆ é™¤</strong></p>
<p>å¦‚æœ <code>-dedup.minScrapeInterval</code> å‘½ä»¤è¡Œæ ‡å¿—è®¾ç½®ä¸ºå¤§äº 0 çš„æ—¶é—´ï¼ŒVictoriaMetrics ä¼šå»é™¤é‡å¤æ•°æ®ç‚¹ã€‚ä¾‹å¦‚ï¼Œ<code>-dedup.minScrapeInterval=60s</code> å°†å¯¹åŒä¸€æ—¶é—´åºåˆ—ä¸Šçš„æ•°æ®ç‚¹è¿›è¡Œé‡å¤æ•°æ®åˆ é™¤ï¼Œå¦‚æœå®ƒä»¬ä½äºåŒä¸€ç¦»æ•£çš„ 60 ç§’å­˜å‚¨æ¡¶å†…ï¼Œæœ€æ—©çš„æ•°æ®ç‚¹å°†è¢«ä¿ç•™ã€‚åœ¨æ—¶é—´æˆ³ç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œå°†ä¿ç•™ä»»æ„æ•°æ®ç‚¹ã€‚</p>
<p><code>-dedup.minScrapeInterval</code> çš„æ¨èå€¼æ˜¯ç­‰äº Prometheus é…ç½®ä¸­çš„ <code>scrape_interval</code> çš„å€¼ï¼Œå»ºè®®åœ¨æ‰€æœ‰æŠ“å–ç›®æ ‡ä¸­ä½¿ç”¨ä¸€ä¸ª <code>scrape_interval</code> é…ç½®ã€‚</p>
<!-- raw HTML omitted -->
<p>å¦‚æœ HA ä¸­å¤šä¸ªç›¸åŒé…ç½®çš„ <code>vmagent</code> æˆ– Prometheus å®ä¾‹å°†æ•°æ®å†™å…¥åŒä¸€ä¸ª VictoriaMetrics å®ä¾‹ï¼Œåˆ™é‡å¤æ•°æ®åˆ é™¤ä¼šå‡å°‘ç£ç›˜ç©ºé—´ä½¿ç”¨ã€‚è¿™äº› <code>vmagent</code> æˆ– Prometheus å®ä¾‹åœ¨å…¶é…ç½®ä¸­å¿…é¡»å…·æœ‰ç›¸åŒçš„ <code>external_labels</code> éƒ¨åˆ†ï¼Œå› æ­¤å®ƒä»¬å°†æ•°æ®å†™å…¥ç›¸åŒçš„æ—¶é—´åºåˆ—ã€‚</p>
<p><strong>å®¹é‡è§„åˆ’</strong></p>
<p>æ ¹æ®æˆ‘ä»¬çš„æ¡ˆä¾‹ç ”ç©¶ï¼Œä¸ç«äº‰è§£å†³æ–¹æ¡ˆï¼ˆPrometheusã€Thanosã€Cortexã€TimescaleDBã€InfluxDBã€QuestDBã€M3DBï¼‰ç›¸æ¯”ï¼ŒVictoriaMetrics åœ¨ç”Ÿäº§å·¥ä½œè´Ÿè½½ä¸Šä½¿ç”¨çš„ CPUã€å†…å­˜å’Œå­˜å‚¨ç©ºé—´æ›´å°‘ã€‚</p>
<p>æ¯ç§èŠ‚ç‚¹ç±»å‹ - <code>vminsert</code>ã€<code>vmselect</code> å’Œ <code>vmstorage</code> éƒ½å¯ä»¥åœ¨æœ€åˆé€‚çš„ç¡¬ä»¶ä¸Šè¿è¡Œã€‚é›†ç¾¤å®¹é‡éšç€å¯ç”¨èµ„æºçš„å¢åŠ è€Œçº¿æ€§æ‰©å±•ã€‚æ¯ä¸ªèŠ‚ç‚¹ç±»å‹æ‰€éœ€çš„ CPU å’Œå†…å­˜æ•°é‡å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºå·¥ä½œè´Ÿè½½ - æ´»è·ƒæ—¶é—´åºåˆ—çš„æ•°é‡ã€åºåˆ—æµå¤±ç‡ã€æŸ¥è¯¢ç±»å‹ã€æŸ¥è¯¢ qps ç­‰ã€‚å»ºè®®ä¸ºä½ çš„ç”Ÿäº§å·¥ä½œè´Ÿè½½éƒ¨ç½²ä¸€ä¸ªæµ‹è¯•çš„ VictoriaMetrics é›†ç¾¤ï¼Œå¹¶åå¤è°ƒæ•´æ¯ä¸ªèŠ‚ç‚¹çš„èµ„æºå’Œæ¯ä¸ªèŠ‚ç‚¹ç±»å‹çš„èŠ‚ç‚¹æ•°é‡ï¼Œç›´åˆ°é›†ç¾¤å˜å¾—ç¨³å®šã€‚åŒæ ·ä¹Ÿå»ºè®®ä¸ºé›†ç¾¤è®¾ç½®ç›‘æ§ï¼Œæœ‰åŠ©äºç¡®å®šé›†ç¾¤è®¾ç½®ä¸­çš„ç“¶é¢ˆé—®é¢˜ã€‚</p>
<p>æŒ‡å®šä¿ç•™æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼ˆå¯ä»¥é€šè¿‡ <code>vmstorage</code> ä¸­çš„ <code>-retentionPeriod</code> å‘½ä»¤è¡Œæ ‡å¿—è®¾ç½®ï¼‰å¯ä»¥ä»æµ‹è¯•è¿è¡Œä¸­çš„ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µæ¨æ–­å‡ºæ¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ç”Ÿäº§å·¥ä½œè´Ÿè½½ä¸Šè¿è¡Œä¸€å¤©åçš„å­˜å‚¨ç©ºé—´ä½¿ç”¨é‡ä¸º 10GBï¼Œé‚£ä¹ˆå¯¹äº <code>-retentionPeriod=100d</code>ï¼ˆ100 å¤©ä¿ç•™æœŸï¼‰æ¥è¯´ï¼Œå®ƒè‡³å°‘éœ€è¦ <code>10GB*100=1TB</code> çš„ç£ç›˜ç©ºé—´ã€‚å¯ä»¥ä½¿ç”¨ VictoriaMetrics é›†ç¾¤çš„<a href="https://grafana.com/grafana/dashboards/11176">å®˜æ–¹ Grafana ä»ªè¡¨æ¿</a>ç›‘æ§å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µã€‚</p>
<p>å»ºè®®ç•™å‡ºä»¥ä¸‹æ•°é‡çš„å¤‡ç”¨èµ„æºã€‚</p>
<ul>
<li>æ‰€æœ‰èŠ‚ç‚¹ç±»å‹ä¸­ 50% çš„ç©ºé—²å†…å­˜ï¼Œä»¥å‡å°‘å·¥ä½œè´Ÿè½½ä¸´æ—¶æ¿€å¢æ—¶å› ä¸º OOM å´©æºƒçš„å¯èƒ½æ€§ã€‚</li>
<li>æ‰€æœ‰èŠ‚ç‚¹ç±»å‹ä¸­ 50% çš„ç©ºé—² CPUï¼Œä»¥å‡å°‘å·¥ä½œè´Ÿè½½ä¸´æ—¶é«˜å³°æœŸé—´çš„æ…¢é€Ÿæ¦‚ç‡ã€‚</li>
<li><code>vmstorage</code> èŠ‚ç‚¹ä¸Š <code>-storageDataPath</code> å‘½ä»¤è¡Œæ ‡å¿—æŒ‡å‘çš„ç›®å½•ä¸­è‡³å°‘æœ‰ <strong>30%</strong> çš„å¯ç”¨å­˜å‚¨ç©ºé—´ã€‚</li>
</ul>
<p>VictoriaMetrics é›†ç¾¤çš„ä¸€äº›å®¹é‡è§„åˆ’æŠ€å·§ï¼š</p>
<ul>
<li>å‰¯æœ¬é›†å°†é›†ç¾¤æ‰€éœ€çš„èµ„æºé‡æœ€å¤šå¢åŠ  N å€ï¼Œå…¶ä¸­ N æ˜¯å¤åˆ¶å› å­ã€‚</li>
<li>å¯ä»¥é€šè¿‡æ·»åŠ æ›´å¤š <code>vmstorage</code> èŠ‚ç‚¹å’Œ/æˆ–é€šè¿‡å¢åŠ æ¯ä¸ª <code>vmstorage</code> èŠ‚ç‚¹çš„å†…å­˜å’Œ CPU èµ„æºæ¥å¢åŠ æ´»è·ƒæ—¶é—´åºåˆ—çš„é›†ç¾¤å®¹é‡ã€‚</li>
<li>å¯ä»¥é€šè¿‡å¢åŠ  <code>vmstorage</code> èŠ‚ç‚¹çš„æ•°é‡å’Œ/æˆ–é€šè¿‡å¢åŠ æ¯ä¸ª <code>vmselect</code> èŠ‚ç‚¹çš„å†…å­˜å’Œ CPU èµ„æºæ¥å‡å°‘æŸ¥è¯¢å»¶è¿Ÿã€‚</li>
<li>æ‰€æœ‰ <code>vminsert</code> èŠ‚ç‚¹æ‰€éœ€çš„ CPU å†…æ ¸æ€»æ•°å¯ä»¥é€šè¿‡æ‘„å–ç‡è®¡ç®—ï¼š<code>CPUs = ingestion_rate / 100K</code>ã€‚</li>
<li><code>vminsert</code> èŠ‚ç‚¹ä¸Šçš„ <code>-rpc.disableCompression</code> å‘½ä»¤è¡Œæ ‡å¿—å¯ä»¥å¢åŠ æ‘„å–å®¹é‡ï¼Œä½†ä»£ä»·æ˜¯ <code>vminsert</code> å’Œ <code>vmstorage</code> ä¹‹é—´çš„ç½‘ç»œå¸¦å®½ä½¿ç”¨ç‡ä¼šæ›´é«˜ã€‚</li>
</ul>
<p><strong>å¤åˆ¶å’Œæ•°æ®å®‰å…¨</strong></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒVictoriaMetrics çš„æ•°æ®å¤åˆ¶ä¾èµ– <code>-storageDataPath</code> æŒ‡å‘çš„åº•å±‚å­˜å‚¨æ¥å®Œæˆã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨é€šè¿‡å°† <code>-replicationFactor=N</code> å‘½ä»¤å‚æ•°ä¼ é€’ç»™ <code>vminsert</code> æ¥å¯ç”¨å¤åˆ¶ï¼Œè¿™ä¿è¯äº†å¦‚æœå¤šè¾¾ <code>N-1</code> ä¸ª <code>vmstorage</code> èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œæ‰€æœ‰æ•°æ®ä»å¯ç”¨äºæŸ¥è¯¢ã€‚é›†ç¾¤å¿…é¡»è‡³å°‘åŒ…å« <code>2*N-1</code> ä¸ª <code>vmstorage</code> èŠ‚ç‚¹ï¼Œå…¶ä¸­ <code>N</code> æ˜¯å¤åˆ¶å› å­ï¼Œä»¥ä¾¿åœ¨ <code>N-1</code> ä¸ªå­˜å‚¨èŠ‚ç‚¹ä¸¢å¤±æ—¶ä¸ºæ–°æ‘„å–çš„æ•°æ®ç»´æŒæŒ‡å®šçš„å¤åˆ¶å› å­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå½“ <code>-replicationFactor=3</code> ä¼ é€’ç»™ <code>vminsert</code> æ—¶ï¼Œå®ƒå°†æ‰€æœ‰æ‘„å–çš„æ•°æ®å¤åˆ¶åˆ° 3 ä¸ªä¸åŒçš„ <code>vmstorage</code> èŠ‚ç‚¹ï¼Œå› æ­¤æœ€å¤šå¯ä»¥ä¸¢å¤± 2 ä¸ª <code>vmstorage</code> èŠ‚ç‚¹è€Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚<code>vmstorage</code> èŠ‚ç‚¹çš„æœ€å°æ•°é‡åº”è¯¥ç­‰äº <code>2*3-1 = 5</code>ï¼Œå› æ­¤å½“ 2 ä¸ª <code>vmstorage</code> èŠ‚ç‚¹ä¸¢å¤±æ—¶ï¼Œå‰©ä½™çš„ 3 ä¸ª <code>vmstorage</code> èŠ‚ç‚¹å¯ä»¥ä¸ºæ–°æ‘„å–çš„æ•°æ®æä¾›æœåŠ¡ã€‚</p>
<p>å¯ç”¨å¤åˆ¶åï¼Œå¿…é¡»å°† <code>-dedup.minScrapeInterval=1ms</code> å‘½ä»¤è¡Œæ ‡å¿—ä¼ é€’ç»™ <code>vmselect</code> èŠ‚ç‚¹ï¼Œå½“å¤šè¾¾ <code>N-1</code> ä¸ª <code>vmstorage</code> èŠ‚ç‚¹å“åº”ç¼“æ…¢å’Œ/æˆ–æš‚æ—¶ä¸å¯ç”¨æ—¶ï¼Œå¯ä»¥å°†å¯é€‰çš„ <code>-replicationFactor=N</code> å‚æ•°ä¼ é€’ç»™ <code>vmselect</code> ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå› ä¸º <code>vmselect</code> ä¸ç­‰å¾…æ¥è‡ªå¤šè¾¾ <code>N-1</code> ä¸ª <code>vmstorage</code> èŠ‚ç‚¹çš„å“åº”ã€‚æœ‰æ—¶ï¼Œ<code>vmselect</code> èŠ‚ç‚¹ä¸Šçš„ <code>-replicationFactor</code> å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†å“åº”ã€‚<code>-dedup.minScrapeInterval=1ms</code> åœ¨æŸ¥è¯¢æœŸé—´å¯¹å¤åˆ¶çš„æ•°æ®è¿›è¡Œé‡å¤æ•°æ®åˆ é™¤ï¼Œå¦‚æœé‡å¤æ•°æ®ä»é…ç½®ç›¸åŒçš„ <code>vmagent</code> å®ä¾‹æˆ– Prometheus å®ä¾‹æ¨é€åˆ° VictoriaMetricsï¼Œåˆ™å¿…é¡»æ ¹æ®é‡å¤æ•°æ®åˆ é™¤æ–‡æ¡£å°† <code>-dedup.minScrapeInterval</code> è®¾ç½®ä¸ºæ›´å¤§çš„å€¼ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå¤åˆ¶ä¸ä¼šä»ç¾éš¾ä¸­ä¿å­˜ï¼Œå› æ­¤å»ºè®®æ‰§è¡Œå®šæœŸå¤‡ä»½ã€‚å¦å¤–å¤åˆ¶ä¼šå¢åŠ èµ„æºä½¿ç”¨ç‡ - CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œå¸¦å®½è¿™äº›æœ€å¤š <code>-replicationFactor</code> å€ã€‚æ‰€ä»¥å¯ä»¥å°†å¤åˆ¶è½¬ç§» <code>-storageDataPath</code> æŒ‡å‘çš„åº•å±‚å­˜å‚¨æ¥åšä¿è¯ï¼Œä¾‹å¦‚ Google Compute Engine æ°¸ä¹…ç£ç›˜ï¼Œè¯¥ç£ç›˜å¯ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±å’Œæ•°æ®æŸåï¼Œå®ƒè¿˜æä¾›å§‹ç»ˆå¦‚ä¸€çš„é«˜æ€§èƒ½ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹è°ƒæ•´å¤§å°ã€‚å¯¹äºå¤§å¤šæ•°ç”¨ä¾‹æ¥è¯´ï¼ŒåŸºäº HDD çš„æ°¸ä¹…æ€§ç£ç›˜åº”è¯¥è¶³å¤Ÿäº†ã€‚</p>
<p><strong>å¤‡ä»½</strong></p>
<p>å»ºè®®ä»å³æ—¶å¿«ç…§æ‰§è¡Œå®šæœŸå¤‡ä»½ï¼Œä»¥é˜²æ­¢æ„å¤–æ•°æ®åˆ é™¤ç­‰é”™è¯¯ã€‚å¿…é¡»ä¸ºæ¯ä¸ª <code>vmstorage</code> èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥åˆ›å»ºå¤‡ä»½ï¼š</p>
<p>é€šè¿‡å¯¼èˆªåˆ°/snapshot/create HTTP handler æ¥åˆ›å»ºä¸€ä¸ªå³æ—¶å¿«ç…§ã€‚å®ƒå°†åˆ›å»ºå¿«ç…§å¹¶è¿”å›å…¶åç§°ã€‚</p>
<ul>
<li>å¯ä»¥é€šè¿‡è®¿é—® <code>/snapshot/create</code> è¿™ä¸ª HTTP handler æ¥åˆ›å»ºå³æ—¶å¿«ç…§ï¼Œå®ƒå°†åˆ›å»ºå¿«ç…§å¹¶è¿”å›å…¶åç§°ã€‚</li>
<li>ä½¿ç”¨ <code>vmbackup</code> ç»„ä»¶ä» <code>&lt;storageDataPath&gt;/snapshots/&lt;snapshot_name&gt;</code> æ–‡ä»¶å¤¹å½’æ¡£åˆ›å»ºçš„å¿«ç…§ã€‚å½’æ¡£è¿‡ç¨‹ä¸ä¼šå¹²æ‰° <code>vmstorage</code> å·¥ä½œï¼Œå› æ­¤å¯ä»¥åœ¨ä»»ä½•åˆé€‚çš„æ—¶é—´æ‰§è¡Œã€‚</li>
<li>é€šè¿‡ <code>/snapshot/delete?snapshot=&lt;snapshot_name&gt;</code> æˆ– <code>/snapshot/delete_all</code> åˆ é™¤æœªä½¿ç”¨çš„å¿«ç…§ï¼Œä»¥é‡Šæ”¾å ç”¨çš„å­˜å‚¨ç©ºé—´ã€‚</li>
<li>æ— éœ€åœ¨æ‰€æœ‰ <code>vmstorage</code> èŠ‚ç‚¹ä¹‹é—´åŒæ­¥å¤‡ä»½ã€‚</li>
</ul>
<p>ä»å¤‡ä»½æ¢å¤ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>kill -INT</code> åœæ­¢ <code>vmstorage</code> èŠ‚ç‚¹ã€‚</li>
<li>ä½¿ç”¨ <code>vmrestore</code> ç»„ä»¶å°†å¤‡ä»½ä¸­çš„æ•°æ®è¿˜åŸåˆ° <code>-storageDataPath</code> ç›®å½•ã€‚</li>
<li>å¯åŠ¨ <code>vmstorage</code> èŠ‚ç‚¹ã€‚</li>
</ul>
<p>åœ¨äº†è§£äº† VM é›†ç¾¤çš„ä¸€äº›é…ç½®ç»†èŠ‚åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å¼€å§‹éƒ¨ç½² VM é›†ç¾¤ã€‚</p>
<p><strong>Helm</strong></p>
<p>å¦‚æœä½ å·²ç»å¯¹ VM ç»„ä»¶éå¸¸äº†è§£äº†ï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨ Helm Chart çš„æ–¹å¼è¿›è¡Œä¸€é”®å®‰è£…ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ helm repo add vm https://victoriametrics.github.io/helm-charts/
</span></span><span style="display:flex;"><span>â˜¸ âœ helm repo update
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># å¯¼å‡ºé»˜è®¤çš„ values å€¼åˆ° vm-cluster-values.yaml æ–‡ä»¶ä¸­</span>
</span></span><span style="display:flex;"><span>â˜¸ âœ helm show values vm/victoria-metrics-cluster &gt; vm-cluster-values.yaml
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ values.yaml æ–‡ä»¶é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œä¸€é”®å®‰è£…</span>
</span></span><span style="display:flex;"><span>â˜¸ âœ helm upgrade --install victoria-metrics vm/victoria-metrics-cluster -f vm-cluster-values.yaml -n &lt;namespace&gt;
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># è·å– vm è¿è¡Œçš„ pods åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -A | grep <span style="color:#f1fa8c">&#39;victoria-metrics&#39;</span>
</span></span></code></pre></div><p>æˆ‘ä»¬è¿™é‡Œé€‰æ‹©æ‰‹åŠ¨æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œä¹‹æ‰€ä»¥é€‰æ‹©æ‰‹åŠ¨éƒ¨ç½²çš„æ–¹å¼æ˜¯ä¸ºäº†èƒ½å¤Ÿäº†è§£å„ä¸ªç»„ä»¶çš„æ›´å¤šç»†èŠ‚ã€‚</p>
<p><strong>æ‰‹åŠ¨å®‰è£…</strong></p>
<p>ç”±äº vmstorage ç»„ä»¶æ˜¯æœ‰çŠ¶æ€çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä½¿ç”¨ StatefulSet è¿›è¡Œéƒ¨ç½²ï¼Œç”±äºè¯¥ç»„ä»¶ä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œæ‰©å±•çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é¦–å…ˆéƒ¨ç½²ä¸¤ä¸ªå‰¯æœ¬ï¼Œå¯¹åº”çš„èµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># cluster/vmstorage.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: cluster-vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">clusterIP</span>: None
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8482</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8401</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: vmselect
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8400</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: vminsert
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: StatefulSet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceName</span>: cluster-vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podManagementPolicy</span>: OrderedReady
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmstorage
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vmstorage
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vmstorage:v1.91.3-cluster&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: <span style="color:#f1fa8c">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--retentionPeriod=1&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--storageDataPath=/storage&#34;</span>
</span></span><span style="display:flex;"><span>            - --envflag.enable=true
</span></span><span style="display:flex;"><span>            - --envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - --loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8482</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8400</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8401</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">tcpSocket</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /storage
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: storage
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">storageClassName</span>: cfsauto <span style="color:#6272a4"># æŒ‡å®šä¸€ä¸ªå¯ç”¨çš„å­˜å‚¨ç±»ï¼ˆå»ºè®®ç”¨Local PVï¼‰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>          - ReadWriteOnce
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">storage</span>: <span style="color:#f1fa8c">&#34;2Gi&#34;</span>
</span></span></code></pre></div><p>é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª Headless çš„ Serviceï¼Œå› ä¸ºåé¢çš„ç»„ä»¶éœ€è¦è®¿é—®åˆ°æ¯ä¸€ä¸ªå…·ä½“çš„ Podï¼Œåœ¨ vmstorage å¯åŠ¨å‚æ•°ä¸­é€šè¿‡ <code>--retentionPeriod</code> å‚æ•°æŒ‡å®šæŒ‡æ ‡æ•°æ®ä¿ç•™æ—¶é•¿ï¼Œ1 è¡¨ç¤ºä¸€ä¸ªæœˆï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„æ—¶é•¿ï¼Œç„¶åé€šè¿‡ <code>--storageDataPath</code> å‚æ•°æŒ‡å®šäº†æ•°æ®å­˜å‚¨è·¯å¾„ï¼Œè®°å¾—è¦å°†è¯¥ç›®å½•è¿›è¡ŒæŒä¹…åŒ–ã€‚</p>
<p>åŒæ ·ç›´æ¥åº”ç”¨è¯¥èµ„æºå³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmstorage.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmstorage
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmstorage-0   1/1     Running   <span style="color:#bd93f9">0</span>          5m40s
</span></span><span style="display:flex;"><span>vmstorage-1   1/1     Running   <span style="color:#bd93f9">0</span>          3m31s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmstorage
</span></span><span style="display:flex;"><span>NAME                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>                      AGE
</span></span><span style="display:flex;"><span>cluster-vmstorage   ClusterIP   None         &lt;none&gt;        8482/TCP,8401/TCP,8400/TCP   12s
</span></span></code></pre></div><p>æ¥ç€å¯ä»¥éƒ¨ç½² vmselect ç»„ä»¶ï¼Œç”±äºè¯¥ç»„ä»¶æ˜¯æ— çŠ¶æ€ï¼ˆå¦‚æœä½ è¦ä¿å­˜ cache æ•°æ®åˆ™éœ€è¦çœ‹æˆæ˜¯æœ‰çŠ¶æ€åº”ç”¨äº†ï¼‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ Deployment æ¥è¿›è¡Œç®¡ç†ï¼Œå¯¹åº”çš„èµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># cluster/vmselect.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8481</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmselect
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vmselect
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vmselect:v1.91.3-cluster&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: <span style="color:#f1fa8c">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--cacheDataPath=/cache&#34;</span>
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-0.cluster-vmstorage.kube-vm.svc.cluster.local:8401
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-1.cluster-vmstorage.kube-vm.svc.cluster.local:8401
</span></span><span style="display:flex;"><span>            - --envflag.enable=true
</span></span><span style="display:flex;"><span>            - --envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - --loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8481</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">tcpSocket</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /cache
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: cache-volume
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: cache-volume
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">emptyDir</span>: {}
</span></span></code></pre></div><p>å…¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯é€šè¿‡ <code>--storageNode</code> å‚æ•°æŒ‡å®šæ‰€æœ‰çš„ vmstorage èŠ‚ç‚¹åœ°å€ï¼Œä¸Šé¢æˆ‘ä»¬ä½¿ç”¨çš„ StatefulSet éƒ¨ç½²çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨ FQDN çš„å½¢å¼è¿›è¡Œè®¿é—®ã€‚ç›´æ¥åº”ç”¨ä¸Šé¢çš„å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmselect.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmselect
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmselect-75d59b468c-4c7rp   1/1     Running   <span style="color:#bd93f9">0</span>          25s
</span></span><span style="display:flex;"><span>vmselect-75d59b468c-8g8tj   1/1     Running   <span style="color:#bd93f9">0</span>          42s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmselect
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>    AGE
</span></span><span style="display:flex;"><span>vmselect   ClusterIP   10.100.207.33   &lt;none&gt;        8481/TCP   <span style="color:#bd93f9">7</span>
</span></span></code></pre></div><p>å¦‚æœè¦è¿›è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹å¤–æš´éœ² vmselect è¿™ä¸ª Service æœåŠ¡å³å¯ï¼Œä¿®æ”¹ Grafana æ•°æ®æºåœ°å€ä¸º <code>http://&lt;select-service&gt;/select/0/prometheus/</code>ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689835776972.png" alt="vmselectæ•°æ®æº"></p>
<p>æ¥ç€å°±éœ€è¦éƒ¨ç½²ç”¨æ¥æ¥æ”¶æŒ‡æ ‡æ•°æ®æ’å…¥çš„ vminsert ç»„ä»¶ï¼ŒåŒæ ·è¯¥ç»„ä»¶æ˜¯æ— çŠ¶æ€çš„ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¹Ÿæ˜¯éœ€è¦é€šè¿‡ <code>--storageNode</code> å‚æ•°æŒ‡å®šæ‰€æœ‰çš„ vmstorage èŠ‚ç‚¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># cluster/vminsert.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8480</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vminsert
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vminsert
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vminsert:v1.91.3-cluster&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: <span style="color:#f1fa8c">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-0.cluster-vmstorage.kube-vm.svc.cluster.local:8400
</span></span><span style="display:flex;"><span>            - --storageNode=vmstorage-1.cluster-vmstorage.kube-vm.svc.cluster.local:8400
</span></span><span style="display:flex;"><span>            - --envflag.enable=true
</span></span><span style="display:flex;"><span>            - --envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - --loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8480</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">path</span>: /health
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">tcpSocket</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">port</span>: http
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">initialDelaySeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">periodSeconds</span>: <span style="color:#bd93f9">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">timeoutSeconds</span>: <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">failureThreshold</span>: <span style="color:#bd93f9">3</span>
</span></span></code></pre></div><p>ç”±äºæœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®éœ€è¦å¢åŠ å‰¯æœ¬æ•°é‡ï¼Œä¹Ÿå¯ä»¥é…ç½® HPA è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹ã€‚ç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºæ¸…å•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vminsert.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vminsert
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vminsert-b7fd8cfd5-kscc2   1/1     Running   <span style="color:#bd93f9">0</span>          59s
</span></span><span style="display:flex;"><span>vminsert-b7fd8cfd5-zxp49   1/1     Running   <span style="color:#bd93f9">0</span>          59s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vminsert
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>    AGE
</span></span><span style="display:flex;"><span>vminsert   ClusterIP   10.108.71.120   &lt;none&gt;        8480/TCP   71s
</span></span></code></pre></div><p>é›†ç¾¤æ¨¡å¼çš„ç›¸å…³ç»„ä»¶éƒ¨ç½²å®Œæˆåï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥å…ˆå»é…ç½®å‰é¢çš„ Prometheusï¼Œå°†å…¶æ•°æ®è¿œç¨‹å†™å…¥åˆ° VM ä¸­æ¥ï¼Œä¿®æ”¹ <code>remote_write</code> çš„åœ°å€ä¸º <code>http://vminsert:8480/insert/0/prometheus/</code>ï¼Œæ³¨æ„å’Œå•èŠ‚ç‚¹æ¨¡å¼çš„ API è·¯å¾„ä¸ä¸€æ ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vm-prom-config3.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: prometheus-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">prometheus.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    remote_write:    # å†™å…¥åˆ°è¿œç¨‹ VM å­˜å‚¨ï¼Œurl æ˜¯è¿œç¨‹å†™å…¥æ¥å£åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - url: http://vminsert:8480/insert/0/prometheus/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      # queue_config:    # å¦‚æœ Prometheus æŠ“å–æŒ‡æ ‡å¾ˆå¤§ï¼Œå¯ä»¥åŠ è°ƒæ•´ queueï¼Œä½†æ˜¯ä¼šæé«˜å†…å­˜å ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      #   max_samples_per_send: 10000  # æ¯æ¬¡å‘é€çš„æœ€å¤§æ ·æœ¬æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      #   capacity: 20000
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      #   max_shards: 30   # æœ€å¤§åˆ†ç‰‡æ•°ï¼Œå³å¹¶å‘é‡ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: &#34;nodes&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      static_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - targets: [&#39;10.206.16.6:9100&#39;, &#39;10.206.16.5:9100&#39;, &#39;10.206.16.10:9100&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs: # é€šè¿‡ relabeling ä» __address__ ä¸­æå– IP ä¿¡æ¯ï¼Œä¸ºäº†åé¢éªŒè¯ VM æ˜¯å¦å…¼å®¹ relabeling
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):(.*)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: &#39;ip&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace</span>    
</span></span></code></pre></div><p>æ›´æ–° Prometheus é…ç½®ï¼Œç„¶åå¯åŠ¨ Prometheusï¼Œå‰é¢çš„å•æœºæ¨¡å¼çš„ VM å¯ä»¥å…ˆåœæ‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vm-prom-config3.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl scale deploy victoria-metrics --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -n kube-vm
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl scale deploy prometheus --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -n kube-vm
</span></span></code></pre></div><p>é…ç½®æˆåŠŸåæ­£å¸¸æ•°æ®å°±å¯ä»¥å¼€å§‹å†™å…¥åˆ° vmstorage äº†ï¼ŒæŸ¥çœ‹ vmstorage æ—¥å¿—å¯ä»¥çœ‹åˆ°æˆåŠŸåˆ›å»ºäº† partitionï¼Œè¯æ˜ç°åœ¨å·²ç»åœ¨å¼€å§‹æ¥æ”¶æ•°æ®äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl logs -f vmstorage-0 -n kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.082Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/logger/flag.go:12&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;build version: vmstorage-20230630-163052-tags-v1.91.3-cluster-0-g12f262c331&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.082Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/main.go:100&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;opening storage at \&#34;/storage\&#34; with -retentionPeriod=1&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.087Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/memory/memory.go:42&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;limiting caches to 4604539699 bytes, leaving 3069693133 bytes to the OS according to -memory.allowedPercent=60&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.091Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/storage.go:873&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;nothing to load from \&#34;/storage/cache/curr_hour_metric_ids\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.091Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/storage.go:873&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;nothing to load from \&#34;/storage/cache/prev_hour_metric_ids\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.091Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/storage.go:833&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;nothing to load from \&#34;/storage/cache/next_day_metric_ids\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.136Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/main.go:112&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;successfully opened storage \&#34;/storage\&#34; in 0.054 seconds; partsCount: 0; blocksCount: 0; rowsCount: 0; sizeBytes: 0&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/servers/vminsert.go:65&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;accepting vminsert conns at 0.0.0.0:8400&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/httpserver/httpserver.go:96&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;starting http server at http://127.0.0.1:8482/&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/httpserver/httpserver.go:97&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;pprof handlers are exposed at http://127.0.0.1:8482/debug/pprof/&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:43:48.138Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/vmselectapi/server.go:157&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;accepting vmselect conns at 0.0.0.0:8401&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:56:25.825Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/servers/vminsert.go:114&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;processing vminsert conn from 10.244.3.127:47976&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:56:27.613Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/app/vmstorage/servers/vminsert.go:114&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;processing vminsert conn from 10.244.2.249:54484&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:59:32.813Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/partition.go:221&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;creating a partition \&#34;2023_07\&#34; with smallPartsPath=\&#34;/storage/data/small/2023_07\&#34;, bigPartsPath=\&#34;/storage/data/big/2023_07\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T06:59:32.821Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/storage/partition.go:230&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;partition \&#34;2023_07\&#34; has been created&#34;</span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>ç„¶åå¯ä»¥å» Grafana é‡æ–°æŸ¥çœ‹ Dashboard æ˜¯å¦æ­£å¸¸ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689836577195.jpg" alt="node exporter"></p>
<p>å¦‚æœç°åœ¨éœ€è¦æ–°å¢ <code>vmstorage</code> èŠ‚ç‚¹ï¼Œé‚£ä¹ˆéœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤è¿›è¡Œæ“ä½œï¼š</p>
<ul>
<li>ä½¿ç”¨ä¸é›†ç¾¤ä¸­ç°æœ‰èŠ‚ç‚¹ç›¸åŒçš„ <code>-retentionPeriod</code> é…ç½®å¯åŠ¨æ–°çš„ <code>vmstorage</code> èŠ‚ç‚¹ã€‚</li>
<li>é€æ­¥é‡æ–°å¯åŠ¨æ‰€æœ‰çš„ <code>vmselect</code> èŠ‚ç‚¹ï¼Œæ·»åŠ æ–°çš„ <code>-storageNode</code> å‚æ•°åŒ…å« <code>&lt;new_vmstorage_host&gt;</code>ã€‚</li>
<li>é€æ­¥é‡æ–°å¯åŠ¨æ‰€æœ‰çš„ <code>vminsert</code> èŠ‚ç‚¹ï¼Œæ·»åŠ æ–°çš„ <code>-storageNode</code> å‚æ•°åŒ…å« <code>&lt;new_vmstorage_host&gt;</code>ã€‚</li>
</ul>
<h2 id="vmagent">vmagent</h2>
<p>vmagent å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»å„ç§æ¥æºæ”¶é›†æŒ‡æ ‡å¹¶å°†å®ƒä»¬å­˜å‚¨è¿™ VM æˆ–è€…ä»»ä½•å…¶ä»–æ”¯æŒ remote write åè®®çš„ Prometheus å…¼å®¹çš„å­˜å‚¨ç³»ç»Ÿä¸­ã€‚vmagent ç›¸æ¯”äº Prometheus æŠ“å–æŒ‡æ ‡æ¥è¯´å…·æœ‰æ›´å¤šçš„çµæ´»æ€§ï¼Œæ¯”å¦‚é™¤äº†æ‹‰å–ï¼ˆpullï¼‰æŒ‡æ ‡è¿˜å¯ä»¥æ¨é€ï¼ˆpushï¼‰æŒ‡æ ‡ï¼Œæ­¤å¤–è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç‰¹æ€§ï¼š</p>
<ul>
<li>å¯ä»¥æ›¿æ¢ prometheus çš„ scraping target</li>
<li>æ”¯æŒä» Kafka è¯»å†™æ•°æ®</li>
<li>æ”¯æŒåŸºäº prometheus relabeling çš„æ¨¡å¼æ·»åŠ ã€ç§»é™¤ã€ä¿®æ”¹ labelsï¼Œå¯ä»¥åœ¨æ•°æ®å‘é€åˆ°è¿œç«¯å­˜å‚¨ä¹‹å‰è¿›è¡Œæ•°æ®çš„è¿‡æ»¤</li>
<li>æ”¯æŒå¤šç§æ•°æ®åè®®ï¼Œinflux line åè®®ï¼Œgraphite æ–‡æœ¬åè®®ï¼Œopentsdb åè®®ï¼Œprometheus remote write åè®®ï¼Œjson lines åè®®ï¼Œcsv æ•°æ®ç­‰</li>
<li>æ”¯æŒæ”¶é›†æ•°æ®çš„åŒæ—¶ï¼Œå¹¶å¤åˆ¶åˆ°å¤šç§è¿œç«¯å­˜å‚¨ç³»ç»Ÿ</li>
<li>æ”¯æŒä¸å¯é è¿œç«¯å­˜å‚¨ï¼Œå¦‚æœè¿œç¨‹å­˜å‚¨ä¸å¯ç”¨ï¼Œæ”¶é›†çš„æŒ‡æ ‡ä¼šåœ¨ <code>-remoteWrite.tmpDataPath</code> ç¼“å†²ï¼Œä¸€æ—¦ä¸è¿œç¨‹å­˜å‚¨çš„è¿æ¥è¢«ä¿®å¤ï¼Œç¼“å†²çš„æŒ‡æ ‡å°±ä¼šè¢«å‘é€åˆ°è¿œç¨‹å­˜å‚¨ï¼Œç¼“å†²åŒºçš„æœ€å¤§ç£ç›˜ç”¨é‡å¯ä»¥ç”¨ <code>-remoteWrite.maxDiskUsagePerURL</code> æ¥é™åˆ¶ã€‚</li>
<li>ç›¸æ¯” prometheus ä½¿ç”¨æ›´å°‘çš„å†…å­˜ã€cpuã€ç£ç›˜ io ä»¥åŠç½‘ç»œå¸¦å®½</li>
<li>å½“éœ€è¦æŠ“å–å¤§é‡ç›®æ ‡æ—¶ï¼ŒæŠ“å–ç›®æ ‡å¯ä»¥åˆ†æ•£åˆ°å¤šä¸ª vmagent å®ä¾‹ä¸­</li>
<li>å¯ä»¥é€šè¿‡åœ¨æŠ“å–æ—¶é—´å’Œå°†å…¶å‘é€åˆ°è¿œç¨‹å­˜å‚¨ç³»ç»Ÿä¹‹å‰é™åˆ¶å”¯ä¸€æ—¶é—´åºåˆ—çš„æ•°é‡æ¥å¤„ç†é«˜åŸºæ•°å’Œé«˜æµå¤±ç‡é—®é¢˜</li>
<li>å¯ä»¥ä»å¤šä¸ªæ–‡ä»¶ä¸­åŠ è½½ scrape é…ç½®</li>
</ul>
<p><img src="https://picdn.youdianzhishi.com/images/1650529595671.jpg" alt="vmagent"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥æŠ“å– Kubernetes é›†ç¾¤æŒ‡æ ‡ä¸ºä¾‹è¯´æ˜å¦‚ä½•ä½¿ç”¨ vmagentï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨è‡ªåŠ¨å‘ç°çš„æ–¹å¼æ¥è¿›è¡Œé…ç½®ã€‚vmagent æ˜¯å…¼å®¹ prometheus ä¸­çš„ <code>kubernetes_sd_configs</code> é…ç½®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>è¦è®© vmagent è‡ªåŠ¨å‘ç°ç›‘æ§çš„èµ„æºå¯¹è±¡ï¼Œéœ€è¦è®¿é—® APIServer è·å–èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦é…ç½® rbac æƒé™ï¼Œåˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„èµ„æºæ¸…å•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ClusterRole
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">apiGroups</span>: [<span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#f1fa8c">&#34;networking.k8s.io&#34;</span>, <span style="color:#f1fa8c">&#34;extensions&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>      - nodes
</span></span><span style="display:flex;"><span>      - nodes/metrics
</span></span><span style="display:flex;"><span>      - services
</span></span><span style="display:flex;"><span>      - endpoints
</span></span><span style="display:flex;"><span>      - endpointslices
</span></span><span style="display:flex;"><span>      - pods
</span></span><span style="display:flex;"><span>      - app
</span></span><span style="display:flex;"><span>      - ingresses
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">verbs</span>: [<span style="color:#f1fa8c">&#34;get&#34;</span>, <span style="color:#f1fa8c">&#34;list&#34;</span>, <span style="color:#f1fa8c">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">apiGroups</span>: [<span style="color:#f1fa8c">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>      - namespaces
</span></span><span style="display:flex;"><span>      - configmaps
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">verbs</span>: [<span style="color:#f1fa8c">&#34;get&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">nonResourceURLs</span>: [<span style="color:#f1fa8c">&#34;/metrics&#34;</span>, <span style="color:#f1fa8c">&#34;/metrics/resources&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">verbs</span>: [<span style="color:#f1fa8c">&#34;get&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ClusterRoleBinding
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">apiGroup</span>: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">kind</span>: ClusterRole
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span></code></pre></div><p>ç„¶åæ·»åŠ  vmagent é…ç½®ï¼Œæˆ‘ä»¬å…ˆåªé…ç½®è‡ªåŠ¨å‘ç° Kubernetes èŠ‚ç‚¹çš„ä»»åŠ¡ï¼Œåˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„ ConfigMap å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape.yml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: nodes
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):10250&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}:9100&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_node_label_(.+)</span>    
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡è‡ªåŠ¨å‘ç° Kubernetes èŠ‚ç‚¹è·å–èŠ‚ç‚¹ç›‘æ§æŒ‡æ ‡ï¼Œéœ€è¦æ³¨æ„ <code>node</code> è¿™ç§ role çš„è‡ªåŠ¨å‘ç°é»˜è®¤è·å–çš„æ˜¯èŠ‚ç‚¹çš„ <code>10250</code> ç«¯å£ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦é€šè¿‡ <code>relabel</code> å°†å…¶ <code>replace</code> ä¸º <code>9100</code>ã€‚</p>
<p>ç„¶åæ·»åŠ  vmagent éƒ¨ç½²èµ„æºæ¸…å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-deploy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-pvc
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">storage</span>: 1Gi
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">storageClassName</span>: cfsauto
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">serviceAccountName</span>: vmagent
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: agent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#34;victoriametrics/vmagent:v1.91.3&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -promscrape.config=/config/scrape.yml
</span></span><span style="display:flex;"><span>            - -remoteWrite.tmpDataPath=/tmpData
</span></span><span style="display:flex;"><span>            - -remoteWrite.url=http://vminsert:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>            - -envflag.enable=true
</span></span><span style="display:flex;"><span>            - -envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - -loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /tmpData
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">claimName</span>: vmagent-pvc
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: vmagent-config
</span></span></code></pre></div><p>æˆ‘ä»¬å°† vmagent é…ç½®é€šè¿‡ ConfigMap æŒ‚è½½åˆ°å®¹å™¨ <code>/config/scrape.yml</code>ï¼Œå¦å¤–é€šè¿‡ <code>-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</code> æŒ‡å®šè¿œç¨‹å†™å…¥çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å†™å…¥å‰é¢çš„ vminsert æœåŠ¡ï¼Œå¦å¤–æœ‰ä¸€ä¸ªå‚æ•° <code>-remoteWrite.tmpDataPath</code>ï¼Œè¯¥è·¯å¾„ä¼šåœ¨è¿œç¨‹å­˜å‚¨ä¸å¯ç”¨çš„æ—¶å€™ç”¨æ¥ç¼“å­˜æ”¶é›†çš„æŒ‡æ ‡ï¼Œå½“è¿œç¨‹å­˜å‚¨ä¿®å¤åï¼Œç¼“å­˜çš„æŒ‡æ ‡å°±ä¼šè¢«æ­£å¸¸å‘é€åˆ°è¿œç¨‹å†™å…¥ï¼Œæ‰€ä»¥æœ€å¥½æŒä¹…åŒ–è¯¥ç›®å½•ã€‚</p>
<p>å•ä¸ª vmagent å®ä¾‹å¯ä»¥æŠ“å–æ•°ä¸‡ä¸ªæŠ“å–ç›®æ ‡ï¼Œä½†æ˜¯æœ‰æ—¶ç”±äº CPUã€ç½‘ç»œã€å†…å­˜ç­‰æ–¹é¢çš„é™åˆ¶ï¼Œè¿™è¿˜ä¸å¤Ÿã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŠ“å–ç›®æ ‡å¯ä»¥åœ¨å¤šä¸ª vmagent å®ä¾‹ä¹‹é—´è¿›è¡Œæ‹†åˆ†ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸ª vmagent å®ä¾‹å¿…é¡»ä½¿ç”¨å…·æœ‰ä¸åŒ <code>-promscrape.cluster.memberNum</code> å€¼çš„ç›¸åŒ <code>-promscrape.config</code> é…ç½®æ–‡ä»¶ï¼Œè¯¥å‚æ•°å€¼å¿…é¡»åœ¨ <code>0 ... N-1</code> èŒƒå›´å†…ï¼Œå…¶ä¸­ <code>N</code> æ˜¯é›†ç¾¤ä¸­ vmagent å®ä¾‹çš„æ•°é‡ã€‚é›†ç¾¤ä¸­ vmagent å®ä¾‹çš„æ•°é‡å¿…é¡»ä¼ é€’ç»™ <code>-promscrape.cluster.membersCount</code> å‘½ä»¤è¡Œæ ‡å¿—ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å‘½ä»¤å¯ä»¥åœ¨ä¸¤ä¸ª vmagent å®ä¾‹çš„é›†ç¾¤ä¸­ä¼ æ’­æŠ“å–ç›®æ ‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/config.yml ...
</span></span><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/config.yml ...
</span></span></code></pre></div><p>å½“ vmagent åœ¨ Kubernetes ä¸­è¿è¡Œæ—¶ï¼Œå¯ä»¥å°† <code>-promscrape.cluster.memberNum</code> è®¾ç½®ä¸º StatefulSet pod åç§°ï¼Œpod åç§°å¿…é¡»ä»¥ <code>0 ... promscrape.cluster.memberNum-1</code> èŒƒå›´å†…çš„æ•°å­—ç»“å°¾ï¼Œä¾‹å¦‚ï¼Œ<code>-promscrape.cluster.memberNum=vmagent-0</code>ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæŠ“å–ç›®æ ‡ä»…ç”±é›†ç¾¤ä¸­çš„å•ä¸ª vmagent å®ä¾‹æŠ“å–ã€‚å¦‚æœéœ€è¦åœ¨å¤šä¸ª vmagent å®ä¾‹ä¹‹é—´å¤åˆ¶æŠ“å–ç›®æ ‡ï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>-promscrape.cluster.replicationFactor</code> å‚æ•°è®¾ç½®ä¸ºæ‰€éœ€çš„å‰¯æœ¬æ•°ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ä¸€ä¸ªåŒ…å«ä¸‰ä¸ª vmagent å®ä¾‹çš„é›†ç¾¤ï¼Œå…¶ä¸­æ¯ä¸ªç›®æ ‡ç”±ä¸¤ä¸ª vmagent å®ä¾‹æŠ“å–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> -promscrape.cluster.replicationFactor<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/to/config.yml ...
</span></span><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> -promscrape.cluster.replicationFactor<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/to/config.yml ...
</span></span><span style="display:flex;"><span>vmagent -promscrape.cluster.membersCount<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span> -promscrape.cluster.replicationFactor<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.cluster.memberNum<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> -promscrape.config<span style="color:#ff79c6">=</span>/path/to/config.yml ...
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæ¯ä¸ªç›®æ ‡è¢«å¤šä¸ª vmagent å®ä¾‹æŠ“å–ï¼Œåˆ™å¿…é¡»åœ¨ <code>-remoteWrite.url</code> æŒ‡å‘çš„è¿œç¨‹å­˜å‚¨ä¸Šå¯ç”¨é‡å¤æ•°æ®åˆ é™¤ã€‚</p>
<p>æ‰€ä»¥å¦‚æœä½ æŠ“å–çš„ç›‘æ§ç›®æ ‡éå¸¸å¤§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å»ºè®®ä½¿ç”¨ vmagent é›†ç¾¤æ¨¡å¼ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ StatefulSet æ–¹å¼è¿›è¡Œéƒ¨ç½²</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-sts.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">prometheus.io/scrape</span>: <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">prometheus.io/port</span>: <span style="color:#f1fa8c">&#34;8429&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">clusterIP</span>: None
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: StatefulSet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceName</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">serviceAccountName</span>: vmagent
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: agent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/vmagent:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -promscrape.config=/config/scrape.yml
</span></span><span style="display:flex;"><span>            - -remoteWrite.tmpDataPath=/tmpData
</span></span><span style="display:flex;"><span>            - -promscrape.cluster.membersCount=2
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># - -promscrape.cluster.replicationFactor=2 # å¯ä»¥é…ç½®å‰¯æœ¬æ•°</span>
</span></span><span style="display:flex;"><span>            - -promscrape.cluster.memberNum=$(POD_NAME)
</span></span><span style="display:flex;"><span>            - -remoteWrite.url=http://vminsert:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>            - -envflag.enable=true
</span></span><span style="display:flex;"><span>            - -envflag.prefix=VM_
</span></span><span style="display:flex;"><span>            - -loggerFormat=json
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: POD_NAME
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">valueFrom</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">fieldRef</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#ff79c6">fieldPath</span>: metadata.name
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /tmpData
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">mountPath</span>: /config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: vmagent-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">volumeClaimTemplates</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: tmpdata
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>          - ReadWriteOnce
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">storageClassName</span>: cfsauto
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">storage</span>: 1Gi
</span></span></code></pre></div><p>æˆ‘ä»¬è¿™é‡Œå°±ä½¿ç”¨ StatefulSet çš„å½¢å¼æ¥ç®¡ç† vmagentï¼Œç›´æ¥åº”ç”¨ä¸Šé¢çš„èµ„æºå³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># å…ˆå°†å‰é¢ç¤ºä¾‹ä¸­çš„ prometheus åœæ‰</span>
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl scale deploy prometheus --replicas<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> -n kube-vm
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmagent-rbac.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmagent-config.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmagent-sts.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmagent
</span></span><span style="display:flex;"><span>NAME        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmagent-0   1/1     Running   <span style="color:#bd93f9">0</span>          3m43s
</span></span><span style="display:flex;"><span>vmagent-1   1/1     Running   <span style="color:#bd93f9">0</span>          2m9s
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬éƒ¨ç½²äº†ä¸¤ä¸ª vmagent å®ä¾‹æ¥æŠ“å–ç›‘æ§æŒ‡æ ‡ï¼Œæˆ‘ä»¬è¿™é‡Œä¸€å…± 3 ä¸ªèŠ‚ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME      STATUS   ROLES           AGE    VERSION
</span></span><span style="display:flex;"><span>master1   Ready    control-plane   132d   v1.26.2
</span></span><span style="display:flex;"><span>node1     Ready    &lt;none&gt;          113d   v1.26.3
</span></span><span style="display:flex;"><span>node2     Ready    &lt;none&gt;          132d   v1.26.2
</span></span></code></pre></div><p>æ‰€ä»¥ä¸¤ä¸ª vmagent å®ä¾‹ä¼šåˆ†åˆ«é‡‡é›†éƒ¨åˆ†æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ—¥å¿—æ¥è¿›è¡ŒéªŒè¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl logs -f vmagent-0 -n kube-vm
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:16:49.992Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/discovery/kubernetes/api_watcher.go:641&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;reloaded 3 objects from \&#34;https://10.96.0.1:443/api/v1/nodes\&#34; in 0.007s; updated=0, removed=0, added=3, resourceVersion=\&#34;31199642\&#34;&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:16:49.992Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/config.go:128&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;started service discovery routines in 0.007 seconds&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:16:49.993Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/scraper.go:431&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes_sd_configs: added targets: 1, removed targets: 0; total targets: 1&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl logs -f vmagent-1 -n kube-vm
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:17:51.516Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/config.go:128&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;started service discovery routines in 0.007 seconds&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;ts&#34;</span>:<span style="color:#f1fa8c">&#34;2023-07-20T07:17:51.517Z&#34;</span>,<span style="color:#f1fa8c">&#34;level&#34;</span>:<span style="color:#f1fa8c">&#34;info&#34;</span>,<span style="color:#f1fa8c">&#34;caller&#34;</span>:<span style="color:#f1fa8c">&#34;VictoriaMetrics/lib/promscrape/scraper.go:431&#34;</span>,<span style="color:#f1fa8c">&#34;msg&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes_sd_configs: added targets: 2, removed targets: 0; total targets: 2&#34;</span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>ä»æ—¥å¿—å¯ä»¥çœ‹å‡º <code>vmagent-0</code> å®ä¾‹å‘ç°äº† 1 ä¸ª targetsï¼Œ<code>vmagent-1</code> å®ä¾‹å‘ç°äº† 2 ä¸ª targetsï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†æ–°å¢å…¶ä»–å†…å®¹çš„ç›‘æ§ï¼Œæ¯”å¦‚ APIServerã€å®¹å™¨ç­‰ç­‰ï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-config2.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape.yml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_interval: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scrape_timeout: 15s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: nodes
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels: [__address__]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: &#34;(.*):10250&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: &#34;${1}:9100&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        insecure_skip_verify: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - role: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: default;kubernetes;https
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_endpoint_port_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: cadvisor
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        insecure_skip_verify: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - replacement: /metrics/cadvisor
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - job_name: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - role: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: drop
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_container_init
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: keep_if_equal
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_port
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_container_port_number
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_scrape
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: (https?)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_scheme
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __scheme__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_path
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: ([^:]+)(?::\d+)?;(\d+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        replacement: $1:$2
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_annotation_prometheus_io_port
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        regex: __meta_kubernetes_service_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: service
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - replacement: ${1}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_service_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: job
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        source_labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        - __meta_kubernetes_pod_node_name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        target_label: node</span>    
</span></span></code></pre></div><p>å¤§éƒ¨åˆ†çš„é…ç½®åœ¨å‰é¢ Prometheus ç« èŠ‚éƒ½ä»‹ç»è¿‡äº†ï¼Œæ ¸å¿ƒå°±æ˜¯é€šè¿‡ <code>relabel_configs</code> æ¥æ§åˆ¶æŠ“å–çš„ä»»åŠ¡ï¼Œvmagent æ˜¯å…¼å®¹ä¼ ç»Ÿçš„ prometheus é‡æ–°æ ‡è®°è§„åˆ™çš„ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ç‹¬ç‰¹çš„ actionï¼Œæ¯”å¦‚ä¸Šé¢é…ç½®ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª <code>keep_if_equal</code> çš„æ“ä½œï¼Œè¯¥æ“ä½œçš„æ„æ€æ˜¯<strong>å¦‚æœæŒ‡å®šçš„æ ‡ç­¾å€¼ç›¸ç­‰åˆ™å°†è¯¥æ¡æ•°æ®ä¿ç•™ä¸‹æ¥</strong>ã€‚</p>
<p>æœ‰æ—¶ï¼Œå¦‚æœæŸä¸ªæŒ‡æ ‡åŒ…å«ä¸¤ä¸ªå…·æœ‰ç›¸åŒå€¼çš„æ ‡ç­¾ï¼Œåˆ™éœ€è¦åˆ é™¤å®ƒã€‚è¿™å¯ä»¥é€šè¿‡ vmagent æ”¯æŒçš„ <code>drop_if_equal</code> æ“ä½œæ¥å®Œæˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»¥ä¸‹ relabel è§„åˆ™åŒ…å« <code>real_port</code> å’Œ <code>required_port</code> çš„ç›¸åŒæ ‡ç­¾å€¼ï¼Œåˆ™å®ƒä¼šåˆ é™¤æŒ‡æ ‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">action</span>: drop_if_equal
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">source_labels</span>: [real_port, needed_port]
</span></span></code></pre></div><p>è¯¥è§„åˆ™å°†åˆ é™¤ä»¥ä¸‹æŒ‡æ ‡ï¼š<code>foo{real_port=&quot;123&quot;,needed_port=&quot;123&quot;}</code>ï¼Œä½†ä¼šä¿ç•™ä»¥ä¸‹æŒ‡æ ‡ï¼š<code>foo{real_port=&quot;123&quot;,needed_port=&quot;456&quot;}</code>ã€‚</p>
<p>æœ‰æ—¶å¯èƒ½éœ€è¦åªå¯¹æŒ‡æ ‡å­é›†åº”ç”¨ relabelï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°† <code>if</code> é€‰é¡¹æ·»åŠ åˆ° <code>relabel_configs</code> è§„åˆ™ä¸­ï¼Œä¾‹å¦‚ä»¥ä¸‹è§„åˆ™ä»…å°† <code>{foo=&quot;bar&quot;}</code> æ ‡ç­¾æ·»åŠ åˆ°ä¸ <code>metric{label=~&quot;x|y&quot;}</code> åºåˆ—é€‰æ‹©å™¨åŒ¹é…çš„æŒ‡æ ‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">if</span>: <span style="color:#f1fa8c">&#39;metric{label=~&#34;x|y&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">target_label</span>: <span style="color:#f1fa8c">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replacement</span>: <span style="color:#f1fa8c">&#34;bar&#34;</span>
</span></span></code></pre></div><p><code>if</code> é€‰é¡¹å¯ä»¥ç®€åŒ–ä¼ ç»Ÿçš„ <code>relabel_configs</code> è§„åˆ™ï¼Œä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å¯ä»¥åˆ é™¤ä¸ <code>foo{bar=&quot;baz&quot;}</code> åºåˆ—é€‰æ‹©å™¨åŒ¹é…çš„æŒ‡æ ‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">if</span>: <span style="color:#f1fa8c">&#39;foo{bar=&#34;baz&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">action</span>: drop
</span></span></code></pre></div><p>è¿™ç›¸å½“äºä»¥ä¸‹ä¼ ç»Ÿçš„è§„åˆ™ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">action</span>: drop
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">source_labels</span>: [__name__, bar]
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">regex</span>: <span style="color:#f1fa8c">&#34;foo;baz&#34;</span>
</span></span></code></pre></div><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ Prometheus è¿˜ä¸æ”¯æŒ <code>if</code> é€‰é¡¹ï¼Œç°åœ¨åªæ”¯æŒ VictoriaMetricsã€‚</p>
<p>ç°åœ¨æ›´æ–° vmagent çš„é…ç½®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmagent-config2.yaml
</span></span></code></pre></div><p>é…ç½®åˆ·æ–°æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>å‘é€ SUGHUP ä¿¡å·ç»™ vmagent è¿›ç¨‹</li>
<li>å‘ <code>http://vmagent:8429/-/reload</code> å‘é€ä¸€ä¸ª http è¯·æ±‚</li>
</ul>
<p>åˆ·æ–°åå°±å¯ä»¥å¼€å§‹é‡‡é›†ä¸Šé¢çš„æŒ‡æ ‡äº†ï¼ŒåŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>http://vmselect/select/0/vmui/</code> æ¥è®¿é—® vmuiï¼Œæ¯”å¦‚ç°åœ¨æˆ‘ä»¬æ¥æŸ¥è¯¢ pod çš„å†…å­˜ä½¿ç”¨ç‡ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æŸ¥è¯¢è¯­å¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-promql" data-lang="promql"><span style="display:flex;"><span><span style="color:#ff79c6">sum</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">container_memory_working_set_bytes</span>{<span style="color:#8be9fd;font-style:italic">image</span><span style="color:#ff79c6">!=</span>&#34;&#34;}<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">by</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">namespace</span>, <span style="color:#8be9fd;font-style:italic">pod</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">/</span> <span style="color:#ff79c6">sum</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">container_spec_memory_limit_bytes</span>{<span style="color:#8be9fd;font-style:italic">image</span><span style="color:#ff79c6">!=</span>&#34;&#34;}<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">by</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">namespace</span>, <span style="color:#8be9fd;font-style:italic">pod</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">100</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">inf</span>
</span></span></code></pre></div><p><img src="https://picdn.youdianzhishi.com/images/1689837957284.jpg" alt="vmui"></p>
<p>vmagent ä½œä¸ºé‡‡é›†æŒ‡æ ‡é‡è¦çš„ä¸€ç¯ï¼Œå½“ç„¶å¯¹å®ƒçš„ç›‘æ§ä¹Ÿä¸å¯å°‘ã€‚vmagent é€šè¿‡ <code>http://vmagent:8429/metrics</code> æš´éœ²äº†å¾ˆå¤šæŒ‡æ ‡ï¼Œå¦‚ <code>vmagent_remotewrite_conns</code> è¿œç¨‹å­˜å‚¨è¿æ¥ï¼Œ<code>vm_allowed_memory_bytes</code> å¯ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œæˆ‘ä»¬æŠŠä¸€äº›é‡è¦çš„æŒ‡æ ‡æ”¶é›†èµ·æ¥ï¼Œé€šè¿‡ Grafana è¿›è¡Œå±•ç¤ºï¼Œèƒ½å¤Ÿæ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬åˆ†æ vmagent çš„çŠ¶æ€ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a href="https://grafana.com/grafana/dashboards/12683">https://grafana.com/grafana/dashboards/12683</a> æ¥å±•ç¤º vmagent çš„çŠ¶æ€ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689838110423.jpg" alt="vmagent grafana"></p>
<p>æ­¤å¤–å¦‚æœæƒ³è¦æŸ¥çœ‹ vmagent çš„æŠ“å–çš„ targetsï¼Œä¹Ÿé€šè¿‡é€šè¿‡ vmagent æä¾›çš„ç®€å•é¡µé¢æŸ¥çœ‹ï¼Œä¸è¿‡åªèƒ½æŸ¥çœ‹åˆ°æŒ‡å®š vmagent çš„ï¼Œä¸èƒ½ç›´æ¥æŸ¥çœ‹æ‰€æœ‰çš„ targetsï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³æŸ¥çœ‹ vmagent-1 è¿™ä¸ªå®ä¾‹çš„æ•°æ®ï¼Œå¯ä»¥å•ç‹¬ä¸ºè¯¥å®ä¾‹åˆ›å»ºä¸€ä¸ª Serviceï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmagent
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">statefulset.kubernetes.io/pod-name</span>: vmagent-1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span></code></pre></div><p>ç„¶åé€šè¿‡ NodePort å°±å¯ä»¥è®¿é—®è¯¥å®ä¾‹çš„æ•°æ®äº†ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1689838355437.jpg" alt="vmagent targets"></p>
<h2 id="vmalert">vmalert</h2>
<p>å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»äº†å¯ä»¥ä½¿ç”¨ vmagent ä»£æ›¿ prometheus æŠ“å–ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œè¦æƒ³å®Œå…¨æ›¿æ¢ prometheus è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„éƒ¨åˆ†å°±æ˜¯æŠ¥è­¦æ¨¡å—ï¼Œä¹‹å‰æˆ‘ä»¬éƒ½æ˜¯åœ¨ prometheus ä¸­å®šä¹‰æŠ¥è­¦è§„åˆ™è¯„ä¼°åå‘é€ç»™ alertmanager çš„ï¼ŒåŒæ ·å¯¹åº”åˆ° vm ä¸­ä¹Ÿæœ‰ä¸€ä¸ªä¸“é—¨æ¥å¤„ç†æŠ¥è­¦çš„æ¨¡å—ï¼š<code>vmalert</code>ã€‚</p>
<p>vmalert ä¼šé’ˆå¯¹ <code>-datasource.url</code> åœ°å€æ‰§è¡Œé…ç½®çš„æŠ¥è­¦æˆ–è®°å½•è§„åˆ™ï¼Œç„¶åå¯ä»¥å°†æŠ¥è­¦å‘é€ç»™ <code>-notifier.url</code> é…ç½®çš„ Alertmanagerï¼Œè®°å½•è§„åˆ™ç»“æœä¼šé€šè¿‡è¿œç¨‹å†™å…¥çš„åè®®è¿›è¡Œä¿å­˜ï¼Œæ‰€ä»¥éœ€è¦é…ç½® <code>-remoteWrite.url</code>ã€‚</p>
<h3 id="ç‰¹æ€§">ç‰¹æ€§</h3>
<ul>
<li>ä¸ VictoriaMetrics TSDB é›†æˆ</li>
<li>VictoriaMetrics MetricsQL æ”¯æŒå’Œè¡¨è¾¾å¼éªŒè¯</li>
<li>Prometheus å‘Šè­¦è§„åˆ™å®šä¹‰æ ¼å¼æ”¯æŒ</li>
<li>ä¸ Alertmanager é›†æˆ</li>
<li>åœ¨é‡å¯æ—¶å¯ä»¥ä¿æŒæŠ¥è­¦çŠ¶æ€</li>
<li>Graphite æ•°æ®æºå¯ç”¨äºè­¦æŠ¥å’Œè®°å½•è§„åˆ™</li>
<li>æ”¯æŒè®°å½•å’ŒæŠ¥è­¦è§„åˆ™é‡æ”¾</li>
<li>éå¸¸è½»é‡çº§ï¼Œæ²¡æœ‰é¢å¤–çš„ä¾èµ–</li>
</ul>
<p>è¦å¼€å§‹ä½¿ç”¨ vmalertï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>æŠ¥è­¦è§„åˆ™åˆ—è¡¨ï¼šè¦æ‰§è¡Œçš„ PromQL/MetricsQL è¡¨è¾¾å¼</li>
<li>æ•°æ®æºåœ°å€ï¼šå¯è®¿é—®çš„ VictoriaMetrics å®ä¾‹ï¼Œç”¨äºè§„åˆ™æ‰§è¡Œ</li>
<li>é€šçŸ¥ç¨‹åºåœ°å€ï¼šå¯è®¿é—®çš„ Alertmanager å®ä¾‹ï¼Œç”¨äºå¤„ç†ï¼Œæ±‡æ€»è­¦æŠ¥å’Œå‘é€é€šçŸ¥</li>
</ul>
<h3 id="å®‰è£…">å®‰è£…</h3>
<p>é¦–å…ˆéœ€è¦å®‰è£…ä¸€ä¸ª Alertmanager ç”¨æ¥æ¥æ”¶æŠ¥è­¦ä¿¡æ¯ï¼Œå‰é¢ç« èŠ‚ä¸­æˆ‘ä»¬å·²ç»è¯¦ç»†è®²è§£è¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°äº†ï¼Œå¯¹åº”çš„èµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># alertmanager.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: alert-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">config.yml</span>: |-<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      resolve_timeout: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_smarthost: &#39;smtp.qq.com:465&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_from: &#39;xxx@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_auth_username: &#39;xxx@qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_auth_password: &#39;&lt;auth code&gt;&#39;  # ä½¿ç”¨QQé‚®ç®±çš„æˆæƒç 
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_hello: &#39;qq.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      smtp_require_tls: false
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    route:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      group_by: [&#39;severity&#39;, &#39;source&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      group_wait: 30s
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      group_interval: 5m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      repeat_interval: 24h
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      receiver: email
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    receivers:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: &#39;email&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      email_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - to: &#39;ych_1024@163.com&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        send_resolved: true</span>    
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: web
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">9093</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: http
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: alertmanager
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: alertcfg
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: alert-config
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: alertmanager
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: prom/alertmanager:v0.25.0
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f1fa8c">&#34;--config.file=/etc/alertmanager/config.yml&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">9093</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: <span style="color:#f1fa8c">&#34;/etc/alertmanager&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: alertcfg
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 100m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 256Mi
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">cpu</span>: 100m
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">memory</span>: 256Mi
</span></span></code></pre></div><p>Alertmanager è¿™é‡Œæˆ‘ä»¬åªé…ç½®äº†ä¸€ä¸ªé»˜è®¤çš„è·¯ç”±è§„åˆ™ï¼Œæ ¹æ® <code>severity</code>ã€<code>source</code> ä¸¤ä¸ªæ ‡ç­¾è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå°†è§¦å‘çš„æŠ¥è­¦å‘é€åˆ° email æ¥æ”¶å™¨ä¸­å»ã€‚</p>
<p>æ¥ä¸‹æ¥éœ€è¦æ·»åŠ ç”¨äºæŠ¥è­¦çš„è§„åˆ™é…ç½®ï¼Œé…ç½®æ–¹å¼å’Œ Prometheus ä¸€æ ·çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmalert-config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: ConfigMap
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmalert-config
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">record.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: record
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      rules:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - record: job:node_memory_MemFree_bytes:percent  # è®°å½•è§„åˆ™åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">pod.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      rules:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - alert: PodMemoryUsage
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        expr: sum(container_memory_working_set_bytes{pod!=&#34;&#34;}) BY (instance, pod)  / sum(container_spec_memory_limit_bytes{pod!=&#34;&#34;} &gt; 0) BY (instance, pod) * 100 &gt; 60
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        for: 1m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          severity: warning
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          source: pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          summary: &#34;Pod {{ $labels.pod }} High Memory usage detected&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          description: &#34;{{$labels.instance}}: Pod {{ $labels.pod }} Memory usage is above 60% (current value is: {{ $value }})&#34;</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">node.yaml</span>: |<span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    groups:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    - name: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      rules:  # å…·ä½“çš„æŠ¥è­¦è§„åˆ™
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      - alert: NodeMemoryUsage  # æŠ¥è­¦è§„åˆ™çš„åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        for: 1m
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        labels:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          source: node
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          severity: critical
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          summary: &#34;Node {{$labels.instance}} High Memory usage detected&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          description: &#34;{{$labels.instance}}: Memory usage is above 30% (current value is: {{ $value }})&#34;</span>    
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬æ·»åŠ äº†ä¸€æ¡è®°å½•è§„åˆ™ï¼Œä¸¤æ¡æŠ¥è­¦è§„åˆ™ï¼Œæ›´å¤šæŠ¥è­¦è§„åˆ™é…ç½®å¯å‚è€ƒ <a href="https://awesome-prometheus-alerts.grep.to/">https://awesome-prometheus-alerts.grep.to/</a>ã€‚</p>
<p>ç„¶åå°±å¯ä»¥éƒ¨ç½² vmalert ç»„ä»¶æœåŠ¡äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmalert.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">targetPort</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">type</span>: NodePort
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: kube-vm
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: vmalert
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: vmalert
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: victoriametrics/vmalert:v1.91.3
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>            - -rule=/etc/ruler/*.yaml
</span></span><span style="display:flex;"><span>            - -datasource.url=http://vmselect.kube-vm.svc.cluster.local:8481/select/0/prometheus
</span></span><span style="display:flex;"><span>            - -notifier.url=http://alertmanager.kube-vm.svc.cluster.local:9093
</span></span><span style="display:flex;"><span>            - -remoteWrite.url=http://vminsert.kube-vm.svc.cluster.local:8480/insert/0/prometheus
</span></span><span style="display:flex;"><span>            - -evaluationInterval=15s
</span></span><span style="display:flex;"><span>            - -httpListenAddr=0.0.0.0:8080
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">mountPath</span>: /etc/ruler/
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">name</span>: ruler
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">name</span>: vmalert-config
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">name</span>: ruler
</span></span></code></pre></div><p>ä¸Šé¢çš„èµ„æºæ¸…å•ä¸­å°†æŠ¥è­¦è§„åˆ™ä»¥ volumes çš„å½¢å¼æŒ‚è½½åˆ°äº†å®¹å™¨ä¸­ï¼Œé€šè¿‡ <code>-rule</code> æŒ‡å®šäº†è§„åˆ™æ–‡ä»¶è·¯å¾„ï¼Œ<code>-datasource.url</code> æŒ‡å®šäº† vmselect çš„è·¯å¾„ï¼Œ<code>-notifier.url</code> æŒ‡å®šäº† Alertmanager çš„åœ°å€ï¼Œå…¶ä¸­ <code>-evaluationInterval</code> å‚æ•°ç”¨æ¥æŒ‡å®šè¯„ä¼°çš„é¢‘ç‡çš„ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œæ·»åŠ äº†è®°å½•è§„åˆ™ï¼Œæ‰€ä»¥è¿˜éœ€è¦é€šè¿‡ <code>-remoteWrite.url</code> æŒ‡å®šä¸€ä¸ªè¿œç¨‹å†™å…¥çš„åœ°å€ã€‚</p>
<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºæ¸…å•å³å¯å®Œæˆéƒ¨ç½²ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f alertmanager.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmalert-config.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmalert.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>alertmanager
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>alertmanager-d88d95b4f-z2j8g   1/1     Running   <span style="color:#bd93f9">0</span>          30m
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>alertmanager
</span></span><span style="display:flex;"><span>NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>alertmanager   NodePort   10.102.116.226   &lt;none&gt;        9093:32363/TCP   2m19s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmalert
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vmalert-5dd4864b95-r6dwx   1/1     Running   <span style="color:#bd93f9">0</span>          46s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc -n kube-vm -l <span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span>vmalert
</span></span><span style="display:flex;"><span>NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>          AGE
</span></span><span style="display:flex;"><span>vmalert   NodePort   10.104.105.125   &lt;none&gt;        8080:31928/TCP   57s
</span></span></code></pre></div><p>éƒ¨ç½²æˆåŠŸåï¼Œå¦‚æœæœ‰æŠ¥è­¦è§„åˆ™è¾¾åˆ°äº†é˜ˆå€¼å°±ä¼šè§¦å‘æŠ¥è­¦ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Alertmanager é¡µé¢æŸ¥çœ‹è§¦å‘çš„æŠ¥è­¦è§„åˆ™ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011456503.png" alt="alertmanager"></p>
<p>åŒæ · vmalert ä¹Ÿæä¾›äº†ä¸€ä¸ªç®€å•çš„é¡µé¢ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„ Groupsï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011571591.jpg" alt="groups"></p>
<p>ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°æŠ¥è­¦è§„åˆ™åˆ—è¡¨çš„çŠ¶æ€ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011657551.jpg" alt="alerts"></p>
<p>è¿˜å¯ä»¥æŸ¥çœ‹åˆ°å…·ä½“çš„ä¸€æ¡æŠ¥è­¦è§„åˆ™çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011724527.jpg" alt="alert detail"></p>
<p>æŠ¥è­¦è§„åˆ™è§¦å‘åæ€ä¹ˆå‘é€ï¼Œå‘é€åˆ°å“ªä¸ªæ¥æ”¶å™¨å°±æ˜¯ Alertmanager å†³å®šçš„äº†ã€‚</p>
<p>åŒæ ·çš„ä¸Šé¢æˆ‘ä»¬æ·»åŠ çš„è®°å½•è§„åˆ™ä¼šé€šè¿‡ remote write ä¼ é€’ç»™ vminsert ä¿ç•™ä¸‹æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ vmselect æŸ¥è¯¢åˆ°ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690011834717.jpg" alt="è®°å½•è§„åˆ™"></p>
<p>åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šæˆ‘ä»¬å°±å®Œæˆäº†ä½¿ç”¨ vm ä»£æ›¿ prometheus æ¥è¿›è¡Œç›‘æ§æŠ¥è­¦äº†ï¼Œvmagent é‡‡é›†ç›‘æ§æŒ‡æ ‡ï¼Œvmalert ç”¨äºæŠ¥è­¦ç›‘æ§ï¼Œvmstorage å­˜å‚¨æŒ‡æ ‡æ•°æ®ï¼Œvminsert æ¥æ”¶æŒ‡æ ‡æ•°æ®ï¼Œvmselect æŸ¥è¯¢æŒ‡æ ‡æ•°æ®ï¼Œå·²ç»å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨ prometheus äº†ï¼Œè€Œä¸”æ€§èƒ½éå¸¸é«˜ï¼Œæ‰€éœ€èµ„æºä¹Ÿæ¯” prometheus ä½å¾ˆå¤šã€‚</p>
<h2 id="victoriametrics-operator">VictoriaMetrics Operator</h2>
<p>Operator æˆ‘ä»¬çŸ¥é“æ˜¯ Kubernetes çš„ä¸€å¤§æ€å™¨ï¼Œå¯ä»¥å¤§å¤§ç®€åŒ–åº”ç”¨çš„å®‰è£…ã€é…ç½®å’Œç®¡ç†ï¼ŒåŒæ ·å¯¹äº VictoriaMetrics å®˜æ–¹ä¹Ÿå¼€å‘äº†ä¸€ä¸ªå¯¹åº”çš„ Operator æ¥è¿›è¡Œç®¡ç† - <code>VictoriaMetrics Operator</code>ï¼Œå®ƒçš„è®¾è®¡å’Œå®ç°çµæ„Ÿæ¥è‡ª Prometheus Operatorï¼Œå®ƒæ˜¯ç®¡ç†åº”ç”¨ç¨‹åºç›‘æ§é…ç½®çš„ç»ä½³å·¥å…·ã€‚</p>
<p>VictoriaMetrics Operator å®šä¹‰äº†å¦‚ä¸‹ä¸€äº› CRDï¼š</p>
<ul>
<li><code>VMServiceScrape</code>ï¼šå®šä¹‰ä» Service æ”¯æŒçš„ Pod ä¸­æŠ“å–æŒ‡æ ‡é…ç½®</li>
<li><code>VMPodScrape</code>ï¼šå®šä¹‰ä» Pod ä¸­æŠ“å–æŒ‡æ ‡é…ç½®</li>
<li><code>VMRule</code>ï¼šå®šä¹‰æŠ¥è­¦å’Œè®°å½•è§„åˆ™</li>
<li><code>VMProbe</code>ï¼šä½¿ç”¨ blackbox exporter ä¸ºç›®æ ‡å®šä¹‰æ¢æµ‹é…ç½®</li>
</ul>
<p>æ­¤å¤–è¯¥ Operator é»˜è®¤è¿˜å¯ä»¥è¯†åˆ« Prometheus Operator ä¸­çš„ <code>ServiceMonitor</code>ã€<code>PodMonitor</code>ã€<code>PrometheusRule</code> å’Œ <code>Probe</code> å¯¹è±¡ï¼Œè¿˜å…è®¸ä½ ä½¿ç”¨ CRD å¯¹è±¡æ¥ç®¡ç† Kubernetes é›†ç¾¤å†…çš„ VM åº”ç”¨ã€‚</p>
<h3 id="å®‰è£…-1">å®‰è£…</h3>
<p>VictoriaMetrics Operator æä¾›äº† Helm Charts åŒ…ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ Helm æ¥è¿›è¡Œä¸€é”®å®‰è£…ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ helm repo add vm https://victoriametrics.github.io/helm-charts/
</span></span><span style="display:flex;"><span>â˜¸ âœ helm repo update
</span></span></code></pre></div><p>æ ¹æ®è‡ªå·±çš„éœ€è¦å®šåˆ¶ values å€¼ï¼Œé»˜è®¤çš„ <code>values.yaml</code> å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è·å¾—ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ helm show values vm/victoria-metrics-operator &gt; values.yaml
</span></span></code></pre></div><p>æˆ‘ä»¬è¿™é‡Œåªå¯¹ä¸‹é¢çš„å†…å®¹åšäº†ä¿®æ”¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># values.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">operator</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- é»˜è®¤æƒ…å†µä¸‹ï¼Œvm operatorä¼šè½¬æ¢prometheus operatorå¯¹è±¡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">disable_prometheus_converter</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- é»˜è®¤æƒ…å†µä¸‹ï¼Œvm operatorä¼šä¸ºå®ƒçš„å¯¹è±¡åˆ›å»ºpsp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">psp_auto_creation_enabled</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- å¯ç”¨è½¬æ¢åçš„ prometheus-operator å¯¹è±¡çš„æ‰€æœ‰æƒå¼•ç”¨ï¼Œå¦‚æœåˆ é™¤ prometheus å¯¹è±¡ï¼Œå®ƒå°†åˆ é™¤ç›¸åº”çš„ victoria-metrics å¯¹è±¡ã€‚</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">enable_converter_ownership</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># -- å¯ç”¨è‡ªå®šä¹‰é…ç½® reloaderï¼Œä¸ operator æ†ç»‘åœ¨ä¸€èµ·</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">useCustomConfigReloader</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># -- æ˜¯å¦å¼€å¯èµ„æºæ ¡éªŒçš„å‡†å…¥æ§åˆ¶å™¨(ç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">admissionWebhooks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">false</span>
</span></span></code></pre></div><p>ç„¶åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯ä¸€é”®å®‰è£… vm-operatorï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ helm upgrade --install victoria-metrics-operator vm/victoria-metrics-operator -f values.yaml -n vmoperator --create-namespace
</span></span><span style="display:flex;"><span>Release <span style="color:#f1fa8c">&#34;victoria-metrics-operator&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex;"><span>NAME: victoria-metrics-operator
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Sat Jul <span style="color:#bd93f9">22</span> 15:51:39 <span style="color:#bd93f9">2023</span>
</span></span><span style="display:flex;"><span>NAMESPACE: vmoperator
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>TEST SUITE: None
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>victoria-metrics-operator has been installed. Check its status by running:
</span></span><span style="display:flex;"><span>  kubectl --namespace vmoperator get pods -l <span style="color:#f1fa8c">&#34;app.kubernetes.io/instance=victoria-metrics-operator&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.
</span></span><span style="display:flex;"><span>See <span style="color:#f1fa8c">&#34;Getting started guide for VM Operator&#34;</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator.html .
</span></span></code></pre></div><p>å®‰è£…å®Œæˆåå¯ä»¥æŸ¥çœ‹ vmoperator çš„çŠ¶æ€æ¥éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ helm ls -n vmoperator
</span></span><span style="display:flex;"><span>WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/cnych/.kube/config
</span></span><span style="display:flex;"><span>WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/cnych/.kube/config
</span></span><span style="display:flex;"><span>NAME                            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                APP VERSION
</span></span><span style="display:flex;"><span>victoria-metrics-operator       vmoperator      <span style="color:#bd93f9">1</span>               2023-07-22 15:53:45.998328 +0800 CST    deployed        victoria-metrics-operator-0.24.1     0.35.
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl -n vmoperator get pods -l <span style="color:#f1fa8c">&#34;app.kubernetes.io/instance=victoria-metrics-operator&#34;</span>
</span></span><span style="display:flex;"><span>NAME                                         READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>victoria-metrics-operator-77f66c87c5-pbf9w   1/1     Running   <span style="color:#bd93f9">0</span>          12m
</span></span></code></pre></div><h3 id="å®‰è£…-vm-é›†ç¾¤">å®‰è£… VM é›†ç¾¤</h3>
<p>Operator å®‰è£…å®Œæˆåä¼šåŒ…å«å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€äº› CRDï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl get crd |grep victoriametrics
</span></span><span style="display:flex;"><span>vmagents.operator.victoriametrics.com                2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmalertmanagerconfigs.operator.victoriametrics.com   2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmalertmanagers.operator.victoriametrics.com         2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmalerts.operator.victoriametrics.com                2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmauths.operator.victoriametrics.com                 2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmclusters.operator.victoriametrics.com              2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmnodescrapes.operator.victoriametrics.com           2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmpodscrapes.operator.victoriametrics.com            2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmprobes.operator.victoriametrics.com                2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmrules.operator.victoriametrics.com                 2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmservicescrapes.operator.victoriametrics.com        2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmsingles.operator.victoriametrics.com               2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmstaticscrapes.operator.victoriametrics.com         2023-07-22T07:53:49Z
</span></span><span style="display:flex;"><span>vmusers.operator.victoriametrics.com                 2023-07-22T07:53:49Z
</span></span></code></pre></div><p>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬è¦æ¥éƒ¨ç½² VMï¼Œå¦‚æœåªæ˜¯æƒ³è¦å•èŠ‚ç‚¹æ¨¡å¼åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>VMSingle</code> å¯¹è±¡ï¼Œå¦‚æœè¦éƒ¨ç½²ä¸€å¥— VM çš„é›†ç¾¤åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>VMCluster</code> æ¥å®šä¹‰ä¸€ä¸ªå¯¹è±¡å³å¯ï¼Œå®Œå…¨ä¸éœ€è¦æˆ‘ä»¬å»æ‰‹åŠ¨åˆ›å»ºå„ä¸ªç»„ä»¶ï¼ŒOperator ä¼šæ ¹æ®æˆ‘ä»¬çš„å®šä¹‰å»å¸®æˆ‘ä»¬æ‹‰èµ·ä¸€å¥—é›†ç¾¤èµ·æ¥ã€‚</p>
<p>æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ <code>VMCluster</code> å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmcluster-demo.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: VMCluster
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmcluster-demo
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicationFactor</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">retentionPeriod</span>: <span style="color:#f1fa8c">&#34;1w&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vmstorage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storage</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">volumeClaimTemplate</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">accessModes</span>:
</span></span><span style="display:flex;"><span>            - ReadWriteOnce
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">storage</span>: 10G
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">storageClassName</span>: cfsauto
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">storageDataPath</span>: /vm-data
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vmselect</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">cacheMountPath</span>: /cache
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vminsert</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">2</span>
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡ <code>spec.retentionPeriod</code> æŒ‡å®šäº†æ•°æ®ä¿ç•™çš„æ—¶é•¿ä¸º 1 å‘¨ï¼Œ<code>replicaCount</code> ç”¨æ¥æŒ‡å®šå„ä¸ªç»„ä»¶çš„å‰¯æœ¬æ•°ä¸º 2ï¼Œé€šè¿‡ <code>storage.volumeClaimTemplate</code> æŒ‡å®šäº†æ•°æ®æŒä¹…åŒ–çš„ PVC æ¨¡æ¿ï¼Œæ•´ä¸ªå¯¹è±¡å¯é…ç½®çš„å±æ€§æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>kubectl explain</code> æ¥è·å–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl explain VMCluster.spec
</span></span><span style="display:flex;"><span>KIND:     VMCluster
</span></span><span style="display:flex;"><span>VERSION:  operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RESOURCE: spec &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     VMClusterSpec defines the desired state of VMCluster
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   clusterVersion       &lt;string&gt;
</span></span><span style="display:flex;"><span>     ClusterVersion defines default images tag <span style="color:#ff79c6">for</span> all components. it can be
</span></span><span style="display:flex;"><span>     overwritten with component specific image.tag value.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   imagePullSecrets     &lt;<span style="color:#ff79c6">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>     ImagePullSecrets An optional list of references to secrets in the same
</span></span><span style="display:flex;"><span>     namespace to use <span style="color:#ff79c6">for</span> pulling images from registries see
</span></span><span style="display:flex;"><span>     http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   podSecurityPolicyName        &lt;string&gt;
</span></span><span style="display:flex;"><span>     PodSecurityPolicyName - defines name <span style="color:#ff79c6">for</span> podSecurityPolicy in <span style="color:#ff79c6">case</span> of empty
</span></span><span style="display:flex;"><span>     value, prefixedName will be used.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   replicationFactor    &lt;integer&gt;
</span></span><span style="display:flex;"><span>     ReplicationFactor defines how many copies of data make among distinct
</span></span><span style="display:flex;"><span>     storage nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   retentionPeriod      &lt;string&gt; -required-
</span></span><span style="display:flex;"><span>     RetentionPeriod <span style="color:#ff79c6">for</span> the stored metrics Note VictoriaMetrics has data/ and
</span></span><span style="display:flex;"><span>     indexdb/ folders metrics from data/ removed eventually as soon as partition
</span></span><span style="display:flex;"><span>     leaves retention period reverse index data at indexdb rotates once at the
</span></span><span style="display:flex;"><span>     half of configured retention period
</span></span><span style="display:flex;"><span>     https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html#retention
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   serviceAccountName   &lt;string&gt;
</span></span><span style="display:flex;"><span>     ServiceAccountName is the name of the ServiceAccount to use to run the
</span></span><span style="display:flex;"><span>     VMSelect Pods.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vminsert     &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmselect     &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmstorage    &lt;Object&gt;
</span></span></code></pre></div><p>åŒæ ·è¦æƒ³è·å–ç»„ä»¶å¯ä»¥å®šä¹‰çš„å±æ€§ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ–¹å¼æ¥è·å–ï¼Œæ¯”å¦‚æŸ¥çœ‹ <code>vmstorage</code> å¯¹è±¡å¯ä»¥é…ç½®çš„å±æ€§ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl explain VMCluster.spec.vmstorage
</span></span><span style="display:flex;"><span>KIND:     VMCluster
</span></span><span style="display:flex;"><span>VERSION:  operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RESOURCE: vmstorage &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION:
</span></span><span style="display:flex;"><span>     &lt;empty&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   affinity     &lt;&gt;
</span></span><span style="display:flex;"><span>     Affinity If specified, the pod<span style="color:#f1fa8c">&#39;s scheduling constraints.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   configMaps   &lt;[]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ConfigMaps is a list of ConfigMaps in the same namespace as the VMSelect
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     object, which shall be mounted into the VMSelect Pods. The ConfigMaps are
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     mounted into /etc/vm/configs/&lt;configmap-name&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   containers   &lt;[]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Containers property allows to inject additions sidecars or to patch
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     existing containers. It can be useful for proxies, backup, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   dnsConfig    &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Specifies the DNS parameters of a pod. Parameters specified here will be
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     merged to the generated DNS configuration based on DNSPolicy.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   dnsPolicy    &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     DNSPolicy sets DNS policy for the pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   extraArgs    &lt;map[string]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   extraEnvs    &lt;[]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ExtraEnvs that will be added to VMSelect pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   hostNetwork  &lt;boolean&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     HostNetwork controls whether the pod may use the node network namespace
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   image        &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Image - docker image settings for VMStorage
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   initContainers       &lt;[]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     InitContainers allows adding initContainers to the pod definition. Those
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     can be used to e.g. fetch secrets for injection into the VMSelect
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     configuration from external sources. Any errors during the execution of an
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     initContainer will lead to a restart of the Pod. More info:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     https://kubernetes.io/docs/concepts/workloads/pods/init-containers/ Using
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     initContainers for any use case other then secret fetching is entirely
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     outside the scope of what the maintainers will support and by doing so, you
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     accept that this behaviour may break at any time without notice.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   livenessProbe        &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     LivenessProbe that will be added CRD pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   logFormat    &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     LogFormat for VMSelect to be configured with. default or json
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   logLevel     &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     LogLevel for VMSelect to be configured with.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   maintenanceInsertNodeIDs     &lt;[]integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     MaintenanceInsertNodeIDs - excludes given node ids from insert requests
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     routing, must contain pod suffixes - for pod-0, id will be 0 and etc. lets
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     say, you have pod-0, pod-1, pod-2, pod-3. to exclude pod-0 and pod-3 from
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     insert routing, define nodeIDs: [0,3]. Useful at storage expanding, when
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     you want to rebalance some data at cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   maintenanceSelectNodeIDs     &lt;[]integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     MaintenanceInsertNodeIDs - excludes given node ids from select requests
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     routing, must contain pod suffixes - for pod-0, id will be 0 and etc.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   name &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Name is deprecated and will be removed at 0.22.0 release
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   nodeSelector &lt;map[string]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     NodeSelector Define which Nodes the Pods are scheduled on.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   podDisruptionBudget  &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     PodDisruptionBudget created by operator
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   podMetadata  &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     PodMetadata configures Labels and Annotations which are propagated to the
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     VMSelect pods.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   port &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Port for health check connetions
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   priorityClassName    &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Priority class assigned to the Pods
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   readinessProbe       &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ReadinessProbe that will be added CRD pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   replicaCount &lt;integer&gt; -required-
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ReplicaCount is the expected size of the VMStorage cluster. The controller
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     will eventually make the size of the running cluster equal to the expected
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     size.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   resources    &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Resources container resource request and limits,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   rollingUpdateStrategy        &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     RollingUpdateStrategy defines strategy for application updates Default is
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     OnDelete, in this case operator handles update process Can be changed for
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     RollingUpdate
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   runtimeClassName     &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     RuntimeClassName - defines runtime class for kubernetes pod.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     https://kubernetes.io/docs/concepts/containers/runtime-class/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   schedulerName        &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     SchedulerName - defines kubernetes scheduler name
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   secrets      &lt;[]string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Secrets is a list of Secrets in the same namespace as the VMSelect object,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     which shall be mounted into the VMSelect Pods. The Secrets are mounted into
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     /etc/vm/secrets/&lt;secret-name&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   securityContext      &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     SecurityContext holds pod-level security attributes and common container
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     settings. This defaults to the default PodSecurityContext.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   serviceScrapeSpec    &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ServiceScrapeSpec that will be added to vmselect VMServiceScrape spec
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   serviceSpec  &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     ServiceSpec that will be create additional service for vmstorage
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   startupProbe &lt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     StartupProbe that will be added to CRD pod
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   storage      &lt;Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Storage - add persistent volume for StorageDataPath its useful for
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     persistent cache
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   storageDataPath      &lt;string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     StorageDataPath - path to storage data
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   terminationGracePeriodSeconds        &lt;integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     TerminationGracePeriodSeconds period for container graceful termination
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   tolerations  &lt;[]Object&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">     Tolerations If specified, the pod&#39;</span>s tolerations.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   topologySpreadConstraints    &lt;<span style="color:#ff79c6">[]</span>&gt;
</span></span><span style="display:flex;"><span>     TopologySpreadConstraints embedded kubernetes pod configuration option,
</span></span><span style="display:flex;"><span>     controls how pods are spread across your cluster among failure-domains such
</span></span><span style="display:flex;"><span>     as regions, zones, nodes, and other user-defined topology domains
</span></span><span style="display:flex;"><span>     https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmBackup     &lt;Object&gt;
</span></span><span style="display:flex;"><span>     VMBackup configuration <span style="color:#ff79c6">for</span> backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmInsertPort &lt;string&gt;
</span></span><span style="display:flex;"><span>     VMInsertPort <span style="color:#ff79c6">for</span> VMInsert connections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   vmSelectPort &lt;string&gt;
</span></span><span style="display:flex;"><span>     VMSelectPort <span style="color:#ff79c6">for</span> VMSelect connections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   volumeMounts &lt;<span style="color:#ff79c6">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>     VolumeMounts allows configuration of additional VolumeMounts on the output
</span></span><span style="display:flex;"><span>     Deployment definition. VolumeMounts specified will be appended to other
</span></span><span style="display:flex;"><span>     VolumeMounts in the VMSelect container, that are generated as a result of
</span></span><span style="display:flex;"><span>     StorageSpec objects.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   volumes      &lt;<span style="color:#ff79c6">[]</span>&gt;
</span></span><span style="display:flex;"><span>     Volumes allows configuration of additional volumes on the output Deployment
</span></span><span style="display:flex;"><span>     definition. Volumes specified will be appended to other volumes that are
</span></span><span style="display:flex;"><span>     generated as a result of StorageSpec objects.
</span></span></code></pre></div><p>ç›´æ¥åº”ç”¨ä¸Šé¢å®šä¹‰çš„å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmcluster-demo.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get vmcluster
</span></span><span style="display:flex;"><span>NAME             INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE   STATUS
</span></span><span style="display:flex;"><span>vmcluster-demo   <span style="color:#bd93f9">2</span>              <span style="color:#bd93f9">2</span>               <span style="color:#bd93f9">2</span>              39s   operational
</span></span></code></pre></div><p>åº”ç”¨å vm operator ä¼š watch åˆ°æˆ‘ä»¬åˆ›å»ºäº†è¯¥ CRD å¯¹è±¡ï¼Œç„¶åä¼šæ ¹æ®æˆ‘ä»¬çš„å®šä¹‰å»è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ VM é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„å‡ ä¸ªç»„ä»¶æœåŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl get pods
</span></span><span style="display:flex;"><span>NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>vminsert-vmcluster-demo-5cf8d8b88-bzrzr   1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vminsert-vmcluster-demo-5cf8d8b88-kh66n   1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmselect-vmcluster-demo-0                 1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmselect-vmcluster-demo-1                 1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmstorage-vmcluster-demo-0                1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>vmstorage-vmcluster-demo-1                1/1     Running   <span style="color:#bd93f9">0</span>          64s
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get svc
</span></span><span style="display:flex;"><span>NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ff79c6">(</span>S<span style="color:#ff79c6">)</span>                      AGE
</span></span><span style="display:flex;"><span>vminsert-vmcluster-demo    ClusterIP   10.97.113.135   &lt;none&gt;        8480/TCP                     81s
</span></span><span style="display:flex;"><span>vmselect-vmcluster-demo    ClusterIP   None            &lt;none&gt;        8481/TCP                     81s
</span></span><span style="display:flex;"><span>vmstorage-vmcluster-demo   ClusterIP   None            &lt;none&gt;        8482/TCP,8400/TCP,8401/TCP   <span style="color:#bd93f9">81</span>
</span></span></code></pre></div><p>æˆ‘ä»¬åªé€šè¿‡å®šä¹‰ç®€å•çš„ <code>VMCluster</code> å¯¹è±¡å°±å¯ä»¥æ¥ç®¡ç† VM é›†ç¾¤äº†ï¼Œæ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ç»„ä»¶å‰¯æœ¬æ•°é‡éå¸¸å¤šçš„æ—¶å€™ä¸éœ€è¦æˆ‘ä»¬å»æ‰‹åŠ¨é…ç½® <code>-storageNode</code> å‚æ•°äº†ã€‚</p>
<p>ç°åœ¨ VM é›†ç¾¤å®‰è£…æˆåŠŸäº†ï¼Œä½†æ˜¯ç°åœ¨è¿˜æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿˜éœ€è¦å»é…ç½®ç›‘æ§æŒ‡æ ‡çš„æŠ“å–ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å»åˆ›å»ºä¸€ä¸ª <code>VMAgent</code> å¯¹è±¡å³å¯ï¼Œåˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmagent-demo.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: VMAgent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: vmagent-demo
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">podScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">nodeScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">staticScrapeSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">staticScrapeNamespaceSelector</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicaCount</span>: <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">remoteWrite</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">url</span>: <span style="color:#f1fa8c">&#34;http://vminsert-vmcluster-demo.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write&#34;</span>
</span></span></code></pre></div><p>åŒæ ·è¦è·å– <code>VMAgent</code> çš„æ‰€ä»¥å¯é…ç½®çš„å±æ€§å¯ä»¥é€šè¿‡ <code>kubectl explain VMAgent.spec</code> æ¥è·å–ï¼Œè¿™é‡Œæœ€ä¸»è¦çš„é…ç½®å°±æ˜¯é€šè¿‡ <code>remoteWrite.url</code> æ¥æŒ‡å®šè¿œç¨‹å†™å…¥çš„ URL åœ°å€ï¼Œä¹Ÿå°±æ˜¯ <code>vminsert</code> ç»„ä»¶çš„æœåŠ¡åœ°å€ï¼Œå…¶ä»–å‡ ä¸ªå±æ€§å¯ä»¥ç”¨æ¥å¯¹è¦æŠ“å–çš„æŒ‡æ ‡è¿›è¡Œè¿‡æ»¤ã€‚</p>
<p>ç›´æ¥åº”ç”¨ä¸Šé¢çš„ <code>VMAgent</code> å¯¹è±¡å³å¯å¼€å§‹æŠ“å–ç›‘æ§æ•°æ®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmagent-demo.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get vmagent
</span></span><span style="display:flex;"><span>NAME           SHARDS COUNT   REPLICA COUNT
</span></span><span style="display:flex;"><span>vmagent-demo   <span style="color:#bd93f9">0</span>              <span style="color:#bd93f9">1</span>
</span></span></code></pre></div><p>åˆ›å»ºå vm-operator ä¼šæ ¹æ®å¯¹åº”çš„æè¿°åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ <code>vmagent</code> å®ä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl get pods -l app.kubernetes.io/name<span style="color:#ff79c6">=</span>vmagent
</span></span><span style="display:flex;"><span>NAME                                   READY   STATUS    RESTARTS     AGE
</span></span><span style="display:flex;"><span>vmagent-vmagent-demo-7d97cc94b-t8b9t   2/2     Running   <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">(</span>3s ago<span style="color:#ff79c6">)</span>   17s
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>vmagent</code> æœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªæ˜¯ <code>vmagent</code> åº”ç”¨å®¹å™¨ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ç”¨äºæŒ‚è½½ Secret å¯¹è±¡çš„ <code>config-reloader</code> å®¹å™¨ï¼Œå®ƒä¼š watch é…ç½®çš„å˜åŒ–ï¼Œå¹¶å‘é€ä¿¡å·ä¸º <code>vmagent</code> é‡æ–°åŠ è½½é…ç½®ï¼Œè¯¥ Secret å¯¹è±¡ä¸­å°±æ˜¯å®šä¹‰çš„ <code>vmagent</code> æŠ“å–æŒ‡æ ‡çš„é…ç½®å†…å®¹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ä½¿ <code>vmagent</code> çš„ç«¯å£å¯ä»¥ä»æœ¬åœ°æœºå™¨ä¸Šè®¿é—®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl port-forward svc/vmagent-vmagent-demo 8429:8429
</span></span><span style="display:flex;"><span>Forwarding from 127.0.0.1:8429 -&gt; <span style="color:#bd93f9">8429</span>
</span></span><span style="display:flex;"><span>Forwarding from <span style="color:#ff79c6">[</span>::1<span style="color:#ff79c6">]</span>:8429 -&gt; <span style="color:#bd93f9">8429</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://127.0.0.1:8429/targets</code> æ¥æ£€æŸ¥ <code>vmagent</code> é‡‡é›†çš„é›†ç¾¤æŒ‡æ ‡ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690013883755.png" alt="vmagent metrics"></p>
<p><code>vmagent</code> ä¼šé€šè¿‡ Kubernetes æœåŠ¡å‘ç°å»è·å–éœ€è¦æŠ“å–çš„ç›®æ ‡ï¼Œæ­¤æœåŠ¡å‘ç°ç”± vm operator æ§åˆ¶ã€‚</p>
<h3 id="éªŒè¯-vm-é›†ç¾¤">éªŒè¯ VM é›†ç¾¤</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å‰é¢å®‰è£…çš„ Grafana æ¥éªŒè¯è¿™é‡Œçš„ VM é›†ç¾¤ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®æºï¼ŒæŒ‡å®š URL ä¸º <code>http://vmselect-vmcluster-demo.default.svc.cluster.local:8481/select/0/prometheus/</code>ã€‚</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690014716988.png" alt="æ·»åŠ æ–°çš„æ•°æ®æº"></p>
<p>ç„¶åæ·»åŠ å‡ ä¸ªæ–°çš„ dashboardï¼Œå¯¼å…¥ ID åˆ†åˆ«ä¸º <code>11176</code>ã€<code>12683</code>ã€<code>14205</code>ï¼Œç¬¬ä¸€ä¸ªæ˜¯ VM é›†ç¾¤çš„ dashboardï¼Œç¬¬äºŒä¸ªæ˜¯ vmagent çš„ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ K8s é›†ç¾¤çš„ dashboardã€‚</p>
<p>æ­£å¸¸å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ dashboardï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015075795.jpg" alt="vmcluster dashboard"></p>
<p>è¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ <code>VMAgent</code> ä¼šé‡‡é›† VM é›†ç¾¤ç›¸å…³ç»„ä»¶çš„æŒ‡æ ‡ï¼ŒåŒ…æ‹¬ <code>vmagent</code> æœ¬èº«çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ­£å¸¸çœ‹åˆ° VM é›†ç¾¤çš„ Dashboardï¼Œä½†æ˜¯ç¼ºæ²¡æœ‰é‡‡é›†å…¶ä»–çš„æŒ‡æ ‡ï¼Œæ¯”å¦‚ node-exporterï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Grafana ä¸­å¯¼å…¥ <code>16098</code> è¿™ä¸ª dashboardï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015232194.jpg" alt="node-exporter"></p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>VMNodeScrape</code> è¿™ä¸ª CRD å¯¹è±¡æ¥è¿›è¡Œå®šä¹‰ï¼Œ<code>VMNodeScrape</code> å¯¹è±¡å¯ä»¥ç”¨æ¥è‡ªåŠ¨å‘ç° Kubernetes èŠ‚ç‚¹ï¼Œåˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„èµ„æºå¯¹è±¡æ¥é‡‡é›† node-exporter æŒ‡æ ‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4"># vmnode.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: operator.victoriametrics.com/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: VMNodeScrape
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: node-exporter
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">path</span>: /metrics
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">port</span>: <span style="color:#f1fa8c">&#34;9100&#34;</span> <span style="color:#6272a4"># æŒ‡å®š node-exporter çš„ç«¯å£</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape_interval</span>: 15s
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#   relabelConfigsï¼š  # relabelé…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#   selector:  # è¿‡æ»¤èŠ‚ç‚¹</span>
</span></span></code></pre></div><p>ç›´æ¥åº”ç”¨ä¸Šé¢çš„å¯¹è±¡å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>â˜¸ âœ kubectl apply -f vmnode.yaml
</span></span><span style="display:flex;"><span>â˜¸ âœ kubectl get vmnodescrape
</span></span><span style="display:flex;"><span>NAME            AGE
</span></span><span style="display:flex;"><span>node-exporter   19s
</span></span></code></pre></div><p>åˆ›å»ºå vmagent å°±ä¼šè‡ªåŠ¨å»è¯†åˆ«è¯¥å¯¹è±¡å»å¯¹ node-exporter è¿›è¡ŒæŠ“å–äº†ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015495522.png" alt="node-exporter targets"></p>
<p>è¿™ä¸ªæ—¶å€™å†å»æŸ¥çœ‹ node-exporter çš„ dashboard å°±æ­£å¸¸äº†ï¼š</p>
<p><img src="https://picdn.youdianzhishi.com/images/1690015769439.jpg" alt="node-exorter dashboard"></p>
<p>æ­¤å¤–è¿˜å¯ä»¥é€šè¿‡ <code>VMServiceScrape</code> å»å®šä¹‰è¦æŠ“å–çš„ Service æœåŠ¡ï¼ˆEndpointsï¼‰ï¼Œå®ƒåŸºäºé€‰æ‹©å™¨ä¸º <code>vmagent</code> ç”ŸæˆæŠ“å–é…ç½®ï¼Œå¦‚æœæƒ³è¦æŠ“å–æ²¡æœ‰å®šä¹‰ Service çš„ Pod çš„æŒ‡æ ‡ï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>VMPodScrape</code> æ¥è¿›è¡Œå®šä¹‰ï¼ŒåŒæ ·è¿˜æœ‰æŠ¥è­¦ç›¸å…³çš„ä¹Ÿéƒ½æœ‰ç›¸åº”çš„ CRD æ¥è¿›è¡Œç®¡ç†ã€‚vm operator å¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ VM é›†ç¾¤çš„ç®¡ç†ï¼Œéå¸¸æ¨èä½¿ç”¨ã€‚</p>
<!-- raw HTML omitted -->

          <h2>å¾®ä¿¡å…¬ä¼—å·</h2>
<p>
  æ‰«æä¸‹é¢çš„äºŒç»´ç å…³æ³¨æˆ‘ä»¬çš„å¾®ä¿¡å…¬ä¼—å¸å·ï¼Œåœ¨å¾®ä¿¡å…¬ä¼—å¸å·ä¸­å›å¤â—‰åŠ ç¾¤â—‰å³å¯åŠ å…¥åˆ°æˆ‘ä»¬çš„
  kubernetes è®¨è®ºç¾¤é‡Œé¢å…±åŒå­¦ä¹ ã€‚
</p>
<img
  src="https://picdn.youdianzhishi.com/images/qrcode.png"
  alt="wechat-account-qrcode"
/>

  
          
            <div class="entry-shang text-center">
    <p>ã€ŒçœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™ã€</p>
    <button class="zs show-zs btn btn-bred">èµèµ</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
    <div class="zs-modal-head">
        <button type="button" class="close">Ã—</button>
        <span class="author"><img src="https://www.qikqiak.com/img/avatar.jpeg"/>é˜³æ˜</span>
        <p class="tip"><i></i><span>è¯·æˆ‘å–æ¯å’–å•¡ï¼Ÿ</span></p>
    </div>
    <div class="zs-modal-body">
        <div class="zs-modal-btns">
            <button class="btn btn-blink" data-num="2">2å…ƒ</button>
            <button class="btn btn-blink" data-num="5">5å…ƒ</button>
            <button class="btn btn-blink" data-num="10">10å…ƒ</button>
            <button class="btn btn-blink" data-num="50">50å…ƒ</button>
            <button class="btn btn-blink" data-num="100">100å…ƒ</button>
            <button class="btn btn-blink" data-num="1">ä»»æ„é‡‘é¢</button>
        </div>
        <div class="zs-modal-pay">
            <button class="btn btn-bred" id="pay-text">2å…ƒ</button>
            <p>ä½¿ç”¨<span id="pay-type">å¾®ä¿¡</span>æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</p>
            <img src="https://www.qikqiak.com/img/wechat-2.png" id="pay-image"/>
        </div>
    </div>
    <div class="zs-modal-footer">
        <span class="zs-wechat"><img src="https://www.qikqiak.com/img/wechat-btn.png"/></span>
    </div>
</div>
          
          
            <div class="social-share" data-initialized="true" style="margin-bottom: 20px;margin-top:20px;">
    <center>
    <a href="#" class="social-share-icon icon-weibo"></a>
    <a href="#" class="social-share-icon icon-wechat"></a>
    <a href="#" class="social-share-icon icon-twitter"></a>
    <a href="#" class="social-share-icon icon-linkedin"></a>
    <a href="#" class="social-share-icon icon-facebook"></a>
    <a href="#" class="social-share-icon icon-qq"></a>
    <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

          
        </article>
  
        
          

<h3>ç›¸å…³æ–‡ç« </h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="https://www.qikqiak.com/post/prometheus-monitor-k8s-job-trap/">Prometheus ç›‘æ§ Kubernetes Job èµ„æºè¯¯æŠ¥çš„å‘</a></li>
    
    <li><a href="https://www.qikqiak.com/post/monitor-external-k8s-on-prometheus/">Prometheus ç›‘æ§å¤–éƒ¨ Kubernetes é›†ç¾¤</a></li>
    
    <li><a href="https://www.qikqiak.com/post/use-loki-monitor-alert/">ä½¿ç”¨ Loki è¿›è¡Œæ—¥å¿—ç›‘æ§å’ŒæŠ¥è­¦</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-hpa-usage/">Kubernetes HPA ä½¿ç”¨è¯¦è§£</a></li>
    
    <li><a href="https://www.qikqiak.com/post/use-crd-create-grafana-dashboard/">ç”¨ Kubernetes èµ„æºå¯¹è±¡åˆ›å»º Grafana Dashboard</a></li>
    
    <li><a href="https://www.qikqiak.com/post/alertmanager-when-alert/">AlertManager ä½•æ—¶æŠ¥è­¦</a></li>
    
    <li><a href="https://www.qikqiak.com/post/recording-rules-on-prometheus/">Prometheus è®°å½•è§„åˆ™çš„ä½¿ç”¨</a></li>
    
    <li><a href="https://www.qikqiak.com/post/blackbox-exporter-on-prometheus/">Prometheus é»‘ç›’ç›‘æ§</a></li>
    
    <li><a href="https://www.qikqiak.com/post/build-k8s-app-with-custom-metrics/">å¯¹ Kubernetes åº”ç”¨è¿›è¡Œè‡ªå®šä¹‰æŒ‡æ ‡æ‰©ç¼©å®¹</a></li>
    
    <li><a href="https://www.qikqiak.com/post/prometheus-book/">ã€Šæ·±å…¥æµ…å‡ºPrometheusã€‹</a></li>
    
</ul>

        
  
        
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.qikqiak.com/post/how-to-subscribe-chatgpt-plus-try-gpt-4/" data-toggle="tooltip" data-placement="top" title="ä¿å§†çº§æ•™ç¨‹ | æ‰‹æŠŠæ‰‹å«ä½ å¦‚ä½•å¼€é€š ChatGPT Plus è¯•ç”¨ GPT-4">&larr; å‰ä¸€ç¯‡</a>
            </li>
          
          
        </ul>
        

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-5376999672787220"
            data-ad-slot="3700507799"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
  
        
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    var gitalk = new Gitalk({
        clientID: 'bdb76dbb2e9d0786e350',
        clientSecret: 'b454b2a08013fd0e32013be7a63fa8fcb262b6c4',
        repo: 'blog',
        owner: 'cnych',
        admin: ['cnych'],
        labels: ['gitment'],
        title: 'ä¸€æ–‡ææ‡‚ VictoriaMetrics çš„ä½¿ç”¨',
        createIssueManually: true,
        id: 'victoriametrics-usage',      
        distractionFreeMode: true  
    });
    gitalk.render('gitalk-container');
</script>


        
          

        
  
      </div>
    
    
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          <img src="https://www.qikqiak.com/img/wechatmp.png" alt="k8sæŠ€æœ¯åœˆ">
          
              <li>
                <a href="mailto:icnych@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://github.com/cnych" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://weibo.com/cnych" title="å¾®åš">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://instagram.com/cnych" title="Instagram">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          <li>
            <a href="https://www.qikqiak.com/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;
          2023

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/">é˜³æ˜çš„åšå®¢</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/sitemap.xml">ç½‘ç«™åœ°å›¾</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/archive/">å½’æ¡£</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/friend/">å‹é“¾</a>
            &nbsp;&bull;&nbsp;
            <a href="https://beian.miit.gov.cn/" target="_blank">èœ€ICPå¤‡11027319å·-5</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.io">kubernetes.io</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.org.cn">Kubernetesä¸­æ–‡ç¤¾åŒº</a>
          
        </p>
        <p class="text-center text-muted">
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv" style="display:none">
            æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
          </span>
          &nbsp;&bull;&nbsp;
          <span id="busuanzi_container_site_uv" style="display:none">
            è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
          </span>
        </p>
        
        <p class="credits theme-by text-muted">
          ç”± <a href="http://gohugo.io">Hugo v0.115.4</a> å¼ºåŠ›é©±åŠ¨ &nbsp;&bull;&nbsp; ä¸»é¢˜ <a href="https://github.com/cnych/qikqiak.com">qikqiak-blog</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>


<script src='https://www.qikqiak.com/js/bundle.min.af02a2d23b6651a566f0135a12e65fc2560faa7a969b3d1ad58d0afe0c9164ae.js' integrity='sha256-rwKi0jtmUaVm8BNaEuZfwlYPqnqWmz0a1Y0K/gyRZK4='></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-69668147-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-69668147-3');
</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script >
$(document).ready(function() {
  var int = setInterval(fixCount, 50);  
  
  var initPVCount = 584976;
  var initUVCount = 153191;
  function fixCount() {                   
    if ($("#busuanzi_container_site_pv").css("display") != "none") {
        $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + initPVCount); 
        clearInterval(int); 
    }
    if ($("#busuanzi_container_site_uv").css("display") != "none") {
      $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + initUVCount);
      clearInterval(int); 
    }  
  }           
});
</script>
 <script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BJICPtxnbz-7vq9kEwH5psPCuHe2CvludQug4R2tuJGPF0GQT2hwSWTAhlSt2EFD5InpuQyxCGJdigf6-KbQ53c');</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery-migrate@1.2.1/dist/jquery-migrate.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script type="text/javascript">
$('.carousel').slick({
    dots: true,
    arrows: true,
    autoplay: true,
    autoplaySpeed: 4000,
    infinite: true,
    speed: 500,
    fade: true,
    cssEase: 'linear',
    centerMode: true,
    prevArrow: '<button type="button" class="slick-prev"></button>',
    nextArrow: '<button type="button" class="slick-next"></button>',
});
</script>

  </body>
</html>

