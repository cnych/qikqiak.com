<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>Grafana Loki 简明教程-阳明的博客|Kubernetes|Istio|Prometheus|Python|Golang|云原生</title>
  <meta property="og:title" content="Grafana Loki 简明教程" />
  <meta name="twitter:title" content="Grafana Loki 简明教程" />

  <meta name="description" content="云原生日志收集工具 Loki 使用教程">
  <meta property="og:description" content="云原生日志收集工具 Loki 使用教程">
  <meta name="twitter:description" content="云原生日志收集工具 Loki 使用教程">
  <meta name="author" content=""/>
  <link href="https://picdn.youdianzhishi.com/images/blog-favicon.png" rel="icon" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://picdn.youdianzhishi.com/images/blog-favicon.png"/>
  <meta property="og:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:image" content="https://picdn.youdianzhishi.com/images/blog-favicon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://www.qikqiak.com/post/grafana-loki-usage/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="阳明的博客" />

  <link rel="canonical" href="https://www.qikqiak.com/post/grafana-loki-usage/" />
  <link rel="alternate" href="https://www.qikqiak.com/index.xml" type="application/rss+xml" title="阳明的博客">

  
  
  <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700%7COpen+Sans:400,700" rel="stylesheet">
  

  <link rel="stylesheet" href='https://www.qikqiak.com/css/bundle.min.a6b62363fe57848ad01efa2a5d1bbb1047c2ffb71b53d8aeb42bc5ed5c77ea7c.css' integrity='sha256-prYjY/5XhIrQHvoqXRu7EEfC/7cbU9iutCvF7Vx36nw='>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
  
  
    
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <![endif]-->
<meta name="google-site-verification" content="oKxX4fOvB2yYmU02txZFChM93XQbESU4JaG3tNH9Hm8" />
<meta name="baidu-site-verification" content="F5ojAyqaKU" />
<meta name="keywords" content="kubernetes, Loki, Grafana, 日志">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d611849735f187dd788dc054908f7d7a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69668147-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.qikqiak.com/" title="阳明的博客">
        <img src="https://picdn.youdianzhishi.com/images/blog-logo-new.png" style="margin-top: -5px;height: 32px;" alt="阳明的博客">
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="首页" href="https://www.qikqiak.com/">首页</a>
            </li>
          
        
          
            <li>
              <a title="课程" href="https://youdianzhishi.com/?utm_source=blog&amp;utm_campaign=referral&amp;utm_medium=topmenu">课程</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">文章分类</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/archives">Archive</a>
                
                  <a href="https://www.qikqiak.com/tags">tags</a>
                
                  <a href="https://www.qikqiak.com/tags/kubernetes">kubernetes</a>
                
                  <a href="https://www.qikqiak.com/tags/python">python</a>
                
                  <a href="https://www.qikqiak.com/tags/django">django</a>
                
                  <a href="https://www.qikqiak.com/tags/devops">devops</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">书籍</a>
              <div class="navlinks-children">
                
                  <a href="https://www.qikqiak.com/k8s-book/">k8s进阶手册</a>
                
                  <a href="https://www.qikqiak.com/istio-book/">一起学istio</a>
                
                  <a href="https://www.qikqiak.com/tdd-book/">Python微服务</a>
                
                  <a href="https://md.qikqiak.com/">Markdown微信</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="关于" href="https://www.qikqiak.com/page/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="RSS" href="https://www.qikqiak.com/index.xml">RSS</a>
            </li>
          
        

        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          

      </ul>
    </div>

  </div>
</nav>


  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">搜索</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script src="https://www.qikqiak.com/js/algoliasearch.min.js"></script>
<script src="https://www.qikqiak.com/js/autocomplete.min.js"></script>

<script>
var client = algoliasearch("1JDRAS0AZR", "8804ac109158bb3bb60d74ce98fa332f");
var index = client.initIndex('prod_blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            return '<span>' + '<a href="https://www.qikqiak.com/post/' + suggestion.slug + '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>

    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://picdn.youdianzhishi.com/images/20200819114930.png" data-img-desc-1="Grafana Loki"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>Grafana Loki 简明教程</h1>
                  
                    
                      <h2 class="post-subheading">云原生日志收集工具 Loki 使用教程</h2>
                    
                  
                  
                    <span class="post-meta">
  发表于 August 19, 2020  
</span>

                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Grafana Loki 简明教程</h1>
                
                  
                    <h2 class="post-subheading">云原生日志收集工具 Loki 使用教程</h2>
                  
                
                
                  <span class="post-meta">
  发表于 August 19, 2020  
</span>

                
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </header>


    



<div class="container" role="main">
  <div class="row">

    
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div>
            
            
            <h5 id="tags" style="margin-top: 30px;">标签:
              
                  <a href="https://www.qikqiak.com/tags/kubernetes/">kubernetes</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/loki/">Loki</a> &nbsp;
              
                  <a href="https://www.qikqiak.com/tags/grafana/">grafana</a> &nbsp;
              
            </h5>
            
        </div>
  
        <article role="main" class="blog-post" itemprop="articleBody" id="content">
          
            
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#11-多租户">1.1 多租户</a></li>
    <li><a href="#12-操作模式">1.2 操作模式</a></li>
    <li><a href="#13-组件">1.3 组件</a>
      <ul>
        <li><a href="#distributor分配器">Distributor（分配器）</a></li>
        <li><a href="#ingester采集器">Ingester（采集器）</a></li>
        <li><a href="#querier查询器">Querier（查询器）</a></li>
        <li><a href="#前端查询">前端查询</a></li>
        <li><a href="#chunk块存储">Chunk（块）存储</a></li>
      </ul>
    </li>
    <li><a href="#14-对比其他日志系统">1.4 对比其他日志系统</a></li>
  </ul>

  <ul>
    <li><a href="#21-使用-helm-安装-loki">2.1 使用 Helm 安装 Loki</a>
      <ul>
        <li><a href="#前提">前提</a></li>
        <li><a href="#部署-loki">部署 Loki</a></li>
      </ul>
    </li>
    <li><a href="#22-使用-docker-安装-loki">2.2 使用 Docker 安装 Loki</a>
      <ul>
        <li><a href="#前提-1">前提</a></li>
        <li><a href="#使用-docker-安装">使用 Docker 安装</a></li>
        <li><a href="#使用-docker-compose-安装">使用 Docker Compose 安装</a></li>
      </ul>
    </li>
    <li><a href="#23-本地安装-loki">2.3 本地安装 Loki</a>
      <ul>
        <li><a href="#二进制文件">二进制文件</a></li>
        <li><a href="#opensuse-linux-安装包">openSUSE Linux 安装包</a></li>
        <li><a href="#手动构建">手动构建</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#31-loki-在-grafana-中的配置">3.1 Loki 在 Grafana 中的配置</a></li>
    <li><a href="#32-使用-logcli-查询-loki">3.2 使用 LogCLI 查询 Loki</a>
      <ul>
        <li><a href="#安装">安装</a></li>
        <li><a href="#使用示例">使用示例</a></li>
        <li><a href="#命令详情">命令详情</a></li>
      </ul>
    </li>
    <li><a href="#33-label-标签">3.3 Label 标签</a>
      <ul>
        <li><a href="#标签示例">标签示例</a></li>
        <li><a href="#cardinality势">Cardinality（势）</a></li>
        <li><a href="#loki-性能优化">Loki 性能优化</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>

          
  
          
          
          
  
          
          
          
  
          
          
          

          <p>Loki 是 Grafana Labs 团队最新的开源项目，是一个水平可扩展，高可用性，多租户的日志聚合系统。它的设计非常经济高效且易于操作，因为它不会为日志内容编制索引，而是为每个日志流配置一组标签。项目受 Prometheus 启发，官方的介绍就是：<code>Like Prometheus, but for logs</code>，类似于 Prometheus 的日志系统。</p>
<h1 id="1-概述">1. 概述</h1>
<p>和其他日志系统不同的是，Loki 只会对你的日志元数据标签（就像 Prometheus 的标签一样）进行索引，而不会对原始的日志数据进行全文索引。然后日志数据本身会被压缩，并以 chunks（块）的形式存储在对象存储（比如 S3 或者 GCS）甚至本地文件系统。一个小的索引和高度压缩的 chunks 可以大大简化操作和降低 Loki 的使用成本。</p>
<p>有关本文档更详细的版本，可以查看<a href="https://github.com/grafana/loki/blob/master/docs/architecture.md">《Loki 架构》</a>章节介绍。</p>
<h2 id="11-多租户">1.1 多租户</h2>
<p>Loki 支持多租户模式，租户之间的数据是完全分开的。多租户是通过一个租户 ID（用数字字母生成的字符串）实现的。当多租户模式被禁用后，所有请求都会在内部生成一个**<code>假的</code>**租户 ID。</p>
<h2 id="12-操作模式">1.2 操作模式</h2>
<p>Loki 可以在本地小规模运行也可以横向扩展。Loki 自带单进程模式，可以在一个进程中运行所有需要的微服务。单进程模式非常适合于测试 Loki 或者小规模运行。对于横向扩展来说，Loki 的微服务是可以被分解成单独的进程的，使其能够独立扩展。</p>
<h2 id="13-组件">1.3 组件</h2>
<h3 id="distributor分配器">Distributor（分配器）</h3>
<p>分配器服务负责处理<a href="https://github.com/grafana/loki/blob/master/docs/clients/README.md">客户端</a>写入的日志。本质上它是日志数据写入路径中的<code>第一站</code>。一旦分配器接收到日志数据，它就会把它们分成若干批次，并将它们并行地发送到多个采集器去。</p>
<p>分配器通过 <a href="https://grpc.io/">gPRC</a> 和<a href="https://github.com/grafana/loki/blob/master/docs/overview/README.md#ingester">采集器</a>进行通信。它们是无状态的，所以我们可以根据实际需要对他们进行扩缩容。</p>
<p><strong>Hashing</strong></p>
<p>分配器采用一致性哈希和可配置的复制因子结合使用，来确定哪些采集器服务应该接收日志数据。</p>
<p>该哈希是基于日志标签和租户 ID 生成的。</p>
<p>存储在 <a href="https://www.consul.io/">Consul</a> 中的哈希环被用来实现一致性哈希；所有的采集器将他们自己的一组 Token 注册到哈希环中去。然后分配器找到和日志的哈希值最匹配的 Token，并将数据发送给该 Token 的持有者。</p>
<p><strong>一致性</strong></p>
<p>由于所有的分配器都共享同一个哈希环，所以可以向任何分配器发送写请求。</p>
<p>为了确保查询结果的一致性，Loki 在读和写上使用了 <a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo 方式</a>的法定人数一致性。这意味着分配器将等待至少有一半以上的采集器响应，再向用户发送样本，然后再响应给用户。</p>
<h3 id="ingester采集器">Ingester（采集器）</h3>
<p>采集器服务负责将日志数据写入长期存储的后端（DynamoDB、S3、Cassandra 等等）。</p>
<p>采集器会校验采集的日志是否乱序。当采集器接收到的日志行与预期的顺序不一致时，该行日志将被拒绝，并向用户返回一个错误。有关更多相关信息，可以查看<a href="https://github.com/grafana/loki/blob/master/docs/overview/README.md#timestamp-ordering">时间戳排序</a>部分内容。</p>
<p>采集器验证接收到的日志行是按照时间戳递增的顺序接收的（即每条日志的时间戳都比之前的日志晚）。当采集器接收到的日志不按照这个顺序，日志行将被拒绝并返回错误。</p>
<p>每一个唯一的标签集数据都会在内存中构建成<code>chunks</code>，然后将它们存储到后端存储中去。</p>
<p>如果一个采集器进程崩溃或者突然挂掉了，所有还没有被刷新到存储的数据就会丢失。Loki 通常配置成多个副本（通常为 3 个）来降低这种风险。</p>
<p><strong>时间戳排序</strong></p>
<p>一般来说推送到 Loki 的所有日志行必须比之前收到的行有一个更新的时间戳。然而有些情况可能是多行日志具有相同的纳秒级别的时间戳，可以按照下面两种情况进行处理：</p>
<ul>
<li>如果传入的行和之前接收到的行完全匹配（时间戳和日志文本都匹配），则传入的行会被视为完全重复并会被忽略。</li>
<li>如果传入行的时间戳和前面一行的时间戳相同，但是日志内容不相同，则会接收该行日志。这就意味着，对于相同的时间戳，有可能有两个不同的日志行。</li>
</ul>
<p><strong>Handoff（交接）</strong></p>
<p>默认情况下，当一个采集器关闭并视图离开哈希环时，它将等待查看是否有新的采集器视图进入，然后再进行 flush，并尝试启动交接。交接将把离开的采集器拥有的所有 Token 和内存中的 chunks 都转移到新的采集器中来。</p>
<p>这个过程是为了避免在关闭时 flush 所有的 chunks，因为这是一个比较缓慢的过程，比较耗时。</p>
<p><strong>文件系统支持</strong></p>
<p>采集器支持通过 BoltDB 写入到文件系统，但这只在单进程模式下工作，因为<a href="https://github.com/grafana/loki/blob/master/docs/overview/README.md#querier">查询器</a>需要访问相同的后端存储，而且 BoltDB 只允许一个进程在给定时间内对 DB 进行锁定。</p>
<h3 id="querier查询器">Querier（查询器）</h3>
<p>查询器服务负责处理 <a href="https://github.com/grafana/loki/blob/master/docs/logql.md">LogQL</a> 查询语句来评估存储在长期存储中的日志数据。</p>
<p>它首先会尝试查询所有采集器的内存数据，然后再返回到后端存储中加载数据。</p>
<h3 id="前端查询">前端查询</h3>
<p>该服务是一个可选组件，在一组查询器前面，来负责在它们之间公平地调度请求，尽可能地并行化它们并缓存请求。</p>
<h3 id="chunk块存储">Chunk（块）存储</h3>
<p>块存储是 Loki 的长期数据存储，旨在支持交互式查询和持续写入，无需后台维护任务。它由一下几部分组成：</p>
<ul>
<li><strong>块索引</strong>，该索引可以由 DynamoDB、Bigtable 或者 Cassandra 来支持。</li>
<li>块数据本身的 <strong>KV 存储</strong>，可以是 DynamoDB、Bigtable、Cassandra，也可以上是对象存储，比如 S3。</li>
</ul>
<blockquote>
<p>与 Loki 的其他核心组件不同，块存储不是一个独立的服务、任务或者进程，而是嵌入到需要访问 Loki 数据的采集器和查询器中的库。</p>
</blockquote>
<p>块存储依赖统一的 ”NoSQL“ 存储（DynamoDB、Bigtable 和 Cassandra）接口，该接口可以用来支持块存储索引。该接口假设索引是由以下几个 key 构成的集合：</p>
<ul>
<li><strong>哈希 KEY</strong> - 这是所有的读和写都需要的。</li>
<li><strong>范围 KEY</strong> - 这是写的时候需要的，读的时候可以省略，可以通过前缀或者范围来查询。</li>
</ul>
<p>上面支持的这些数据库中接口的工作原理有些不同：</p>
<ul>
<li>DynamoDB 支持范围和哈希 KEY。所以索引条目直接建模为 DynamoDB 的数据，哈希 KEY 为分布式 KEY，范围为范围 KEY。</li>
<li>对于 Bigtable 和 Cassandra，索引项被建模为单个的列值。哈希 KEY 成为行 KEY，范围 KEY 成为列 KEY。</li>
</ul>
<p>一些模式被用于对块存储的读取和写入时使用的匹配器和标签集合映射到索引的适当操作中来。随着 Loki 的发展也会增加一些新的模式，主要是为了更好地平衡些和提高查询性能。</p>
<h2 id="14-对比其他日志系统">1.4 对比其他日志系统</h2>
<p>EFK（Elasticsearch、Fluentd、Kibana）用于从各种来源获取、可视化和查询日志。</p>
<p>Elasticsearch 中的数据以非结构化 JSON 对象的形式存储在磁盘上。每个对象的键和每个键的内容都有索引。然后可以使用 JSON 对象来定义查询（称为 Query DSL）或通过 Lucene 查询语言来查询数据。</p>
<p>相比之下，单二进制模式下的 Loki 可以将数据存储在磁盘上，但在水平可扩展模式下，数据存储需要在云存储系统中，如 S3、GCS 或 Cassandra。日志以纯文本的形式存储，并标记了一组标签的名称和值，其中只有标签会被索引。这种权衡使其操作起来比完全索引更便宜。Loki 中的日志使用 LogQL 进行查询。由于这种设计上的权衡，根据内容（即日志行内的文本）进行过滤的 LogQL 查询需要加载搜索窗口内所有与查询中定义的标签相匹配的块。</p>
<p>Fluentd 通常用于收集日志并转发到 Elasticsearch。Fluentd 被称为数据收集器，它可以从许多来源采集日志，并对其进行处理，然后转发到一个或多个目标。</p>
<p>相比之下，Promtail 是为 Loki 量身定做的。它的主要工作模式是发现存储在磁盘上的日志文件，并将其与一组标签关联的日志文件转发到 Loki。Promtail 可以为在同一节点上运行的 Kubernetes Pods 做服务发现，作为 Docker 日志驱动，从指定的文件夹中读取日志，并对 systemd 日志不断获取。</p>
<p>Loki 通过一组标签表示日志的方式与 Prometheus 表示指标的方式类似。当与 Prometheus 一起部署在环境中时，由于使用了相同的服务发现机制，来自 Promtail 的日志通常与你的应用指标具有相同的标签。拥有相同级别的日志和指标，用户可以在指标和日志之间无缝切换，帮助进行根本性原因分析。</p>
<p>Kibana 被用于可视化和搜索 Elasticsearch 数据，并且在对这些数据进行分析时非常强大。Kibana 提供了许多可视化工具来做数据分析，例如地图、用于异常检测的机器学习，以及关系图。也可以配置报警，当出现意外情况时，可以通知用户。</p>
<p>相比之下，Grafana 是专门针对 Prometheus 和 Loki 等数据源的时间序列数据定制的。仪表板可以设置为可视化指标（即将推出的日志支持），也可以使用探索视图对数据进行临时查询。和 Kibana 一样，Grafana 也支持根据你的指标进行报警。</p>
<h1 id="2-安装">2. 安装</h1>
<p>官方推荐使用 Tanka 进行安装，Tanka 是 Grafana 重新实现的 Ksonnect 版本，在 Grafana 内部用于生产环境部署，但是 Tanka 目前使用并不多，熟悉的人较少，所以我们这里就不介绍这种方式了。主要介绍下面 3 种方式。</p>
<h2 id="21-使用-helm-安装-loki">2.1 使用 Helm 安装 Loki</h2>
<h3 id="前提">前提</h3>
<p>首先需要确保已经部署了 Kubernetes 集群，并安装配置了 Helm 客户端，然后添加 <a href="https://github.com/grafana/loki/tree/master/production/helm/loki">Loki 的 chart 仓库</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm repo add loki <span style="color:#ff79c6">[</span>https://grafana.github.io/loki/charts<span style="color:#ff79c6">](</span>https://grafana.github.io/loki/charts<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>可以使用如下命令更新 chart 仓库：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm repo update
</span></span></code></pre></div><h3 id="部署-loki">部署 Loki</h3>
<p><strong>使用默认配置部署</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm upgrade --install loki loki/loki-stack
</span></span></code></pre></div><p><strong>指定命名空间</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm upgrade --install loki --namespace<span style="color:#ff79c6">=</span>loki loki/loki
</span></span></code></pre></div><p><strong>指定配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm upgrade --install loki loki/loki --set <span style="color:#f1fa8c">&#34;key1=val1,key2=val2,...&#34;</span>
</span></span></code></pre></div><p><strong>部署 Loki 工具栈（Loki, Promtail, Grafana, Prometheus）</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm upgrade --install loki loki/loki-stack --set grafana.enabled<span style="color:#ff79c6">=</span>true,prometheus.enabled<span style="color:#ff79c6">=</span>true,prometheus.alertmanager.persistentVolume.enabled<span style="color:#ff79c6">=</span>false,prometheus.server.persistentVolume.enabled<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span></code></pre></div><p><strong>部署 Loki 工具栈（Loki, Promtail, Grafana, Prometheus）</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm upgrade --install loki loki/loki-stack <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --set fluent-bit.enabled<span style="color:#ff79c6">=</span>true,promtail.enabled<span style="color:#ff79c6">=</span>false,grafana.enabled<span style="color:#ff79c6">=</span>true,prometheus.enabled<span style="color:#ff79c6">=</span>true,prometheus.alertmanager.persistentVolume.enabled<span style="color:#ff79c6">=</span>false,prometheus.server.persistentVolume.enabled<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span></code></pre></div><p><strong>部署 Grafana</strong></p>
<p>使用 Helm 安装 Grafana 到 Kubernetes 集群，可以使用如下所示命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm install stable/grafana -n loki-grafana
</span></span></code></pre></div><p>要获取 Grafana 管理员密码，可以使用如下所示命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get secret --namespace &lt;YOUR-NAMESPACE&gt; loki-grafana -o <span style="color:#8be9fd;font-style:italic">jsonpath</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;{.data.admin-password}&#34;</span> | base64 --decode ; <span style="color:#8be9fd;font-style:italic">echo</span>
</span></span></code></pre></div><p>要访问 Grafana UI 页面，可以使用下面的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl port-forward --namespace &lt;YOUR-NAMESPACE&gt; service/loki-grafana 3000:80
</span></span></code></pre></div><p>然后在浏览器中打开 <code>http://localhost:3000</code>，用 admin 和上面输出的密码进行登录。然后<a href="https://github.com/grafana/loki/blob/master/docs/getting-started/grafana.md">按照提示添加 Loki 数据源</a>，Loki 地址为 <code>http://loki:3100</code>。</p>
<p><strong>使用 HTTPS Ingress 访问 Loki</strong></p>
<p>如果 Loki 和 Promtail 部署在不同的集群上，你可以在 Loki 前面添加一个 Ingress 对象，通过添加证书，可以通过 HTTPS 进行访问，为了保证安全性，还可以在 Ingress 上启用 Basic Auth 认证。</p>
<p>在 Promtail 中，设置下面的 values 值来使用 HTTPS 和 Basic Auth 认证进行通信：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">loki</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">serviceScheme</span>: https
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">user</span>: user
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">password</span>: pass
</span></span></code></pre></div><p>Ingress 的 Helm 模板示例如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: extensions/v1beta1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Ingress
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">kubernetes.io/ingress.class</span>: {{ .Values.ingress.class }}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ingress.kubernetes.io/auth-type</span>: <span style="color:#f1fa8c">&#34;basic&#34;</span><span style="color:#ff79c6">ingress.kubernetes.io/auth-secret</span>: {{ .Values.ingress.basic.secret }}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: loki
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">host</span>: {{ .Values.ingress.host }}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">serviceName</span>: loki
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">servicePort</span>: <span style="color:#bd93f9">3100</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tls</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">secretName</span>: {{ .Values.ingress.cert }}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">hosts</span>:
</span></span><span style="display:flex;"><span>    - {{ .Values.ingress.host }}
</span></span></code></pre></div><h2 id="22-使用-docker-安装-loki">2.2 使用 Docker 安装 Loki</h2>
<p>我们可以使用 Docker 或 Docker Compose 安装 Loki，用来评估、测试或者开发 Lok，但是对于生产环境，我们推荐使用 Tanka 或者 Helm 方式。</p>
<h3 id="前提-1">前提</h3>
<ul>
<li><a href="https://docs.docker.com/install">Docker</a></li>
<li><a href="https://docs.docker.com/compose/install">Docker Compose</a>（可选，只有使用 Docker Compose 方式才需要安装）</li>
</ul>
<h3 id="使用-docker-安装">使用 Docker 安装</h3>
<p>直接拷贝下面的命令代码在命令行中执行：</p>
<p><strong>Linux</strong></p>
<p>执行完成后，loki-config.yaml 和 promtail-config.yaml 两个配置文件会被下载到我们使用的目录下面，Docker 容器会使用这些配置文件来运行 Loki 和 Promtail。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/grafana/loki/v1.5.0/cmd/loki/loki-local-config.yaml -O loki-config.yaml
</span></span><span style="display:flex;"><span>$ docker run -v <span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">pwd</span><span style="color:#ff79c6">)</span>:/mnt/config -p 3100:3100 grafana/loki:1.5.0 -config.file<span style="color:#ff79c6">=</span>/mnt/config/loki-config.yaml
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/grafana/loki/v1.5.0/cmd/promtail/promtail-docker-config.yaml -O promtail-config.yaml
</span></span><span style="display:flex;"><span>$ docker run -v <span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">pwd</span><span style="color:#ff79c6">)</span>:/mnt/config -v /var/log:/var/log grafana/promtail:1.5.0 -config.file<span style="color:#ff79c6">=</span>/mnt/config/promtail-config.yaml
</span></span></code></pre></div><h3 id="使用-docker-compose-安装">使用 Docker Compose 安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/grafana/loki/v1.5.0/production/docker-compose.yaml -O docker-compose.yaml
</span></span><span style="display:flex;"><span>$ docker-compose -f docker-compose.yaml up
</span></span></code></pre></div><h2 id="23-本地安装-loki">2.3 本地安装 Loki</h2>
<h3 id="二进制文件">二进制文件</h3>
<p>每个版本都包括 Loki 的二进制文件，可以在 GitHub 的 <a href="https://github.com/grafana/loki/releases">Release 页面</a>上找到。</p>
<h3 id="opensuse-linux-安装包">openSUSE Linux 安装包</h3>
<p>社区为 openSUSE Linux 提供了 Loki 的软件包，可以使用下面的方式来安装：</p>
<ul>
<li>添加仓库 <a href="https://download.opensuse.org/repositories/security:/logging/"><code>https://download.opensuse.org/repositories/security:/logging/</code></a>到系统中。比如你在使用 Leap 15.1，执行命令 <code>sudo zypper ar [https://download.opensuse.org/repositories/security:/logging/openSUSE_Leap_15.1/security:logging.repo](https://download.opensuse.org/repositories/security:/logging/openSUSE_Leap_15.1/security:logging.repo) ; sudo zypper ref</code></li>
<li>使用命令 <code>zypper in loki</code> 安装 Loki 软件包</li>
<li>启动 Loki 和 Promtail 服务：
<ul>
<li><code>systemd start promtail &amp;&amp; systemd enable promtail</code></li>
<li><code>systemd start loki &amp;&amp; systemd enable loki</code></li>
</ul>
</li>
<li>根据需求修改配置文件：<code>/etc/loki/promtail.yaml</code> 和 <code>/etc/loki/loki.yaml</code> 。</li>
</ul>
<h3 id="手动构建">手动构建</h3>
<p><strong>前提</strong></p>
<ul>
<li>Go 1.13+ 版本</li>
<li>Make</li>
<li>Docker（用于更新 protobuf 文件和 yacc 文件）</li>
</ul>
<p><strong>构建</strong></p>
<p>克隆 Loki 代码到 <code>$GOPATH/src/github.com/grafana/loki</code> 路径：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git clone <span style="color:#ff79c6">[</span>https://github.com/grafana/loki<span style="color:#ff79c6">](</span>https://github.com/grafana/loki<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/grafana/loki
</span></span></code></pre></div><p>然后切换到代码目录执行 <code>make loki</code> 命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">cd</span> <span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/grafana/loki
</span></span><span style="display:flex;"><span>$ make loki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ./cmd/loki/loki 目录下面将会生成最终的二进制文件。</span>
</span></span></code></pre></div><h1 id="3-开始使用-loki">3. 开始使用 Loki</h1>
<h2 id="31-loki-在-grafana-中的配置">3.1 Loki 在 Grafana 中的配置</h2>
<p>Grafana 在 6.0 以上的版本中内置了对 Loki 的支持。建议使用 6.3 或更高版本，就可以使用新的 LogQL 功能。</p>
<ul>
<li>登录 Grafana 实例，如果这是你第一次运行 Grafana，用户名和密码都默认为<code>admin</code>。</li>
<li>在 Grafana 中，通过左侧侧边栏上的图标转到 &ldquo;<code>配置 &gt; 数据源</code>&quot;。</li>
<li>单击 <code>+ Add data source</code> 按钮。</li>
<li>在列表中选择 Loki。</li>
<li>Http URL 字段是你的 Loki 服务器的地址，例如，在本地运行或使用端口映射的 Docker 运行时，地址可能是 <a href="http://localhost:3100/">http://localhost:3100</a>。使用 docker-compose 或 Kubernetes 运行时，地址很可能是 <a href="https://loki:3100/">https://loki:3100</a>。</li>
<li>要查看日志，可以单击侧边栏上的 &ldquo;<code>探索</code>&quot;，在左上角下拉菜单中选择 Loki 数据源，然后使用日志标签按钮过滤日志流。</li>
</ul>
<h2 id="32-使用-logcli-查询-loki">3.2 使用 LogCLI 查询 Loki</h2>
<p>如果您喜欢命令行界面，<code>LogCLI</code> 允许用户针对 Loki 服务器使用 LogQL 查询。</p>
<h3 id="安装">安装</h3>
<p><strong>二进制（推荐）</strong></p>
<p>在 <a href="https://github.com/grafana/loki/releases">Release 页面</a>中下载的 release 包中就包含 logcli 的二进制文件。</p>
<p><strong>源码安装</strong></p>
<p>同样你也可以使用 golang 直接对源码进行编译，使用如下所示的 <code>go get</code> 命令获取 <code>logcli</code>，二进制文件会出现在 <code>$GOPATH/bin</code> 目录下面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go get github.com/grafana/loki/cmd/logcli
</span></span></code></pre></div><h3 id="使用示例">使用示例</h3>
<p>假设你现在使用的是 Grafana Cloud，需要设置下面几个环境变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">LOKI_ADDR</span><span style="color:#ff79c6">=</span>https://logs-us-west1.grafana.net
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">LOKI_USERNAME</span><span style="color:#ff79c6">=</span>&lt;username&gt;
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">LOKI_PASSWORD</span><span style="color:#ff79c6">=</span>&lt;password&gt;
</span></span></code></pre></div><p>如果你使用的是本地的 Grafana，则可以直接将 LogCLI 指向本地的实例，而不需要用户名和密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">LOKI_ADDR</span><span style="color:#ff79c6">=</span>http://localhost:3100
</span></span></code></pre></div><blockquote>
<p>注意：如果你在 Loki 前面添加了代理服务器，并且配置了身份验证，那么还是需要配置对应的 <code>LOKI_USERNAME</code> 和 <code>LOKI_PASSWORD</code> 数据。</p>
</blockquote>
<p>配置完成后可以使用如下所示的一些 <code>logcli</code> 命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ logcli labels job
</span></span><span style="display:flex;"><span>https://logs-dev-ops-tools1.grafana.net/api/prom/label/job/values
</span></span><span style="display:flex;"><span>cortex-ops/consul
</span></span><span style="display:flex;"><span>cortex-ops/cortex-gw
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ logcli query <span style="color:#f1fa8c">&#39;{job=&#34;cortex-ops/consul&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>https://logs-dev-ops-tools1.grafana.net/api/prom/query?query<span style="color:#ff79c6">=</span>%7Bjob%3D%22cortex-ops%2Fconsul%22%7D&amp;<span style="color:#8be9fd;font-style:italic">limit</span><span style="color:#ff79c6">=</span>30&amp;<span style="color:#8be9fd;font-style:italic">start</span><span style="color:#ff79c6">=</span>1529928228&amp;<span style="color:#8be9fd;font-style:italic">end</span><span style="color:#ff79c6">=</span>1529931828&amp;<span style="color:#8be9fd;font-style:italic">direction</span><span style="color:#ff79c6">=</span>backward&amp;<span style="color:#8be9fd;font-style:italic">regexp</span><span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>Common labels: <span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;cortex-ops/consul&#34;</span>, <span style="color:#8be9fd;font-style:italic">namespace</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;cortex-ops&#34;</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>2018-06-25T12:52:09Z <span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">instance</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;consul-8576459955-pl75w&#34;</span><span style="color:#ff79c6">}</span> 2018/06/25 12:52:09 <span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> raft: Snapshot to <span style="color:#bd93f9">475409</span> <span style="color:#8be9fd;font-style:italic">complete</span>
</span></span><span style="display:flex;"><span>2018-06-25T12:52:09Z <span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">instance</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;consul-8576459955-pl75w&#34;</span><span style="color:#ff79c6">}</span> 2018/06/25 12:52:09 <span style="color:#ff79c6">[</span>INFO<span style="color:#ff79c6">]</span> raft: Compacting logs from <span style="color:#bd93f9">456973</span> to <span style="color:#bd93f9">465169</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ logcli series -q --match<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;{namespace=&#34;loki&#34;,container_name=&#34;loki&#34;}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">app</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki&#34;</span>, <span style="color:#8be9fd;font-style:italic">container_name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki&#34;</span>, <span style="color:#8be9fd;font-style:italic">controller_revision_hash</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki-57c9df47f4&#34;</span>, <span style="color:#8be9fd;font-style:italic">filename</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;/var/log/pods/loki_loki-0_8ed03ded-bacb-4b13-a6fe-53a445a15887/loki/0.log&#34;</span>, <span style="color:#8be9fd;font-style:italic">instance</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki-0&#34;</span>, <span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki/loki&#34;</span>, <span style="color:#8be9fd;font-style:italic">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki&#34;</span>, <span style="color:#8be9fd;font-style:italic">namespace</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki&#34;</span>, <span style="color:#8be9fd;font-style:italic">release</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki&#34;</span>, <span style="color:#8be9fd;font-style:italic">statefulset_kubernetes_io_pod_name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;loki-0&#34;</span>, <span style="color:#8be9fd;font-style:italic">stream</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;stderr&#34;</span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>批量查询</strong></p>
<p>从 Loki 1.6.0 开始，logcli 会分批向 Loki 发送日志查询。</p>
<p>如果你将查询的<code>--limit</code> 参数（默认为 30）设置为一个较大的数，比如 10000，那么 logcli 会自动将此请求分批发送到 Loki，默认的批次大小是 1000。</p>
<!-- raw HTML omitted -->
<p>Loki 对查询中返回的最大行数有一个服务端的限制（默认为 5000）。批量发送允许你发出比服务端限制更大的请求，只要 <code>--batch</code> 大小小于服务器限制。</p>
<p>请注意，每个批次的查询元数据都会被打印在 stderr 上，可以通过设置<code>--quiet</code> 参数来停止这个动作。</p>
<blockquote>
<p>对于配置的值会根据环境变量和命令行标志从低到高生效。</p>
</blockquote>
<h3 id="命令详情">命令详情</h3>
<p><code>logcli</code> 命令行工具详细的使用信息如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ logcli <span style="color:#8be9fd;font-style:italic">help</span>
</span></span><span style="display:flex;"><span>usage: logcli <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> &lt;command&gt; <span style="color:#ff79c6">[</span>&lt;args&gt; ...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>A command-line <span style="color:#ff79c6">for</span> loki.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --help             Show context-sensitive <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>also try --help-long and --help-man<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --version          Show application version.
</span></span><span style="display:flex;"><span>  -q, --quiet            Suppress query metadata.
</span></span><span style="display:flex;"><span>      --stats            Show query statistics.
</span></span><span style="display:flex;"><span>  -o, --output<span style="color:#ff79c6">=</span>default   Specify output mode <span style="color:#ff79c6">[</span>default, raw, jsonl<span style="color:#ff79c6">]</span>. raw suppresses log labels and timestamp.
</span></span><span style="display:flex;"><span>  -z, --timezone<span style="color:#ff79c6">=</span>Local   Specify the timezone to use when formatting output timestamps <span style="color:#ff79c6">[</span>Local, UTC<span style="color:#ff79c6">]</span>.
</span></span><span style="display:flex;"><span>      --cpuprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Specify the location <span style="color:#ff79c6">for</span> writing a CPU profile.
</span></span><span style="display:flex;"><span>      --memprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Specify the location <span style="color:#ff79c6">for</span> writing a memory profile.
</span></span><span style="display:flex;"><span>      --addr<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://localhost:3100&#34;</span>
</span></span><span style="display:flex;"><span>                         Server address. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_ADDR env var.
</span></span><span style="display:flex;"><span>      --username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Username <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_USERNAME env var.
</span></span><span style="display:flex;"><span>      --password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Password <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_PASSWORD env var.
</span></span><span style="display:flex;"><span>      --ca-cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>       Path to the server Certificate Authority. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CA_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --tls-skip-verify  Server certificate TLS skip verify.
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>          Path to the client certificate. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>           Path to the client certificate key. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_KEY_PATH env var.
</span></span><span style="display:flex;"><span>      --org-id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>        adds X-Scope-OrgID to API requests <span style="color:#ff79c6">for</span> representing tenant ID. Useful <span style="color:#ff79c6">for</span> requesting tenant data when
</span></span><span style="display:flex;"><span>                         bypassing an auth gateway.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Commands:
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">[</span>&lt;command&gt;...<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>    Show help.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  query <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> &lt;query&gt;
</span></span><span style="display:flex;"><span>    Run a LogQL query.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    The <span style="color:#f1fa8c">&#34;query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span> is useful <span style="color:#ff79c6">for</span> querying <span style="color:#ff79c6">for</span> logs. Logs can be returned in a few output modes:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      raw: log line
</span></span><span style="display:flex;"><span>      default: log timestamp + log labels + log line
</span></span><span style="display:flex;"><span>      jsonl: JSON response from Loki API of log line
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    The output of the log can be specified with the <span style="color:#f1fa8c">&#34;-o&#34;</span> flag, <span style="color:#ff79c6">for</span> example, <span style="color:#f1fa8c">&#34;-o raw&#34;</span> <span style="color:#ff79c6">for</span> the raw output format.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    The <span style="color:#f1fa8c">&#34;query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span> will output extra information about the query and its results, such as the API URL, <span style="color:#8be9fd;font-style:italic">set</span> of common labels,
</span></span><span style="display:flex;"><span>    and <span style="color:#8be9fd;font-style:italic">set</span> of excluded labels. This extra information can be suppressed with the --quiet flag.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    While <span style="color:#f1fa8c">&#34;query&#34;</span> does support metrics queries, its output contains multiple data points between the start and end query time.
</span></span><span style="display:flex;"><span>    This output is used to build graphs, like what is seen in the Grafana Explore graph view. If you are querying metrics and just
</span></span><span style="display:flex;"><span>    want the most recent data point <span style="color:#ff79c6">(</span>like what is seen in the Grafana Explore table view<span style="color:#ff79c6">)</span>, <span style="color:#ff79c6">then</span> you should use the <span style="color:#f1fa8c">&#34;instant-query&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">command</span> instead.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  instant-query <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> &lt;query&gt;
</span></span><span style="display:flex;"><span>    Run an instant LogQL query.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    The <span style="color:#f1fa8c">&#34;instant-query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span> is useful <span style="color:#ff79c6">for</span> evaluating a metric query <span style="color:#ff79c6">for</span> a single point in time. This is equivalent to the
</span></span><span style="display:flex;"><span>    Grafana Explore table view; <span style="color:#ff79c6">if</span> you want a metrics query that is used to build a Grafana graph, you should use the <span style="color:#f1fa8c">&#34;query&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">command</span> instead.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    This <span style="color:#8be9fd;font-style:italic">command</span> does not produce useful output when querying <span style="color:#ff79c6">for</span> log lines; you should always use the <span style="color:#f1fa8c">&#34;query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span> when you
</span></span><span style="display:flex;"><span>    are running log queries.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    For more information about log queries and metric queries, refer to the LogQL documentation:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    https://grafana.com/docs/loki/latest/logql/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  labels <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>&lt;label&gt;<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>    Find values <span style="color:#ff79c6">for</span> a given label.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  series <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> &lt;matcher&gt;
</span></span><span style="display:flex;"><span>    Run series query.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ logcli <span style="color:#8be9fd;font-style:italic">help</span> query
</span></span><span style="display:flex;"><span>usage: logcli query <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> &lt;query&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Run a LogQL query.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#f1fa8c">&#34;query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span> is useful <span style="color:#ff79c6">for</span> querying <span style="color:#ff79c6">for</span> logs. Logs can be returned in a few output modes:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  raw: log line
</span></span><span style="display:flex;"><span>  default: log timestamp + log labels + log line
</span></span><span style="display:flex;"><span>  jsonl: JSON response from Loki API of log line
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The output of the log can be specified with the <span style="color:#f1fa8c">&#34;-o&#34;</span> flag, <span style="color:#ff79c6">for</span> example, <span style="color:#f1fa8c">&#34;-o raw&#34;</span> <span style="color:#ff79c6">for</span> the raw output format.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#f1fa8c">&#34;query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span> will output extra information about the query and its results, such as the API URL, <span style="color:#8be9fd;font-style:italic">set</span> of common labels, and
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">set</span> of excluded labels. This extra information can be suppressed with the --quiet flag.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>While <span style="color:#f1fa8c">&#34;query&#34;</span> does support metrics queries, its output contains multiple data points between the start and end query time. This
</span></span><span style="display:flex;"><span>output is used to build graphs, like what is seen in the Grafana Explore graph view. If you are querying metrics and just want the
</span></span><span style="display:flex;"><span>most recent data point <span style="color:#ff79c6">(</span>like what is seen in the Grafana Explore table view<span style="color:#ff79c6">)</span>, <span style="color:#ff79c6">then</span> you should use the <span style="color:#f1fa8c">&#34;instant-query&#34;</span> <span style="color:#8be9fd;font-style:italic">command</span>
</span></span><span style="display:flex;"><span>instead.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --help               Show context-sensitive <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>also try --help-long and --help-man<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --version            Show application version.
</span></span><span style="display:flex;"><span>  -q, --quiet              Suppress query metadata.
</span></span><span style="display:flex;"><span>      --stats              Show query statistics.
</span></span><span style="display:flex;"><span>  -o, --output<span style="color:#ff79c6">=</span>default     Specify output mode <span style="color:#ff79c6">[</span>default, raw, jsonl<span style="color:#ff79c6">]</span>. raw suppresses log labels and timestamp.
</span></span><span style="display:flex;"><span>  -z, --timezone<span style="color:#ff79c6">=</span>Local     Specify the timezone to use when formatting output timestamps <span style="color:#ff79c6">[</span>Local, UTC<span style="color:#ff79c6">]</span>.
</span></span><span style="display:flex;"><span>      --cpuprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Specify the location <span style="color:#ff79c6">for</span> writing a CPU profile.
</span></span><span style="display:flex;"><span>      --memprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Specify the location <span style="color:#ff79c6">for</span> writing a memory profile.
</span></span><span style="display:flex;"><span>      --addr<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://localhost:3100&#34;</span>
</span></span><span style="display:flex;"><span>                           Server address. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_ADDR env var.
</span></span><span style="display:flex;"><span>      --username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>        Username <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_USERNAME env var.
</span></span><span style="display:flex;"><span>      --password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>        Password <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_PASSWORD env var.
</span></span><span style="display:flex;"><span>      --ca-cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>         Path to the server Certificate Authority. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CA_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --tls-skip-verify    Server certificate TLS skip verify.
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>            Path to the client certificate. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>             Path to the client certificate key. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_KEY_PATH env var.
</span></span><span style="display:flex;"><span>      --org-id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>          adds X-Scope-OrgID to API requests <span style="color:#ff79c6">for</span> representing tenant ID. Useful <span style="color:#ff79c6">for</span> requesting tenant data when
</span></span><span style="display:flex;"><span>                           bypassing an auth gateway.
</span></span><span style="display:flex;"><span>      --limit<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span>           Limit on number of entries to print.
</span></span><span style="display:flex;"><span>      --since<span style="color:#ff79c6">=</span>1h           Lookback window.
</span></span><span style="display:flex;"><span>      --from<span style="color:#ff79c6">=</span>FROM          Start looking <span style="color:#ff79c6">for</span> logs at this absolute <span style="color:#8be9fd;font-style:italic">time</span> <span style="color:#ff79c6">(</span>inclusive<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --to<span style="color:#ff79c6">=</span>TO              Stop looking <span style="color:#ff79c6">for</span> logs at this absolute <span style="color:#8be9fd;font-style:italic">time</span> <span style="color:#ff79c6">(</span>exclusive<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --step<span style="color:#ff79c6">=</span>STEP          Query resolution step width, <span style="color:#ff79c6">for</span> metric queries. Evaluate the query at the specified step over the <span style="color:#8be9fd;font-style:italic">time</span>
</span></span><span style="display:flex;"><span>                           range.
</span></span><span style="display:flex;"><span>      --interval<span style="color:#ff79c6">=</span>INTERVAL  Query interval, <span style="color:#ff79c6">for</span> log queries. Return entries at the specified interval, ignoring those between.
</span></span><span style="display:flex;"><span>                           **This parameter is experimental, please see Issue 1779**.
</span></span><span style="display:flex;"><span>      --batch<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>         Query batch size to use <span style="color:#ff79c6">until</span> <span style="color:#f1fa8c">&#39;limit&#39;</span> is reached.
</span></span><span style="display:flex;"><span>      --forward            Scan forwards through logs.
</span></span><span style="display:flex;"><span>      --no-labels          Do not print any labels.
</span></span><span style="display:flex;"><span>      --exclude-label<span style="color:#ff79c6">=</span>EXCLUDE-LABEL ...
</span></span><span style="display:flex;"><span>                           Exclude labels given the provided key during output.
</span></span><span style="display:flex;"><span>      --include-label<span style="color:#ff79c6">=</span>INCLUDE-LABEL ...
</span></span><span style="display:flex;"><span>                           Include labels given the provided key during output.
</span></span><span style="display:flex;"><span>      --labels-length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>    Set a fixed padding to labels.
</span></span><span style="display:flex;"><span>      --store-config<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Execute the current query using a configured storage from a given Loki configuration file.
</span></span><span style="display:flex;"><span>  -t, --tail               Tail the logs.
</span></span><span style="display:flex;"><span>      --delay-for<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>        Delay in tailing by number of seconds to accumulate logs <span style="color:#ff79c6">for</span> re-ordering.
</span></span><span style="display:flex;"><span>      --colored-output     Show ouput with colored labels.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Args:
</span></span><span style="display:flex;"><span>  &lt;query&gt;  eg <span style="color:#f1fa8c">&#39;{foo=&#34;bar&#34;,baz=~&#34;.*blip&#34;} |~ &#34;.*error.*&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ logcli <span style="color:#8be9fd;font-style:italic">help</span> labels
</span></span><span style="display:flex;"><span>usage: logcli labels <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">[</span>&lt;label&gt;<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Find values <span style="color:#ff79c6">for</span> a given label.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --help             Show context-sensitive <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>also try --help-long and --help-man<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --version          Show application version.
</span></span><span style="display:flex;"><span>  -q, --quiet            Suppress query metadata.
</span></span><span style="display:flex;"><span>      --stats            Show query statistics.
</span></span><span style="display:flex;"><span>  -o, --output<span style="color:#ff79c6">=</span>default   Specify output mode <span style="color:#ff79c6">[</span>default, raw, jsonl<span style="color:#ff79c6">]</span>. raw suppresses log labels and timestamp.
</span></span><span style="display:flex;"><span>  -z, --timezone<span style="color:#ff79c6">=</span>Local   Specify the timezone to use when formatting output timestamps <span style="color:#ff79c6">[</span>Local, UTC<span style="color:#ff79c6">]</span>.
</span></span><span style="display:flex;"><span>      --cpuprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Specify the location <span style="color:#ff79c6">for</span> writing a CPU profile.
</span></span><span style="display:flex;"><span>      --memprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Specify the location <span style="color:#ff79c6">for</span> writing a memory profile.
</span></span><span style="display:flex;"><span>      --addr<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://localhost:3100&#34;</span>
</span></span><span style="display:flex;"><span>                         Server address. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_ADDR env var.
</span></span><span style="display:flex;"><span>      --username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Username <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_USERNAME env var.
</span></span><span style="display:flex;"><span>      --password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Password <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_PASSWORD env var.
</span></span><span style="display:flex;"><span>      --ca-cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>       Path to the server Certificate Authority. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CA_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --tls-skip-verify  Server certificate TLS skip verify.
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>          Path to the client certificate. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>           Path to the client certificate key. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_KEY_PATH env var.
</span></span><span style="display:flex;"><span>      --org-id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>        adds X-Scope-OrgID to API requests <span style="color:#ff79c6">for</span> representing tenant ID. Useful <span style="color:#ff79c6">for</span> requesting tenant data when
</span></span><span style="display:flex;"><span>                         bypassing an auth gateway.
</span></span><span style="display:flex;"><span>      --since<span style="color:#ff79c6">=</span>1h         Lookback window.
</span></span><span style="display:flex;"><span>      --from<span style="color:#ff79c6">=</span>FROM        Start looking <span style="color:#ff79c6">for</span> labels at this absolute <span style="color:#8be9fd;font-style:italic">time</span> <span style="color:#ff79c6">(</span>inclusive<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --to<span style="color:#ff79c6">=</span>TO            Stop looking <span style="color:#ff79c6">for</span> labels at this absolute <span style="color:#8be9fd;font-style:italic">time</span> <span style="color:#ff79c6">(</span>exclusive<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Args:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">[</span>&lt;label&gt;<span style="color:#ff79c6">]</span>  The name of the label.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ logcli <span style="color:#8be9fd;font-style:italic">help</span> series
</span></span><span style="display:flex;"><span>usage: logcli series --match<span style="color:#ff79c6">=</span>MATCH <span style="color:#ff79c6">[</span>&lt;flags&gt;<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Run series query.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --help             Show context-sensitive <span style="color:#8be9fd;font-style:italic">help</span> <span style="color:#ff79c6">(</span>also try --help-long and --help-man<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --version          Show application version.
</span></span><span style="display:flex;"><span>  -q, --quiet            Suppress query metadata.
</span></span><span style="display:flex;"><span>      --stats            Show query statistics.
</span></span><span style="display:flex;"><span>  -o, --output<span style="color:#ff79c6">=</span>default   Specify output mode <span style="color:#ff79c6">[</span>default, raw, jsonl<span style="color:#ff79c6">]</span>. raw suppresses log labels and timestamp.
</span></span><span style="display:flex;"><span>  -z, --timezone<span style="color:#ff79c6">=</span>Local   Specify the timezone to use when formatting output timestamps <span style="color:#ff79c6">[</span>Local, UTC<span style="color:#ff79c6">]</span>.
</span></span><span style="display:flex;"><span>      --cpuprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Specify the location <span style="color:#ff79c6">for</span> writing a CPU profile.
</span></span><span style="display:flex;"><span>      --memprofile<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>    Specify the location <span style="color:#ff79c6">for</span> writing a memory profile.
</span></span><span style="display:flex;"><span>      --addr<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://localhost:3100&#34;</span>
</span></span><span style="display:flex;"><span>                         Server address. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_ADDR env var.
</span></span><span style="display:flex;"><span>      --username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Username <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_USERNAME env var.
</span></span><span style="display:flex;"><span>      --password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>      Password <span style="color:#ff79c6">for</span> HTTP basic auth. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_PASSWORD env var.
</span></span><span style="display:flex;"><span>      --ca-cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>       Path to the server Certificate Authority. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CA_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --tls-skip-verify  Server certificate TLS skip verify.
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>          Path to the client certificate. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_CERT_PATH env var.
</span></span><span style="display:flex;"><span>      --key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>           Path to the client certificate key. Can also be <span style="color:#8be9fd;font-style:italic">set</span> using LOKI_CLIENT_KEY_PATH env var.
</span></span><span style="display:flex;"><span>      --org-id<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>        adds X-Scope-OrgID to API requests <span style="color:#ff79c6">for</span> representing tenant ID. Useful <span style="color:#ff79c6">for</span> requesting tenant data when
</span></span><span style="display:flex;"><span>                         bypassing an auth gateway.
</span></span><span style="display:flex;"><span>      --since<span style="color:#ff79c6">=</span>1h         Lookback window.
</span></span><span style="display:flex;"><span>      --from<span style="color:#ff79c6">=</span>FROM        Start looking <span style="color:#ff79c6">for</span> logs at this absolute <span style="color:#8be9fd;font-style:italic">time</span> <span style="color:#ff79c6">(</span>inclusive<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --to<span style="color:#ff79c6">=</span>TO            Stop looking <span style="color:#ff79c6">for</span> logs at this absolute <span style="color:#8be9fd;font-style:italic">time</span> <span style="color:#ff79c6">(</span>exclusive<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>      --match<span style="color:#ff79c6">=</span>MATCH ...  eg <span style="color:#f1fa8c">&#39;{foo=&#34;bar&#34;,baz=~&#34;.*blip&#34;}&#39;</span>
</span></span></code></pre></div><h2 id="33-label-标签">3.3 Label 标签</h2>
<p>Label 标签是一个键值对，可以定义任何东西，我们喜欢称它们为描述日志流的元数据。如果你熟悉 Prometheus，那么一定对 Label 标签有一定的了解，在 Loki 的 scrape 配置中也定义了这些标签，和 Prometheus 拥有一致的功能，这些标签非常容易将应用程序指标和日志数据关联起来。</p>
<p>Loki 中的标签执行一个非常重要的任务：它们定义了一个流。更具体地说，每个标签键和值的组合定义了流。如果只是一个标签值变化，这将创建一个新的流。</p>
<p>如果你熟悉 Prometheus，那里的术语叫序列，而且 Prometheus 中还有一个额外的维度：指标名称。Loki 中简化了这一点，因为没有指标名，只有标签，所以最后决定使用流而不是序列。</p>
<h3 id="标签示例">标签示例</h3>
<p>下面的示例将说明 Loki 中 Label 标签的基本使用和概念。</p>
<p>首先看下下面的示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: system
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">pipeline_stages</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>:
</span></span><span style="display:flex;"><span>          - localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">job</span>: syslog
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">__path__</span>: /var/log/syslog
</span></span></code></pre></div><p>这个配置将获取日志文件数据并添加一个 <code>job=syslog</code> 的标签，我们可以这样来查询：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;syslog&#34;</span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>这将在 Loki 中创建一个流。现在我们再新增一些任务配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: system
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">pipeline_stages</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>:
</span></span><span style="display:flex;"><span>          - localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">job</span>: syslog
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">__path__</span>: /var/log/syslog
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: system
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">pipeline_stages</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>:
</span></span><span style="display:flex;"><span>          - localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">job</span>: apache
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">__path__</span>: /var/log/apache.log
</span></span></code></pre></div><p>现在我们采集两个日志文件，每个文件有一个标签与一个值，所以 Loki 会存储为两个流。我们可以通过下面几种方式来查询这些流：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;apache&#34;</span><span style="color:#ff79c6">}</span> &lt;- 显示 job 标签为 apache 的日志
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;syslog&#34;</span><span style="color:#ff79c6">}</span> &lt;- 显示 job 标签为 syslog 的日志
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span>~<span style="color:#f1fa8c">&#34;apache|syslog&#34;</span><span style="color:#ff79c6">}</span> &lt;- 显示 job 标签为 apache 或者 syslog 的日志
</span></span></code></pre></div><p>最后一种方式我们使用的是一个 <code>regex</code> 标签匹配器来获取 job 标签值为 apache 或者 syslog 的日志。接下来我们看看如何使用额外的标签：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: system
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">pipeline_stages</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>:
</span></span><span style="display:flex;"><span>          - localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">job</span>: syslog
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>: dev
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">__path__</span>: /var/log/syslog
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: system
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">pipeline_stages</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>:
</span></span><span style="display:flex;"><span>          - localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">job</span>: apache
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">env</span>: dev
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">__path__</span>: /var/log/apache.log
</span></span></code></pre></div><p>要获取这两个任务的日志可以用下面的方式来代替 regex 的方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{env=&#34;dev&#34;} &lt;- 将返回所有带有 env=dev 标签的日志
</span></span></code></pre></div><p>通过使用一个标签就可以查询很多日志流了，通过组合多个不同的标签，可以创建非常灵活的日志查询。</p>
<!-- raw HTML omitted -->
<p>Label 标签是 Loki 日志数据的索引，它们用于查找压缩后的日志内容，这些内容被单独存储为<code>块</code>。标签和值的每一个唯一组合都定义了一个<code>流</code> ，一个流的日志被分批，压缩，并作为块进行存储。</p>
<h3 id="cardinality势">Cardinality（势）</h3>
<p>前面的示例使用的是静态定义的 Label 标签，只有一个值；但是有一些方法可以动态定义标签。比如我们有下面这样的日志数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>11.11.11.11 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:01 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;GET /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">200</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span></code></pre></div><p>我们可以使用下面的方式来解析这条日志数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">job_name</span>: system
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">pipeline_stages</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">regex</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">expression</span>: <span style="color:#f1fa8c">&#34;^(?P&lt;ip&gt;\\S+) (?P&lt;identd&gt;\\S+) (?P&lt;user&gt;\\S+) \\[(?P&lt;timestamp&gt;[\\w:/]+\\s[+\\-]\\d{4})\\] \&#34;(?P&lt;action&gt;\\S+)\\s?(?P&lt;path&gt;\\S+)?\\s?(?P&lt;protocol&gt;\\S+)?\&#34; (?P&lt;status_code&gt;\\d{3}|-) (?P&lt;size&gt;\\d+|-)\\s?\&#34;?(?P&lt;referer&gt;[^\&#34;]*)\&#34;?\\s?\&#34;?(?P&lt;useragent&gt;[^\&#34;]*)?\&#34;?$&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">action</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">status_code</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>   - <span style="color:#ff79c6">targets</span>:
</span></span><span style="display:flex;"><span>      - localhost
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">job</span>: apache
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">env</span>: dev
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">__path__</span>: /var/log/apache.log
</span></span></code></pre></div><p>这个 regex 匹配日志行的每个组件，并将每个组件的值提取到一个 capture 组里面。在 pipeline 代码内部，这些数据被放置到一个临时的数据结构中，允许在处理该日志行时将其用于其他处理（此时，临时数据将被丢弃）。</p>
<p>从该 regex 中，我们就使用其中的两个 capture 组，根据日志行本身的内容动态地设置两个标签：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>action <span style="color:#ff79c6">(</span>例如 <span style="color:#8be9fd;font-style:italic">action</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;GET&#34;</span>, <span style="color:#8be9fd;font-style:italic">action</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;POST&#34;</span><span style="color:#ff79c6">)</span> status_code <span style="color:#ff79c6">(</span>例如 <span style="color:#8be9fd;font-style:italic">status_code</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;200&#34;</span>, <span style="color:#8be9fd;font-style:italic">status_code</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;400&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>假设我们有下面几行日志数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>11.11.11.11 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:01 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;GET /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">200</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span><span style="display:flex;"><span>11.11.11.12 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:02 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;POST /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">200</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span><span style="display:flex;"><span>11.11.11.13 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:03 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;GET /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">400</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span><span style="display:flex;"><span>11.11.11.14 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:04 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;POST /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">400</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span></code></pre></div><p>则在 Loki 中收集日志后，会创建为如下所示的流：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;apache&#34;</span>,env<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;dev&#34;</span>,action<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;GET&#34;</span>,status_code<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;200&#34;</span><span style="color:#ff79c6">}</span> 11.11.11.11 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:01 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;GET /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">200</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;apache&#34;</span>,env<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;dev&#34;</span>,action<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;POST&#34;</span>,status_code<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;200&#34;</span><span style="color:#ff79c6">}</span> 11.11.11.12 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:02 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;POST /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">200</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;apache&#34;</span>,env<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;dev&#34;</span>,action<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;GET&#34;</span>,status_code<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;400&#34;</span><span style="color:#ff79c6">}</span> 11.11.11.13 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:03 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;GET /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">400</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;apache&#34;</span>,env<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;dev&#34;</span>,action<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;POST&#34;</span>,status_code<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;400&#34;</span><span style="color:#ff79c6">}</span> 11.11.11.14 - frank <span style="color:#ff79c6">[</span>25/Jan/2000:14:00:04 -0500<span style="color:#ff79c6">]</span> <span style="color:#f1fa8c">&#34;POST /1986.js HTTP/1.1&#34;</span> <span style="color:#bd93f9">400</span> <span style="color:#bd93f9">932</span> <span style="color:#f1fa8c">&#34;-&#34;</span> <span style="color:#f1fa8c">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</span></span></code></pre></div><p>这 4 行日志将成为 4 个独立的流，并开始填充 4 个独立的块。任何与这些 <code>标签/值</code> 组合相匹配的额外日志行将被添加到现有的流中。如果有另一个独特的标签组合进来（比如 status_code=&ldquo;500&rdquo;）就会创建另一个新的流。</p>
<p>比如我们为 IP 设置一个 Label 标签，不仅用户的每一个请求都会变成一个唯一的流，每一个来自同一用户的不同 action 或 status_code 的请求都会得到自己的流。</p>
<p>如果有 4 个共同的操作（GET、PUT、POST、DELETE）和 4 个共同的状态码（可能不止 4 个！），这将会是 16 个流和 16 个独立的块。然后现在乘以每个用户，如果我们使用 IP 的标签，你将很快就会有数千或数万个流了。</p>
<p>这个 Cardinality 太高了，这足以让 Loki 挂掉。</p>
<p>当我们谈论 Cardinality 的时候，我们指的是标签和值的组合，以及他们创建的流的数量，高 Cardinality 是指使用具有较大范围的可能值的标签，如 IP，或结合需要其他标签，即使它们有一个小而有限的集合，比如 status_code 和 action。</p>
<p>高 Cardinality 会导致 Loki 建立一个巨大的索引（💰💰💰💰），并将成千上万的微小块存入对象存储中（慢），Loki 目前在这种配置下的性能非常差，运行和使用起来非常不划算的。</p>
<h3 id="loki-性能优化">Loki 性能优化</h3>
<p>现在我们知道了如果使用大量的标签或有大量值的标签是不好的，那我应该如何查询我的日志呢？如果没有一个数据是有索引的，那么查询不会真的很慢吗？</p>
<p>我们看到使用 Loki 的人习惯了其他重索引的解决方案，他们就觉得需要定义很多标签，才可以有效地查询日志，毕竟很多其他的日志解决方案都是为了索引，这是之前的惯性思维方式。</p>
<p>在使用 Loki 的时候，你可能需要忘记你所知道的东西，看看如何用<code>并行化</code>的方式来解决这个问题。Loki 的超强之处在于将查询拆成小块，并行调度，这样你就可以在少量时间内查询大量的日志数据了。</p>
<p>大型索引是非常复杂而昂贵的，通常情况下，你的日志数据的全文索引与日志数据本身的大小相当或更大。要查询你的日志数据，需要加载这个索引，为了性能，可能在内存中，这就非常难扩展了，当你采集了大量的日志时，你的索引就会变得很大。</p>
<p>现在我们来谈谈 Loki，索引通常比你采集的日志量小一个数量级。所以，如果你很好地将你的流保持在最低限度，那么指数的增长和采集的日志相比就非常缓慢了。</p>
<p>Loki 将有效地使你的静态成本尽可能低（索引大小和内存需求以及静态日志存储），并使查询性能可以在运行时通过水平伸缩进行控制。</p>
<p>为了了解是如何工作的，让我们回过头来看看上面我们查询访问日志数据的特定 IP 地址的例子，我们不使用标签来存储 IP，相反，我们使用一个过滤器表达式来查询它。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#8be9fd;font-style:italic">job</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;apache&#34;</span><span style="color:#ff79c6">}</span> |<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;11.11.11.11&#34;</span>
</span></span></code></pre></div><p>在背后 Loki 会将该查询分解成更小的碎片（shards），并为标签匹配的流打开每个块（chunk），并开始查找这个 IP 地址。</p>
<p>这些碎片的大小和并行化的数量是可配置的，并基于你提供的资源。如果你愿意，可以将 shard 间隔配置到 5m，部署 20 个查询器，并在几秒内处理千兆字节的日志。或者你可以更加疯狂地配置 200 个查询器，处理 TB 级别的日志！</p>
<p>这种较小的索引和并行查询与较大/较快的全文索引之间的权衡，是让 Loki 相对于其他系统节省成本的原因。操作大型索引的成本和复杂度很高，而且通常是固定的，无论是是否在查询它，你都要一天 24 小时为它付费。</p>
<p>这种设计的好处是，你可以决定你想拥有多大的查询能力，而且你可以按需变更。查询性能成为你想花多少钱的函数。同时数据被大量压缩并存储在低成本的对象存储中，比如 S3 和 GCS。这就将固定的运营成本降到了最低，同时还能提供难以置信的快速查询能力。</p>
<!-- raw HTML omitted -->

          <h2>微信公众号</h2>
<p>
  扫描下面的二维码关注我们的微信公众帐号，在微信公众帐号中回复◉加群◉即可加入到我们的
  kubernetes 讨论群里面共同学习。
</p>
<img
  src="https://picdn.youdianzhishi.com/images/qrcode.png"
  alt="wechat-account-qrcode"
/>

  
          
            <div class="entry-shang text-center">
    <p>「真诚赞赏，手留余香」</p>
    <button class="zs show-zs btn btn-bred">赞赏</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
    <div class="zs-modal-head">
        <button type="button" class="close">×</button>
        <span class="author"><img src="https://www.qikqiak.com/img/avatar.jpeg"/>阳明</span>
        <p class="tip"><i></i><span>请我喝杯咖啡？</span></p>
    </div>
    <div class="zs-modal-body">
        <div class="zs-modal-btns">
            <button class="btn btn-blink" data-num="2">2元</button>
            <button class="btn btn-blink" data-num="5">5元</button>
            <button class="btn btn-blink" data-num="10">10元</button>
            <button class="btn btn-blink" data-num="50">50元</button>
            <button class="btn btn-blink" data-num="100">100元</button>
            <button class="btn btn-blink" data-num="1">任意金额</button>
        </div>
        <div class="zs-modal-pay">
            <button class="btn btn-bred" id="pay-text">2元</button>
            <p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
            <img src="https://www.qikqiak.com/img/wechat-2.png" id="pay-image"/>
        </div>
    </div>
    <div class="zs-modal-footer">
        <span class="zs-wechat"><img src="https://www.qikqiak.com/img/wechat-btn.png"/></span>
    </div>
</div>
          
          
            <div class="social-share" data-initialized="true" style="margin-bottom: 20px;margin-top:20px;">
    <center>
    <a href="#" class="social-share-icon icon-weibo"></a>
    <a href="#" class="social-share-icon icon-wechat"></a>
    <a href="#" class="social-share-icon icon-twitter"></a>
    <a href="#" class="social-share-icon icon-linkedin"></a>
    <a href="#" class="social-share-icon icon-facebook"></a>
    <a href="#" class="social-share-icon icon-qq"></a>
    <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

          
        </article>
  
        
          

<h3>相关文章</h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="https://www.qikqiak.com/post/grafana-log-tool-loki/">Grafana 日志聚合工具 Loki</a></li>
    
    <li><a href="https://www.qikqiak.com/post/use-crd-create-grafana-dashboard/">用 Kubernetes 资源对象创建 Grafana Dashboard</a></li>
    
    <li><a href="https://www.qikqiak.com/post/grafana-usage-in-k8s/">Grafana 在 Kubernetes 中的使用</a></li>
    
    <li><a href="https://www.qikqiak.com/post/update-prometheus-2-in-kubernetes/">Kubernetes 下升级Prometheus2.0</a></li>
    
    <li><a href="https://www.qikqiak.com/post/kubernetes-monitor-prometheus-grafana/">Kubernetes使用Prometheus搭建监控平台</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-monitor-use-elastic-stack-1/">使用 Elastic 技术栈构建 K8S 全栈监控(1/4)</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-monitor-use-elastic-stack-2/">使用 Elastic 技术栈构建 K8S 全栈监控(2/4)</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-monitor-use-elastic-stack-3/">使用 Elastic 技术栈构建 K8S 全栈监控(3/4)</a></li>
    
    <li><a href="https://www.qikqiak.com/post/k8s-monitor-use-elastic-stack-4/">使用 Elastic 技术栈构建 K8S 全栈监控(4/4)</a></li>
    
    <li><a href="https://www.qikqiak.com/post/monitor-external-k8s-on-prometheus/">Prometheus 监控外部 Kubernetes 集群</a></li>
    
</ul>

        
  
        
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://www.qikqiak.com/post/gitlab-ci-argo-cd-gitops/" data-toggle="tooltip" data-placement="top" title="使用 GitLab CI 与 Argo CD 进行 GitOps 实践">&larr; 前一篇</a>
            </li>
          
          
            <li class="next">
              <a href="https://www.qikqiak.com/post/update-k8s-10y-expire-certs/" data-toggle="tooltip" data-placement="top" title="更新一个10年有效期的 Kubernetes 证书">后一篇 &rarr;</a>
            </li>
          
        </ul>
        

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-5376999672787220"
            data-ad-slot="3700507799"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
  
        
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    var gitalk = new Gitalk({
        clientID: 'bdb76dbb2e9d0786e350',
        clientSecret: 'b454b2a08013fd0e32013be7a63fa8fcb262b6c4',
        repo: 'blog',
        owner: 'cnych',
        admin: ['cnych'],
        labels: ['gitment'],
        title: 'Grafana Loki 简明教程',
        createIssueManually: true,
        id: 'grafana-loki-usage',      
        distractionFreeMode: true  
    });
    gitalk.render('gitalk-container');
</script>


        
          

        
  
      </div>
    
    
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          <img src="https://www.qikqiak.com/img/wechatmp.png" alt="k8s技术圈">
          
              <li>
                <a href="mailto:icnych@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://github.com/cnych" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://weibo.com/cnych" title="微博">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://instagram.com/cnych" title="Instagram">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          <li>
            <a href="https://www.qikqiak.com/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;
          2023

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/">阳明的博客</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/sitemap.xml">网站地图</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/archive/">归档</a>
            &nbsp;&bull;&nbsp;
            <a href="https://www.qikqiak.com/page/friend/">友链</a>
            &nbsp;&bull;&nbsp;
            <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备11027319号-5</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.io">kubernetes.io</a>
            <a class="h" href="https://www.qikqiak.com/page/kubernetes.org.cn">Kubernetes中文社区</a>
          
        </p>
        <p class="text-center text-muted">
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv" style="display:none">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          &nbsp;&bull;&nbsp;
          <span id="busuanzi_container_site_uv" style="display:none">
            访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
        </p>
        
        <p class="credits theme-by text-muted">
          由 <a href="http://gohugo.io">Hugo v0.115.4</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href="https://github.com/cnych/qikqiak.com">qikqiak-blog</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>


<script src='https://www.qikqiak.com/js/bundle.min.af02a2d23b6651a566f0135a12e65fc2560faa7a969b3d1ad58d0afe0c9164ae.js' integrity='sha256-rwKi0jtmUaVm8BNaEuZfwlYPqnqWmz0a1Y0K/gyRZK4='></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-69668147-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-69668147-3');
</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script >
$(document).ready(function() {
  var int = setInterval(fixCount, 50);  
  
  var initPVCount = 584976;
  var initUVCount = 153191;
  function fixCount() {                   
    if ($("#busuanzi_container_site_pv").css("display") != "none") {
        $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + initPVCount); 
        clearInterval(int); 
    }
    if ($("#busuanzi_container_site_uv").css("display") != "none") {
      $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + initUVCount);
      clearInterval(int); 
    }  
  }           
});
</script>
 <script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BJICPtxnbz-7vq9kEwH5psPCuHe2CvludQug4R2tuJGPF0GQT2hwSWTAhlSt2EFD5InpuQyxCGJdigf6-KbQ53c');</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery-migrate@1.2.1/dist/jquery-migrate.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script type="text/javascript">
$('.carousel').slick({
    dots: true,
    arrows: true,
    autoplay: true,
    autoplaySpeed: 4000,
    infinite: true,
    speed: 500,
    fade: true,
    cssEase: 'linear',
    centerMode: true,
    prevArrow: '<button type="button" class="slick-prev"></button>',
    nextArrow: '<button type="button" class="slick-next"></button>',
});
</script>

  </body>
</html>

