---
title: k8sæŠ€æœ¯åœˆä¸€å‘¨ç²¾é€‰[ç¬¬6æœŸ]
date: 2019-11-09
tags: ["kubernetes", "çŸ¥è¯†æ˜Ÿçƒ", "k8sæŠ€æœ¯åœˆ"]
keywords: ["kubernetes", "çŸ¥è¯†æ˜Ÿçƒ", "k8sæŠ€æœ¯åœˆ", "ç²¾é€‰"]
slug: k8s-tech-weekly-collection-phase6
gitcomment: true
notoc: true
category: "kubernetes"
---

[![k8sæŠ€æœ¯åœˆä¸€å‘¨ç²¾é€‰](https://bxdc-static.oss-cn-beijing.aliyuncs.com/images/k8s-weekly-phase6.png)](/post/k8s-tech-weekly-collection-phase6/)

æœ¬å‘¨çš„`k8sæŠ€æœ¯åœˆ`çš„å‡ ä¸ªç²¾é€‰çš„é—®é¢˜ï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚å¦å¤–ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶åŠ å…¥æˆ‘ä»¬çš„`ã€å¾®ä¿¡ç¾¤ã€‘`å’Œ`ã€çŸ¥è¯†æ˜Ÿçƒã€‘`å…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ã€‚

<!--more-->

## 1.å¦‚æœpodé•¿æœŸä¸é‡å¯ï¼Œå®¹å™¨è¾“å‡ºåˆ° emptydir çš„æ—¥å¿—æ–‡ä»¶ï¼Œæœ‰ä»€ä¹ˆå¥½çš„æ¸…ç†åŠæ³•å‘¢ï¼Ÿ

v1.7 + æ”¯æŒå¯¹åŸºäºæœ¬åœ°å­˜å‚¨ï¼ˆå¦‚ hostPath, emptyDir, gitRepo ç­‰ï¼‰çš„å®¹é‡è¿›è¡Œè°ƒåº¦é™é¢ã€‚ä¸ºäº†æ”¯æŒè¿™ä¸ªç‰¹æ€§ï¼ŒKubernetes å°†æœ¬åœ°å­˜å‚¨åˆ†ä¸ºä¸¤ç±»ï¼š

* `storage.kubernetes.io/overlay`ï¼Œå³ `/var/lib/docker` çš„å¤§å°
* `storage.kubernetes.io/scratch`ï¼Œå³ `/var/lib/kubelet` çš„å¤§å°

Kubernetes æ ¹æ® `storage.kubernetes.io/scratch` çš„å¤§å°æ¥è°ƒåº¦æœ¬åœ°å­˜å‚¨ç©ºé—´ï¼Œè€Œæ ¹æ® `storage.kubernetes.io/overlay` æ¥è°ƒåº¦å®¹å™¨çš„å­˜å‚¨ã€‚æ¯”å¦‚ä¸ºå®¹å™¨è¯·æ±‚ 64MB çš„å¯å†™å±‚å­˜å‚¨ç©ºé—´ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ls1
spec:
  restartPolicy: Never
  containers:
  - name: hello
    image: busybox
    command: ["df"]
    resources:
      requests:
        storage.kubernetes.io/overlay: 64Mi
```

ä¸º emptyDir è¯·æ±‚ 64MB çš„å­˜å‚¨ç©ºé—´ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ls1
spec:
  restartPolicy: Never
  containers:
  - name: hello
    image: busybox
    command: ["df"]
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    emptyDir:
      sizeLimit: 64Mi
```

## 2.kubeadm æ­å»ºé›†ç¾¤å¿˜è®°äº† join çš„å‘½ä»¤

åœ¨ä½¿ç”¨ kubeadm åˆå§‹åŒ–é›†ç¾¤çš„æ—¶å€™ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå¿˜è®°ä¿å­˜ join å‘½ä»¤ï¼Œæˆ–è€…åœ¨æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ token å¤±æ•ˆäº†ï¼Œè¦é‡æ–°è·å– join å‘½ä»¤æœ‰ä¸¤ç§æ–¹æ³•ï¼š

ç¬¬ä¸€ç§æ–¹æ³•ï¼šå¯ä»¥é€šè¿‡ kubeadm token create é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ tokenå€¼<new-token>ï¼›ç„¶åé€šè¿‡ openssl å‘½ä»¤æˆ–è€… CA è¯ä¹¦çš„ hash å€¼ï¼š
```shell
$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
<ca-cert-hash>
```

æœ€ç»ˆæ–°çš„ join å‘½ä»¤ä¸ºï¼š
```shell
$ kubeadm join <apiserver> --token <new-token> --discovery-token-ca-cert-hash sha256:<ca-cert-hash>
```

ç¬¬äºŒç§æ–¹æ³•ï¼šæ–°ç‰ˆæœ¬(>1.10)çš„ kubeadm æ”¯æŒç›´æ¥è·å– join å‘½ä»¤ï¼š
```shell
$ kubeadm token create --print-join-command
```

## 3.ServiceAccount å¦‚ä½•è¿›è¡Œæƒé™æ§åˆ¶
æˆ‘ä»¬çŸ¥é“ ServiceAccount æ˜¯é€šè¿‡ Role æˆ–è€… ClusterRole é‡Œé¢çš„æƒé™å£°æ˜æ¥è¿›è¡Œæƒé™æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæ˜¯æ€æ ·æ¥å®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬å¦‚æœåœ¨ä½¿ç”¨ ServiceAccount æ¥è¿›è¡Œæƒé™æ§åˆ¶äº†ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯æˆ‘ä»¬å½“å‰çš„ Pod éœ€è¦å»è®¿é—® Kubernetes é›†ç¾¤ä¸­çš„æŸäº›èµ„æºï¼Œæ¯”å¦‚ Pod çš„ CRUD æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬æœ‰ CRUD Pod çš„æƒé™ï¼Œè€Œæˆ‘ä»¬å½“å‰çš„ Pod å°±æ˜¯é€šè¿‡ ServiceAccount å¯¹åº”çš„ token æ–‡ä»¶å’Œ è‡ªåŠ¨æ³¨å…¥åˆ° Pod ä¸­çš„ ca.crt æ–‡ä»¶å»è¿æ¥çš„ APIServerï¼Œè€Œè¿™ä¸ª token åˆæ˜¯ç»‘å®šäº†ç›¸å…³æƒé™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Pod ä¸­å»è®¿é—® APIServer çš„æ—¶å€™å°±çŸ¥é“å½“å‰çš„æ“ä½œæ˜¯å¦æœ‰å¯¹åº”çš„æƒé™äº†ã€‚å¦‚æœé›†ç¾¤ä½¿ç”¨ TLS è®¤è¯æ–¹å¼ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥åœ¨ client-go å½“ä¸­é€šè¿‡ InCluster çš„æ–¹å¼è‡ªåŠ¨å»è¯»å–é›†ç¾¤å†…éƒ¨çš„ tokenFile å’Œ CAFileï¼š
```golang
// tokenFile = "/var/run/secrets/kubernetes.io/serviceaccount/token"
// rootCAFile = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
config, _ := rest.InClusterConfig()

// æ ¹æ®æŒ‡å®šçš„ config åˆ›å»ºä¸€ä¸ªæ–°çš„ clientset
clientset, _ := kubernetes.NewForConfig(config)
// ç„¶åé€šè¿‡ clientset å»æ“ä½œé›†ç¾¤èµ„æº
......
```

å¦‚æœæˆ‘ä»¬æ²¡æœ‰ç»™ Pod æŒ‡å®šä¸€ä¸ª ServiceAccount çš„è¯ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„åä¸º default çš„è¿™ä¸ª ServiceAccountï¼Œå½“ç„¶ä»–ä¹Ÿæœ‰ä¸€ä¸ª token ä¼šè¢«è‡ªåŠ¨æ³¨å…¥åˆ° Pod ä¸­ï¼Œä½†æ˜¯å°±ä¸ä¸€å®šæœ‰æˆ‘ä»¬æƒ³è¦çš„è®¿é—®é›†ç¾¤èµ„æºçš„æƒé™äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª ServiceAccount ç»‘å®šåˆ° Pod ä¸Šé¢å»ã€‚

## 4.Docerkfile ä¸­æ·»åŠ äº¤äº’å¼å‘½ä»¤
ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼Œéœ€è¦åœ¨ Dockerfile é‡Œé¢æ·»åŠ äº¤äº’å¼çš„å‘½ä»¤ï¼Œç±»ä¼¼äºæˆ‘ä»¬å¹³æ—¶å®‰è£…è½¯ä»¶çš„æ—¶å€™è¾“å…¥ yesï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `yum install -y` æ¥é»˜è®¤å®‰è£…ï¼Œé¿å…ç”¨æˆ·è¾“å…¥ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æ²¡åŠæ³•é¿å…çš„æ—¶å€™ï¼Œä¸€å®šéœ€è¦è¾“å…¥äº¤äº’å‘½ä»¤çš„æ—¶å€™åº”è¯¥å’‹åŠå‘¢ï¼Ÿèƒ½æƒ³åˆ°çš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åŠæ³•æ˜¯æš‚æ—¶åœ¨ Dockerfile ä¸­ä¸æ·»åŠ è¿™æ¡äº¤äº’å¼å‘½ä»¤ï¼Œå…ˆåˆ¶ä½œä¸€ä¸ªé•œåƒï¼Œç„¶åä½¿ç”¨è¿™ä¸ªé•œåƒè¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œç„¶ååˆ°å®¹å™¨ä¸­å»è¿è¡Œè¿™ä¸ªäº¤äº’å¼å‘½ä»¤ï¼Œç„¶åé…ç½®å®Œå commit ä¸‹è¿™ä¸ªå®¹å™¨æˆä¸€ä¸ªæ–°çš„é•œåƒå³å¯ã€‚

ä½†æ˜¯ä¸Šé¢è¿™ç§æ–¹å¼ä¸å…·æœ‰é€šç”¨æ€§ï¼Œåœ¨ docker å®˜æ–¹è®ºå›ä¸­æœ‰å…³äºè¿™ä¸ªé—®é¢˜çš„è§£ç­”ï¼š[https://forums.docker.com/t/dockerfile-how-to-answer-install-question-from-application/5240/2](https://forums.docker.com/t/dockerfile-how-to-answer-install-question-from-application/5240/2) é€šè¿‡å®‰è£… expect å·¥å…·æ¥å®ç°äº¤äº’åŠŸèƒ½ï¼š
```Dockerfile
RUN apt-get install expect
ADD install_script
RUN install_script
```

å®‰è£…è„šæœ¬å¦‚ä¸‹ï¼š
```
#!/usr/bin/expect
set timeout 2
spawn "./your_script"
expect â€œQuestion 1 :â€ { send â€œyes\nâ€ }
expect â€œQuestion 2 :â€ { send â€œno\nâ€ }
interact
```

## 5.kubeadm å‡çº§é›†ç¾¤é…ç½®
æ˜¨å¤©å‡çº§äº†ä¸‹é›†ç¾¤åˆ° v1.14.5 ç‰ˆæœ¬ï¼Œå‡çº§è¿‡ç¨‹å¾ˆé¡ºç•…ï¼Œä½†æ˜¯ä»Šå¤©å‘ç° apiserver ä¸­å‡ºç°å¤§é‡çš„ tls bad çš„é”™è¯¯æ—¥å¿—ï¼Œè€Œä¸”å†…éƒ¨æœåŠ¡è§£æéƒ½å¤±è´¥ï¼Œç¬¬ä¸€ååº”è¯´ dns çš„é—®é¢˜ï¼Œä½†æ˜¯ CoreDNS ä¹Ÿæ²¡ä»»ä½•é”™è¯¯æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå†çœ‹ kube-proxy æ—¥å¿—ï¼Œæ‰å‘ç°å‡ºç°äº†å¤§é‡çš„è¿æ¥ apiserver å¤±è´¥çš„é”™è¯¯ï¼Œä»”ç»†ä¸€çœ‹è¿æ¥çš„å±…ç„¶è¿˜æ˜¯ apiserver èŠ‚ç‚¹çš„å¤–ç½‘ IPï¼Œè¿™å°±å¥‡æ€ªäº†ï¼Œä¹‹å‰å‡çº§éƒ½æ˜¯æ­£å¸¸çš„ï¼Œè¿™æ¬¡å±…ç„¶è¯»å–åˆ°äº†å¤–ç½‘ IPï¼Œå¯¹åº”å¤šç½‘å¡çš„èŠ‚ç‚¹ï¼Œåœ¨ä½¿ç”¨ kubeadm å®‰è£…æˆ–è€…å‡çº§çš„ä½¿ç”¨è¦æ³¨æ„æŒ‡å®šä¸‹ä½¿ç”¨çš„ apiserver åœ°å€ï¼Œå¦åˆ™å¯èƒ½å°±ä¼šè¯»å–åˆ°å¤–ç½‘ IPäº†ï¼Œä¸‹é¢è¯´åˆ›å»ºæˆ–å‡çº§ kubernetes çš„ kubeadm é…ç½®æ–‡ä»¶ï¼š
```yaml
apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
networking:
  dnsDomain: cluster.local
  podSubnet: 10.244.0.0/16
  serviceSubnet: 10.96.0.0/12
kubernetesVersion: v1.15.2
imageRepository: gcr.azk8s.cn/google_containers

---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: "ipvs"

---
apiVersion: kubeadm.k8s.io/v1beta1
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 10.151.30.11
  bindPort: 6443
```

ä¸»è¦ä¿®æ”¹çš„å‚æ•°å°±æ˜¯ InitConfiguration ä¸­çš„ advertiseAddress åœ°å€ä¸ºå†…ç½‘ç½‘å¡çš„ IP åœ°å€ï¼Œç„¶åä½¿ç”¨ kubeadm å‘½ä»¤å®‰è£…æˆ–æ›´æ–°å³å¯ã€‚

å¯¹äº kubeadm åˆå§‹åŒ–é›†ç¾¤çš„é…ç½®å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å–ï¼š
```
$ kubeadm config print init-defaults
```

ä½†æ˜¯è¦æƒ³å®Œæ•´äº†è§£ä¸Šé¢çš„èµ„æºå¯¹è±¡å¯¹åº”çš„å±æ€§ï¼Œå¯ä»¥æŸ¥çœ‹å¯¹åº”çš„ godoc æ–‡æ¡£ï¼Œåœ°å€: [https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2](https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2)ã€‚

## 6.Pod æ—¶åŒºåŒæ­¥
å¾€å¾€éƒ½ä¼šé‡åˆ°ä¿®æ”¹ Pod æ—¶åŒºçš„éœ€æ±‚ï¼Œæ›´å¤šçš„éœ€æ±‚æ˜¯è¦æ±‚æ‰€æœ‰çš„ Pod éƒ½åœ¨åŒä¸€ä¸ªæ—¶åŒºï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰€åœ¨çš„ä¸œ8åŒºï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ–è€…æŒ‚è½½ä¸»æœºçš„æ—¶åŒºæ–‡ä»¶åˆ° Pod ä¸­æ¥å®ç°åŒæ­¥ï¼Œä½†æ˜¯è¿™æ ·éœ€è¦æˆ‘ä»¬å¯¹æ¯ä¸€ä¸ª Pod æ‰‹åŠ¨åšè¿™æ ·çš„æ“ä½œï¼Œä¸€ä¸ªæ›´å¥½çš„æ–¹å¼å°±æ˜¯åˆ©ç”¨ PodPreset æ¥é¢„è®¾ã€‚

é¦–å…ˆå¯ç”¨ PodPresetï¼šåœ¨ kube-apiserver å¯åŠ¨å‚æ•° -runtime-config å¢åŠ  `settings.k8s.io/v1alpha1=true`;

ç„¶ååœ¨ --admission-control å¢åŠ  PodPreset å¯ç”¨ã€‚æœ€åé‡å¯ kube-apiserver å³è¡¨ç¤ºå¯ç”¨æˆåŠŸã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å¯ç”¨æˆåŠŸï¼š
```shell
$ kubectl get podpresets
```

ç„¶ååˆ›å»ºä¸€ä¸ª PodPresents èµ„æºå¯¹è±¡ï¼š
```yaml
apiVersion: settings.k8s.io/v1alpha1
kind: PodPreset
metadata:
  name: tz-env
spec:
  selector:
    matchLabels:
  env:
  - name: TZ
    values: Asia/Shanghai
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œä¸€å®šéœ€è¦å†™ `selector...matchLabels`ï¼Œä½†æ˜¯ matchLabels ä¸ºç©ºï¼Œè¡¨ç¤ºåº”ç”¨äºæ‰€æœ‰å®¹å™¨ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œåˆ›å»ºä¸Šé¢è¿™ä¸ªèµ„æºå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å»åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ Pod å¯ä»¥æŸ¥çœ‹ä¸‹æ˜¯å¦æ³¨å…¥äº†ä¸Šé¢çš„ TZ è¿™ä¸ªç¯å¢ƒå˜é‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPodPreset æ˜¯ namespace çº§åˆ«çš„å¯¹è±¡ï¼Œå…¶ä½œç”¨èŒƒå›´åªèƒ½æ˜¯åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹çš„å®¹å™¨ã€‚

## 7.Prometheus é‡‡é›† Kubelet æŒ‡æ ‡
åœ¨ kubernetes 1.11 ç‰ˆæœ¬ä»¥å kubelet å»æ‰äº† 10255 ç«¯å£ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ prometheus ç›‘æ§ kubelet çš„æ—¶å€™å°±åªéœ€è¦ä½¿ç”¨è‡ªåŠ¨å‘ç°è§’è‰²ä¸º node ç±»å‹çš„å³å¯ï¼Œä½†æ˜¯è¦æ³¨æ„éœ€è¦ä½¿ç”¨ https çš„åè®®ï¼Œè€Œä¸”æœ‰ä¸€ä¸ªç»å¸¸é‡åˆ°çš„é—®é¢˜æ˜¯è®¿é—® metrics æ¥å£çš„æ—¶å€™å‡ºç° 403 é”™è¯¯ã€‚é‡åˆ°è¿™ç§æƒ…å†µéœ€è¦ç¡®ä¿ kubelet å¼€å¯äº†ä¸‹é¢ä¸¤ä¸ªå‚æ•°ï¼š
```
--authentication-token-webhook
--authorization-mode=Webhook
```

æ­¤å¤–åœ¨ç»™ prometheus æŒ‡å®š rbac æƒé™çš„æ—¶å€™éœ€è¦ç»‘å®šä¸‹é¢çš„æƒé™ï¼š
```yaml
- apiGroups:
  - ""
  resources:
  - nodes/metrics
  verbs:
  - get
```

## 8.Lease API
æœ‰åŒå­¦å‘ç°é›†ç¾¤ï¼ˆ1.14ç‰ˆæœ¬+ï¼‰ä¸­å¤šäº†ä¸€ä¸ªåä¸º kube-node-lease çš„å‘½åç©ºé—´ï¼Œä¸çŸ¥é“è¿™ä¸ªæ˜¯å¹²å˜›ä½¿ç”¨çš„ï¼Œä¸çŸ¥é“èƒ½ä¸èƒ½åˆ é™¤å‘¢ï¼Ÿ
```shell
$ kubectl get ns
NAME                  STATUS   AGE
default               Active   10d
kube-node-lease       Active   10d
kube-public           Active   10d
kube-system           Active   10d
```

å®é™…ä¸Š kube-node-lease å‘½åç©ºé—´é‡Œé¢åŒ…å« kubelet ç”¨æ¥ç¡®å®šèŠ‚ç‚¹è¿è¡ŒçŠ¶å†µçš„ç§Ÿçº¦å¯¹è±¡ï¼Œkubelet ä¼šåˆ›å»ºå¹¶å®šæœŸæ›´æ–°èŠ‚ç‚¹ä¸Šçš„ç§Ÿçº¦ï¼Œkubelet ä½¿ç”¨æ–°çš„ Lease API æŠ¥å‘ŠèŠ‚ç‚¹å¿ƒè·³ï¼ŒèŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨ä½¿ç”¨è¿™äº›å¿ƒè·³ä½œä¸ºèŠ‚ç‚¹å¥åº·ä¿¡å·ã€‚

## 9.Prometheus æŠ¥è­¦è§„åˆ™
åœ¨ç¾¤é‡Œé¢çœ‹åˆ°ç¾¤å‹åˆ†äº«çš„ä¸€ä¸ªæ”¶é›† Prometheus å„ç§æŠ¥è­¦è§„åˆ™çš„é¡¹ç›®ï¼Œéƒ½æ˜¯æ¯”è¾ƒé€šç”¨çš„æŠ¥è­¦è§„åˆ™é…ç½®ã€‚ğŸ¤˜ ğŸ¤˜ ğŸ¤˜

åœ°å€ï¼š[https://github.com/samber/awesome-prometheus-alerts](https://github.com/samber/awesome-prometheus-alerts)


## 10.å¯åŠ¨æ¢é’ˆ
åœ¨ Kubernetes 1.16 ç‰ˆæœ¬ä¸­ä¸ºç¼“æ…¢å¯åŠ¨çš„ Pod æ·»åŠ äº†ä¸€ä¸ª startupProbe çš„å¯åŠ¨æ¢é’ˆæ¥å»¶è¿Ÿå…¶ä»–æ¢é’ˆæ£€æµ‹ã€‚æˆ‘ä»¬çŸ¥é“æ¢é’ˆå¯ä»¥è®© Kubernetes ç›‘è§†æ‚¨çš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚æ‚¨å¯ä»¥ä½¿ç”¨livenessProbe å®šæœŸæ£€æŸ¥åº”ç”¨ç¨‹åºæ˜¯å¦ä»åœ¨è¿è¡Œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹å®¹å™¨å®šä¹‰äº†æ­¤æ¢é’ˆï¼š
```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: liveness-port
  failureThreshold: 3
  periodSeconds: 10
```

å¦‚æœåœ¨30ç§’å†…å¤±è´¥3æ¬¡ï¼Œåˆ™å®¹å™¨å°†é‡æ–°å¯åŠ¨ã€‚ä½†æ˜¯ç”±äºè¯¥å®¹å™¨å¾ˆæ…¢å¹¶ä¸”éœ€è¦30ç§’é’Ÿä»¥ä¸Šæ‰èƒ½å¯åŠ¨ï¼Œé‚£ä¹ˆè¯¥æ¢é’ˆè‚¯å®šå°±ä¼šå¤±è´¥ï¼Œå¹¶ä¸”å®¹å™¨å°†å†æ¬¡é‡æ–°å¯åŠ¨ï¼Œè¿™æ ·å°±é™·å…¥ä¸€ä¸ªæ­»å¾ªç¯å½“ä¸­äº†ï¼Œä¹‹å‰æˆ‘ä»¬å¤§éƒ¨åˆ†æƒ…å†µæ˜¯é…ç½®çš„ä¸€ä¸ª initialDelaySeconds çš„å‚æ•°æ¥å»¶è¿Ÿç¬¬ä¸€æ¬¡æ£€æµ‹çš„æ—¶é—´ï¼Œä½†æ˜¯è¿™ä¸ªå‚æ•°æ¯•ç«Ÿæ˜¯å†™æ­»çš„ï¼Œä¸å¤Ÿå‡†ç¡®ã€‚

startupProbe è¿™é¡¹æ–°åŠŸèƒ½å¯ä»¥ä½¿æ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªå¯åŠ¨æ¢é’ˆï¼Œè¯¥æ¢é’ˆå°†æ¨è¿Ÿæ‰€æœ‰å…¶ä»–æ¢é’ˆï¼Œç›´åˆ° Pod å®Œæˆå¯åŠ¨ä¸ºæ­¢ï¼š
```yaml
startupProbe:
  httpGet:
    path: /healthz
    port: liveness-port
  failureThreshold: 30
  periodSeconds: 10
```

ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ…¢é€Ÿå®¹å™¨æœ€å¤šå¯ä»¥æœ‰5åˆ†é’Ÿï¼ˆ30ä¸ªæ£€æŸ¥* 10ç§’= 300sï¼‰å®Œæˆå¯åŠ¨äº†å¾®ç¬‘ã€‚

æ¬¢è¿å¤§å®¶åŠ å…¥æˆ‘ä»¬çš„çŸ¥è¯†æ˜Ÿçƒï¼š`Kubernetes`ã€‚
![çŸ¥è¯†æ˜Ÿçƒ](/img/xq.png)

<!--adsense-self-->
